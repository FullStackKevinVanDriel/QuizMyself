<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="deployed-sha" content="__COMMIT_SHA__">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    <title>QuizMyself - Quiz Yourself on Anything</title>
    <!-- Plausible Analytics - privacy-friendly, no cookies -->
    <script defer data-domain="fullstackkevinvandriel.github.io" src="https://plausible.io/js/script.js"></script>
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #1a1a2e;
            color: #eaeaea;
            min-height: 100vh;
            line-height: 1.6;
            padding-top: 64px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }

        h1 {
            color: #4fc3f7;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 0.95rem;
        }

        .keyword-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #16213e;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .keyword-selector label {
            color: #888;
            font-size: 0.9rem;
        }
        .keyword-selector select {
            flex: 1;
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        .keyword-selector select:focus {
            outline: none;
            border-color: #4fc3f7;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #16213e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4fc3f7;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            background: #0f3460;
            color: #eaeaea;
            border: none;
            padding: 18px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .btn:hover {
            background: #1a4a7a;
            transform: translateX(5px);
        }

        .btn-primary {
            background: #4fc3f7;
            color: #1a1a2e;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #81d4fa;
        }

        .btn-danger {
            background: #e94560;
        }

        .btn-danger:hover {
            background: #ff6b6b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #2ecc71;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.95rem;
        }

        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-disabled-indicator {
            font-size: 0.75rem;
            color: #888;
            margin-left: 8px;
        }

        .quiz-card {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .category-badge {
            display: inline-block;
            background: #0f3460;
            color: #4fc3f7;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.7;
        }

        .question-context {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #aab;
            max-height: none;
            overflow-y: visible;
            cursor: pointer;
            position: relative;
        }
        .question-context.collapsed {
            max-height: 80px;
            overflow: hidden;
        }
        .question-context.collapsed::after {
            content: '‚ñº tap to expand';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            background: linear-gradient(transparent, rgba(20, 25, 45, 0.95) 60%);
            padding: 12px 0 4px;
            font-size: 0.75rem;
            color: #667;
        }
        .question-context:not(.collapsed)::before {
            content: '‚ñ≤ tap to collapse';
            display: block;
            text-align: center;
            font-size: 0.75rem;
            color: #667;
            margin-bottom: 8px;
        }
        .question-context .context-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6a9fd8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .question-context code, .question-context pre {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #7ec;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .question-context pre {
            padding: 10px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            display: block;
            margin: 8px 0;
            font-size: 0.7rem;
            line-height: 1.5;
        }


        .acronym-link {
            color: #6ab0f3;
            text-decoration: underline dotted;
            text-underline-offset: 3px;
            cursor: pointer;
        }
        .acronym-popup {
            position: absolute;
            z-index: 9999;
            background: #1e2a4a;
            border: 1px solid #3a5080;
            border-radius: 10px;
            padding: 12px 16px;
            max-width: 320px;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #dde;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .acronym-popup strong {
            color: #6ab0f3;
            font-size: 0.95rem;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .choice-btn {
            background: #0f3460;
            color: #eaeaea;
            border: 2px solid transparent;
            padding: 15px 20px;
            font-size: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .choice-btn:hover {
            border-color: #4fc3f7;
        }

        .choice-btn.correct {
            background: #27ae60;
            border-color: #2ecc71;
        }

        .choice-btn.incorrect {
            background: #e94560;
            border-color: #ff6b6b;
        }

        .choice-btn.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-group .btn {
            flex: 1;
            text-align: center;
            min-width: 120px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 10px;
        }

        .checkbox-container input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-container label {
            cursor: pointer;
            color: #888;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0f3460;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #27ae60);
            transition: width 0.3s;
        }

        .hidden {
            display: none !important;
        }

        /* Category Filter */
        .category-filter {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .category-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .category-filter-title {
            color: #4fc3f7;
            font-size: 0.95rem;
            font-weight: bold;
        }

        .category-filter-actions {
            display: flex;
            gap: 10px;
        }

        .category-filter-actions button {
            background: none;
            border: none;
            color: #888;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 2px 6px;
        }

        .category-filter-actions button:hover {
            color: #4fc3f7;
        }

        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-chip {
            background: #0f3460;
            color: #888;
            border: 2px solid #333;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-chip:hover {
            border-color: #4fc3f7;
            color: #eaeaea;
        }

        .category-chip.active {
            background: #1a4a7a;
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        /* Course Content Items */
        .course-item {
            background: #0f3460;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .course-item-category {
            display: inline-block;
            background: #16213e;
            color: #4fc3f7;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        .course-item-question {
            color: #eaeaea;
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .course-item-answer {
            color: #aaa;
            font-size: 0.9rem;
            line-height: 1.6;
            padding-left: 10px;
            border-left: 3px solid #4fc3f7;
        }

        .result-card {
            text-align: center;
            padding: 40px;
        }

        .result-score {
            font-size: 4rem;
            font-weight: bold;
            color: #4fc3f7;
            margin: 20px 0;
        }

        .result-message {
            font-size: 1.3rem;
            margin-bottom: 30px;
        }

        .pass {
            color: #27ae60;
        }

        .fail {
            color: #e94560;
        }

        .streak-indicator {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .question-counter {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            color: #4fc3f7;
            text-decoration: none;
            padding: 10px 18px;
            background: #1a1a2e;
            border: 2px solid #4fc3f7;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .back-link:hover {
            background: #4fc3f7;
            color: #1a1a2e;
            text-decoration: none;
        }

        .deploy-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f39c12;
            color: #1a1a2e;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
        }

        .deploy-banner.hidden {
            display: none;
        }

        body.has-banner {
            padding-top: 40px;
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 54px;
            background: #0d1117;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            z-index: 1000;
            box-sizing: border-box;
        }

        .top-bar-status {
            display: flex;
            align-items: center;
            height: 44px;
            padding: 0 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .top-bar-status.pro {
            background: linear-gradient(135deg, #1a472a, #2d5a3d);
            border: 2px solid #ffd700;
            color: #ffd700;
        }

        .top-bar-status.free {
            background: #1a1a2e;
            border: 2px solid #666;
            color: #888;
        }

        .top-bar-status .pro-badge {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* Hamburger Menu */
        .hamburger-menu {
            position: relative;
        }

        .hamburger-btn {
            background: #1a1a2e;
            border: 2px solid #4fc3f7;
            color: #4fc3f7;
            font-size: 24px;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            background: #4fc3f7;
            color: #1a1a2e;
        }

        .hamburger-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #1a1a2e;
            border: 2px solid #4fc3f7;
            border-radius: 8px;
            min-width: 220px;
            padding: 10px 0;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .hamburger-dropdown.show {
            display: block;
        }

        .hamburger-dropdown .menu-item {
            padding: 12px 20px;
            color: #ccc;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hamburger-dropdown .menu-item:hover {
            background: rgba(79, 195, 247, 0.1);
        }

        .hamburger-dropdown .menu-divider {
            border-top: 1px solid #333;
            margin: 8px 0;
        }

        .hamburger-dropdown .menu-label {
            padding: 8px 20px;
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hamburger-dropdown .menu-value {
            padding: 4px 20px 12px;
            color: #4fc3f7;
            font-size: 14px;
            font-weight: bold;
        }

        .hamburger-dropdown .pro-indicator {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .menu-upgrade-btn {
            display: block;
            width: calc(100% - 30px);
            margin: 8px 15px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu-upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .menu-signin-form {
            display: flex;
            gap: 8px;
            padding: 8px 15px;
        }

        .menu-signin-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #4fc3f7;
            border-radius: 6px;
            background: #0d1117;
            color: white;
            font-size: 14px;
            min-width: 0;
        }

        .menu-signin-form input::placeholder {
            color: #666;
        }

        .menu-signin-btn {
            padding: 8px 16px;
            background: #4fc3f7;
            color: #1a1a2e;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .menu-signin-btn:hover {
            background: #81d4fa;
        }

        .menu-hint {
            padding: 4px 15px 12px;
            color: #666;
            font-size: 11px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.4rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.modal-top {
            z-index: 1500;
        }

        .modal-content {
            background: #16213e;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #333;
        }

        .modal-header h2 {
            color: #4fc3f7;
            font-size: 1.3rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #e94560;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body h3 {
            color: #4fc3f7;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body p, .modal-body li {
            color: #ccc;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .modal-body ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .modal-body .key-term {
            color: #81d4fa;
            font-weight: bold;
        }

        /* AI Chat Modal Styles */
        .ai-chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .ai-chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.5;
        }

        .ai-chat-message.user {
            background: #0f3460;
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .ai-chat-message.assistant {
            background: #2a2a4a;
            color: #ccc;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .ai-chat-message.system {
            background: #1a3a1a;
            color: #4caf50;
            text-align: center;
            max-width: 100%;
            font-size: 0.9rem;
        }

        .ai-chat-message.error {
            background: #3a1a1a;
            color: #ff6b6b;
            text-align: center;
            max-width: 100%;
        }

        .ai-chat-input-row {
            display: flex;
            gap: 10px;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 14px;
        }

        .ai-chat-input:focus {
            outline: none;
            border-color: #4fc3f7;
        }

        .ai-chat-send {
            padding: 12px 20px;
            background: #4fc3f7;
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .ai-chat-send:hover {
            background: #81d4fa;
        }

        .ai-chat-send:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* Usage Counter Badge */
        .usage-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #888;
        }

        .usage-badge.warning {
            border-color: #ffa000;
            color: #ffa000;
        }

        .usage-badge.exhausted {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        /* View in Source Button */
        .view-source-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #0f3460;
            color: #4fc3f7;
            border: 1px solid #4fc3f7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: none;
        }

        .view-source-btn:hover {
            background: #1a4a7a;
        }

        .view-source-btn.visible {
            display: inline-block;
        }

        /* Question Preview Card */
        .question-preview-card {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .question-preview-card .question-text {
            color: #fff;
            margin-bottom: 8px;
        }

        .question-preview-card .choices-preview {
            font-size: 0.85rem;
            color: #888;
        }

        .question-preview-card .correct-choice {
            color: #4caf50;
        }

        /* Generate Button */
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-generate:hover {
            opacity: 0.9;
        }

        .btn-generate:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* Coverage Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 16px;
            background: #1a1a2e;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn:first-child {
            border-right: 1px solid #333;
        }

        .mode-btn:hover {
            background: #0f3460;
            color: #ccc;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .mode-btn .pro-badge {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Coverage Options Panel */
        .coverage-options {
            background: #0d1117;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .coverage-estimate {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .estimate-item {
            text-align: center;
        }

        .estimate-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4fc3f7;
        }

        .estimate-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        /* Coverage Progress UI */
        .coverage-progress {
            text-align: left;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            color: #4fc3f7;
            font-size: 1rem;
            font-weight: bold;
        }

        .progress-stats {
            color: #888;
            font-size: 0.85rem;
        }

        .progress-bar-container {
            background: #1a1a2e;
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 8px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            min-width: 40px;
        }

        .progress-bar-text {
            color: #fff;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .section-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .section-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .section-item.completed {
            border-left: 3px solid #4caf50;
        }

        .section-item.active {
            border-left: 3px solid #4fc3f7;
            background: #0f3460;
        }

        .section-item.pending {
            border-left: 3px solid #555;
            opacity: 0.7;
        }

        .section-item.failed {
            border-left: 3px solid #ff6b6b;
        }

        .section-status {
            font-size: 1rem;
        }

        .section-name {
            flex: 1;
            font-size: 0.85rem;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .section-questions {
            font-size: 0.75rem;
            color: #888;
        }

        .coverage-actions {
            display: flex;
            gap: 10px;
        }

        .btn-pause {
            background: #f39c12;
            color: #1a1a2e;
        }

        .btn-pause:hover {
            background: #e67e22;
        }

        .btn-cancel-coverage {
            background: #555;
        }

        .btn-cancel-coverage:hover {
            background: #666;
        }

        /* Rate limit warning */
        .rate-limit-warning {
            background: #1a1a2e;
            border: 1px solid #f39c12;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .rate-limit-warning .warning-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .rate-limit-warning .warning-message {
            color: #f39c12;
            margin-bottom: 10px;
        }

        .rate-limit-warning .resume-time {
            color: #888;
            font-size: 0.85rem;
        }

        /* Import Drop Zone */
        .drop-zone {
            border: 2px dashed #4fc3f7;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            background: rgba(79, 195, 247, 0.1);
            border-color: #81d4fa;
        }

        .drop-zone-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .drop-zone-text {
            color: #888;
            margin-bottom: 5px;
        }

        .drop-zone-subtext {
            color: #666;
            font-size: 0.85rem;
        }

        .import-textarea {
            width: 100%;
            min-height: 150px;
            background: #0f3460;
            border: 1px solid #333;
            border-radius: 8px;
            color: #eaeaea;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .import-textarea:focus {
            outline: none;
            border-color: #4fc3f7;
        }

        .import-preview {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .import-preview-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .import-preview-item:last-child {
            border-bottom: none;
        }

        .import-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: #888;
        }

        .import-stats span {
            color: #4fc3f7;
            font-weight: bold;
        }

        .format-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .format-tab {
            padding: 8px 16px;
            background: #0f3460;
            border: none;
            border-radius: 5px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }

        .format-tab:hover {
            color: #eaeaea;
        }

        .format-tab.active {
            background: #4fc3f7;
            color: #1a1a2e;
        }

        /* Pro Badge & Upgrade */
        .pro-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .upgrade-banner {
            background: linear-gradient(135deg, #1a1a2e, #2a2a4e);
            border: 2px dashed #666;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .upgrade-banner h3 {
            color: #aaa;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .upgrade-banner p {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        .pro-member-banner {
            background: linear-gradient(135deg, #1a472a, #2d5a3d);
            border: 3px solid #ffd700;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .pro-member-banner h3 {
            color: #ffd700;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .pro-member-banner p {
            color: #90EE90;
            font-size: 0.95rem;
        }

        .btn-upgrade {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            font-weight: bold;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-upgrade:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .pricing-card {
            background: #0f3460;
            border-radius: 12px;
            padding: 25px;
            margin: 10px 0;
            text-align: center;
        }

        .pricing-card.featured {
            border: 2px solid #ffd700;
            position: relative;
        }

        .pricing-card.featured::before {
            content: 'BEST VALUE';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #1a1a2e;
            padding: 3px 12px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .pricing-price {
            font-size: 2rem;
            color: #4fc3f7;
            font-weight: bold;
        }

        .pricing-price span {
            font-size: 1rem;
            color: #888;
        }

        .pricing-features {
            text-align: left;
            margin: 15px 0;
            color: #aaa;
        }

        .pricing-features li {
            padding: 5px 0;
            list-style: none;
        }

        .pricing-features li::before {
            content: '‚úì ';
            color: #27ae60;
        }

        .free-limit-warning {
            background: #2d1f1f;
            border: 1px solid #e94560;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            color: #e94560;
            font-size: 0.9rem;
        }

        .help-btn {
            background: none;
            border: 2px solid #4fc3f7;
            color: #4fc3f7;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            background: #4fc3f7;
            color: #1a1a2e;
        }

        .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-header .category-badge {
            margin-bottom: 0;
        }

        /* Mastered Questions List */
        .mastered-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .mastered-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 15px;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 10px;
            gap: 15px;
        }

        .mastered-item-text {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .mastered-item-category {
            color: #4fc3f7;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }

        .unmaster-btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .unmaster-btn:hover {
            background: #ff6b6b;
        }

        .empty-list-message {
            text-align: center;
            color: #888;
            padding: 30px;
        }
        /* Auth tabs */
        .auth-tabs {
            display: flex;
            margin-bottom: 15px;
        }

        .auth-tab {
            flex: 1;
            padding: 8px;
            background: #0f3460;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 12px;
        }

        .auth-tab.active {
            background: #1a4a7a;
            color: #4fc3f7;
        }

        .auth-tab:first-child {
            border-radius: 5px 0 0 5px;
        }

        .auth-tab:last-child {
            border-radius: 0 5px 5px 0;
        }

        .auth-form input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #0f3460;
            border: 1px solid #333;
            border-radius: 5px;
            color: #eaeaea;
            font-size: 14px;
            box-sizing: border-box;
        }

        .auth-error {
            color: #e94560;
            font-size: 0.85rem;
            margin-top: 10px;
            padding: 8px;
            background: rgba(233, 69, 96, 0.1);
            border-radius: 5px;
        }

        .menu-link-btn {
            background: none;
            border: none;
            color: #4fc3f7;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 5px 20px;
            text-decoration: underline;
        }

        .keyword-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .keyword-item-info {
            flex: 1;
        }

        .keyword-item-name {
            font-weight: bold;
        }

        .keyword-item-name.active {
            color: #4fc3f7;
        }

        .keyword-item-date {
            font-size: 0.8rem;
            color: #888;
        }

        .keyword-item-actions {
            display: flex;
            gap: 8px;
        }

        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .welcome-content {
            max-width: 500px;
            text-align: center;
        }

        .welcome-logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .welcome-title {
            font-size: 2.5rem;
            color: #4fc3f7;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .welcome-tagline {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 30px;
        }

        .welcome-features {
            text-align: left;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 30px;
        }

        .welcome-feature {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
        }

        .welcome-feature:last-child {
            margin-bottom: 0;
        }

        .welcome-feature-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .welcome-feature-text {
            color: #eaeaea;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .welcome-category-section {
            margin-bottom: 25px;
        }

        .welcome-category-title {
            color: #4fc3f7;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .welcome-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .welcome-category-chip {
            background: #0f3460;
            color: #888;
            border: 2px solid #333;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .welcome-category-chip:hover {
            border-color: #4fc3f7;
            color: #eaeaea;
        }

        .welcome-category-chip.selected {
            background: #1a4a7a;
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .welcome-btn {
            padding: 16px 32px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .welcome-btn-primary {
            background: #4fc3f7;
            color: #1a1a2e;
        }

        .welcome-btn-primary:hover {
            background: #81d4fa;
            transform: translateY(-2px);
        }

        .welcome-btn-secondary {
            background: transparent;
            color: #888;
            border: 1px solid #333;
        }

        .welcome-btn-secondary:hover {
            color: #eaeaea;
            border-color: #4fc3f7;
        }

        .welcome-footer {
            margin-top: 20px;
            color: #666;
            font-size: 0.85rem;
        }

        /* Roadmap Modal Styles */
        .roadmap-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
        }

        .roadmap-stats .stat {
            text-align: center;
        }

        .roadmap-stats .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4fc3f7;
        }

        .roadmap-stats .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }

        .roadmap-stats .stat-btn {
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .roadmap-stats .stat-btn:hover {
            background: rgba(79, 195, 247, 0.1);
            border-color: rgba(79, 195, 247, 0.3);
        }

        .roadmap-stats .stat-btn:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Enhanced focus-visible handled in ACCESSIBILITY section */

        .roadmap-stats .stat-btn.active {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
        }

        .roadmap-stats .stat-btn.active .stat-value {
            color: #fff;
        }

        .roadmap-stats .stat-btn.active .stat-label {
            color: #4fc3f7;
        }

        .roadmap-section {
            margin-bottom: 20px;
        }

        .roadmap-section h3 {
            color: #4fc3f7;
            font-size: 1rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .roadmap-item {
            background: #0f3460;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-left: 3px solid #4fc3f7;
        }

        .roadmap-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 6px;
        }

        .roadmap-item-title {
            color: #eaeaea;
            font-weight: 500;
            font-size: 0.95rem;
            flex: 1;
        }

        .roadmap-item-refs {
            color: #888;
            font-size: 0.85rem;
            font-weight: normal;
            margin-right: 8px;
        }

        .roadmap-item-refs a {
            text-decoration: none;
        }

        .roadmap-item-refs a:hover {
            text-decoration: underline;
        }

        .roadmap-status {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .roadmap-item-meta {
            color: #666;
            font-size: 0.8rem;
        }

        .timestamp-relative {
            cursor: help;
            border-bottom: 1px dotted #666;
        }

        .timestamp-relative:hover {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
        }

        .roadmap-labels {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .roadmap-label {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .roadmap-label.bug {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .roadmap-label.enhancement {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .roadmap-label.question {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
        }

        .roadmap-label.feature {
            background: rgba(156, 39, 176, 0.2);
            color: #ce93d8;
        }

        .roadmap-label.default {
            background: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
        }

        .roadmap-progress {
            margin-top: 10px;
        }

        .roadmap-progress-bar {
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }

        .roadmap-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #81d4fa);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .roadmap-progress-text {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .roadmap-empty {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .roadmap-empty p {
            margin-bottom: 15px;
        }

        .roadmap-loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .roadmap-loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #1a1a2e;
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .roadmap-loading-text {
            color: #888;
            font-size: 0.9rem;
        }

        /* Skeleton Loading */
        .skeleton-container {
            padding: 20px;
        }

        .skeleton-item {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        .skeleton-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .skeleton-title {
            height: 20px;
            width: 60%;
            background: linear-gradient(90deg, #2a2a4e 25%, #3a3a5e 50%, #2a2a4e 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-badge {
            height: 20px;
            width: 60px;
            background: linear-gradient(90deg, #2a2a4e 25%, #3a3a5e 50%, #2a2a4e 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 10px;
        }

        .skeleton-content {
            height: 14px;
            width: 80%;
            background: linear-gradient(90deg, #2a2a4e 25%, #3a3a5e 50%, #2a2a4e 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-progress {
            height: 8px;
            width: 100%;
            background: linear-gradient(90deg, #2a2a4e 25%, #3a3a5e 50%, #2a2a4e 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: 4px;
            margin-top: 12px;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Error State */
        .roadmap-error {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .roadmap-error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .roadmap-error-title {
            color: #ff6b6b;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .roadmap-error-message {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .roadmap-error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Empty State Improvements */
        .roadmap-empty {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .roadmap-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .roadmap-empty-title {
            color: #ccc;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .roadmap-empty-message {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* Progress Modal Vision Section */
        .progress-vision {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            border-left: 4px solid #4fc3f7;
        }

        .progress-vision-title {
            color: #4fc3f7;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .progress-vision-text {
            color: #eaeaea;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .progress-goals {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .progress-goal {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(79, 195, 247, 0.1);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            color: #81d4fa;
        }

        .progress-goal-icon {
            font-size: 0.9rem;
        }

        .progress-last-update {
            font-size: 0.75rem;
            color: #666;
            margin-top: 10px;
            text-align: right;
        }

        /* Progress Timeline */
        .progress-timeline {
            position: relative;
            padding: 15px 0 15px 25px;
            margin-bottom: 20px;
        }

        .progress-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #4fc3f7 0%, #0f3460 100%);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 20px;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -17px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4fc3f7;
            border: 3px solid #1a1a2e;
            z-index: 1;
        }

        .timeline-item.completed::before {
            background: #4caf50;
        }

        .timeline-item.in-progress::before {
            background: #ffa726;
            box-shadow: 0 0 8px rgba(255, 167, 38, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 8px rgba(255, 167, 38, 0.5); }
            50% { box-shadow: 0 0 16px rgba(255, 167, 38, 0.8); }
        }

        .timeline-item.pending::before {
            background: #666;
        }

        .timeline-content {
            background: #0f3460;
            border-radius: 8px;
            padding: 12px 15px;
            border-left: 3px solid #4fc3f7;
        }

        .timeline-item.completed .timeline-content {
            border-left-color: #4caf50;
        }

        .timeline-item.in-progress .timeline-content {
            border-left-color: #ffa726;
        }

        .timeline-item.pending .timeline-content {
            border-left-color: #666;
            opacity: 0.7;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .timeline-title {
            color: #eaeaea;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .timeline-date {
            color: #888;
            font-size: 0.75rem;
        }

        .timeline-description {
            color: #aaa;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Milestone Progress */
        .milestone-card {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        /* Milestones Grid */
        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .milestone-card-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
            font-family: inherit;
            font-size: inherit;
        }

        .milestone-card-clickable:hover {
            transform: translateY(-2px);
            border-color: #4fc3f7;
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.2);
        }

        .milestone-card-clickable.active {
            border-color: #4fc3f7;
            background: linear-gradient(135deg, #1a4a7a 0%, #1a3a5e 100%);
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.3);
        }

        .milestone-card-clickable .milestone-title-icon {
            background: #4fc3f7;
            color: #0a1628;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
        }

        /* Milestone Filter Bar */
        .milestone-filter-bar {
            margin-top: 8px;
        }

        .milestone-chip {
            background: #1a1a2e;
            border-color: #444;
        }

        .milestone-chip:hover {
            border-color: #4fc3f7;
            background: #252540;
        }

        .milestone-chip.active {
            background: #4fc3f7;
            color: #0a1628;
            border-color: #4fc3f7;
        }

        /* Milestone Badge on Items */
        .milestone-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: #0a1628;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 6px;
            vertical-align: middle;
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .milestone-title {
            color: #4fc3f7;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .milestone-title-icon {
            font-size: 1.1rem;
        }

        .milestone-progress-ring {
            width: 50px;
            height: 50px;
            position: relative;
        }

        .milestone-progress-ring svg {
            transform: rotate(-90deg);
        }

        .milestone-progress-ring circle {
            fill: none;
            stroke-width: 5;
        }

        .milestone-progress-ring .bg {
            stroke: #1a1a2e;
        }

        .milestone-progress-ring .progress {
            stroke: #4fc3f7;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .milestone-progress-percent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #eaeaea;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .milestone-description {
            color: #aaa;
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .milestone-stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: #888;
        }

        .milestone-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .milestone-stat-icon {
            font-size: 0.9rem;
        }

        /* SDLC Stage Tracking */
        .sdlc-stages {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
            padding: 8px 0;
        }

        .sdlc-stage {
            flex: 1;
            height: 4px;
            background: #1a1a2e;
            border-radius: 2px;
            position: relative;
        }

        .sdlc-stage.completed {
            background: linear-gradient(90deg, #4caf50, #81c784);
        }

        .sdlc-stage.current {
            background: linear-gradient(90deg, #ffa726, #ffcc80);
            animation: stagePulse 2s infinite;
        }

        @keyframes stagePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .sdlc-stage-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #666;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .sdlc-stage-labels span {
            flex: 1;
            text-align: center;
        }

        .sdlc-stage-labels span.completed {
            color: #4caf50;
        }

        .sdlc-stage-labels span.current {
            color: #ffa726;
            font-weight: 600;
        }

        /* Item Priority Indicator */
        .item-priority {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .item-priority.high {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .item-priority.medium {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .item-priority.low {
            background: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
        }

        /* Unique Type ID Badge */
        .type-id-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
        }

        .type-id-badge.bug {
            background: rgba(233, 69, 96, 0.15);
            color: #e94560;
        }

        .type-id-badge.feature {
            background: rgba(76, 175, 80, 0.15);
            color: #4caf50;
        }

        .type-id-badge.question {
            background: rgba(79, 195, 247, 0.15);
            color: #4fc3f7;
        }

        .type-id-badge.request {
            background: rgba(156, 39, 176, 0.15);
            color: #ce93d8;
        }

        .type-id-badge.feedback {
            background: rgba(158, 158, 158, 0.15);
            color: #9e9e9e;
        }

        /* Enhanced Item Meta Section */
        .item-registration {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.75rem;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .item-registration-entry {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .item-registration-entry a {
            color: #4fc3f7;
            text-decoration: none;
        }

        .item-registration-entry a:hover {
            text-decoration: underline;
        }

        .item-registration-entry .icon {
            opacity: 0.7;
        }

        /* Category Filter Bar */
        .progress-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .progress-filter-bar .filter-label {
            color: #888;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            margin-right: 8px;
        }

        .progress-filter-chip {
            background: #1a1a2e;
            color: #888;
            border: 1px solid #333;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-filter-chip:hover {
            border-color: #4fc3f7;
            color: #eaeaea;
        }

        .progress-filter-chip.active {
            background: rgba(79, 195, 247, 0.15);
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        .progress-filter-chip .count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .progress-filter-chip.active .count {
            background: rgba(79, 195, 247, 0.3);
        }

        /* Category-specific filter chip colors */
        .progress-filter-chip[data-type="bug"].active {
            background: rgba(233, 69, 96, 0.15);
            border-color: #e94560;
            color: #e94560;
        }
        .progress-filter-chip[data-type="feature"].active {
            background: rgba(76, 175, 80, 0.15);
            border-color: #4caf50;
            color: #4caf50;
        }
        .progress-filter-chip[data-type="question"].active {
            background: rgba(79, 195, 247, 0.15);
            border-color: #4fc3f7;
            color: #4fc3f7;
        }
        .progress-filter-chip[data-type="request"].active {
            background: rgba(156, 39, 176, 0.15);
            border-color: #ce93d8;
            color: #ce93d8;
        }

        /* Search and Sort Bar */
        .progress-search-sort-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 12px;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 8px;
            margin-bottom: 15px;
            align-items: center;
        }

        .progress-search-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .progress-search-input {
            width: 100%;
            padding: 8px 36px 8px 12px;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 20px;
            color: #eaeaea;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .progress-search-input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.25);
        }

        .progress-search-input::placeholder {
            color: #666;
        }

        .progress-search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px;
            font-size: 0.9rem;
            line-height: 1;
            border-radius: 50%;
            transition: color 0.2s, background 0.2s;
        }

        .progress-search-clear:hover {
            color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }

        .progress-search-clear:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        .progress-sort-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-sort-label {
            color: #888;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .progress-sort-select {
            padding: 8px 32px 8px 12px;
            background: #1a1a2e url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 10px center;
            border: 1px solid #333;
            border-radius: 20px;
            color: #eaeaea;
            font-size: 0.85rem;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .progress-sort-select:hover {
            border-color: #4fc3f7;
        }

        .progress-sort-select:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.25);
        }

        .progress-no-results {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-size: 0.95rem;
        }

        .progress-no-results-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .progress-result-count {
            color: #888;
            font-size: 0.8rem;
            padding: 8px 12px;
            margin-bottom: 10px;
        }

        .progress-result-count strong {
            color: #4fc3f7;
        }

        .link-btn {
            background: none;
            border: none;
            color: #4fc3f7;
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
            padding: 0;
        }

        .link-btn:hover {
            color: #81d4fa;
        }

        .link-btn:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Expandable Item */
        .roadmap-item.expandable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .roadmap-item.expandable:hover {
            background: #1e3a5f;
        }

        .roadmap-item-expand-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #4fc3f7;
            font-size: 0.75rem;
            margin-top: 8px;
            cursor: pointer;
        }

        .roadmap-item-expand-toggle .arrow {
            transition: transform 0.2s;
            display: inline-block;
        }

        .roadmap-item.expanded .roadmap-item-expand-toggle .arrow {
            transform: rotate(90deg);
        }

        .item-lifecycle {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .roadmap-item.expanded .item-lifecycle {
            display: block;
        }

        .lifecycle-section {
            margin-bottom: 12px;
        }

        .lifecycle-section-title {
            color: #4fc3f7;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .lifecycle-event {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.8rem;
            border-left: 2px solid #333;
            padding-left: 16px;
            margin-left: 8px;
            position: relative;
        }

        /* Timeline dot/node marker */
        .lifecycle-event::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 12px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #1a1a2e;
        }

        .lifecycle-event.birth {
            border-left-color: #4caf50;
        }

        .lifecycle-event.birth::before {
            background: #4caf50;
        }

        .lifecycle-event.update {
            border-left-color: #ff9800;
        }

        .lifecycle-event.update::before {
            background: #ff9800;
        }

        .lifecycle-event.status-change {
            border-left-color: #4fc3f7;
        }

        .lifecycle-event.status-change::before {
            background: #4fc3f7;
        }

        .lifecycle-event.resolved {
            border-left-color: #27ae60;
        }

        .lifecycle-event.resolved::before {
            background: #27ae60;
        }

        /* Collapse button for expanded items */
        .lifecycle-collapse-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #888;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lifecycle-collapse-btn:hover {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .lifecycle-collapse-btn:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        .item-lifecycle {
            position: relative;
        }

        .lifecycle-event-icon {
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        .lifecycle-event-content {
            flex: 1;
        }

        .lifecycle-event-description {
            color: #eaeaea;
        }

        .lifecycle-event-timestamp {
            color: #666;
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* Dependencies */
        .item-dependencies {
            margin-top: 10px;
        }

        .dependency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .dependency-item .dep-icon {
            color: #ff9800;
        }

        .dependency-item .dep-icon.resolved {
            color: #4caf50;
        }

        .dependency-item .dep-label {
            color: #888;
            font-size: 0.7rem;
        }

        .dependency-item .dep-title {
            flex: 1;
            color: #eaeaea;
        }

        .dependency-item .dep-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .dependency-item .dep-status.pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .dependency-item .dep-status.done {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        /* Item Progress Bar (individual item completion) */
        .item-progress-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .item-progress-track {
            flex: 1;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }

        .item-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #4caf50);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .item-progress-text {
            color: #888;
            font-size: 0.7rem;
            min-width: 35px;
            text-align: right;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: #16213e;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 280px;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #4fc3f7;
        }

        .toast.success { border-left-color: #4caf50; }
        .toast.error { border-left-color: #e94560; }
        .toast.warning { border-left-color: #ff9800; }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            color: #eaeaea;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .toast-close:hover { color: #eaeaea; }

        .toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Confirm Modal */
        .confirm-modal-content {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .confirm-modal-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .confirm-modal-title {
            color: #eaeaea;
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-buttons .btn {
            min-width: 100px;
        }

        /* Selection Modal */
        .selection-modal-content {
            background: #16213e;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .selection-modal-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .selection-modal-header h3 {
            color: #4fc3f7;
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .selection-modal-header p {
            color: #888;
            margin: 0;
            font-size: 0.9rem;
        }

        .selection-modal-list {
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
        }

        .selection-modal-item {
            background: #1a1a2e;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selection-modal-item:hover {
            border-color: #4fc3f7;
        }

        .selection-modal-item.selected {
            border-color: #4fc3f7;
            background: #0f3460;
        }

        .selection-modal-item-title {
            color: #eaeaea;
            font-weight: 500;
        }

        .selection-modal-item-subtitle {
            color: #888;
            font-size: 0.85rem;
            margin-top: 3px;
        }

        .selection-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        @media (max-width: 480px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            .toast {
                min-width: auto;
                width: 100%;
            }
        }

        /* Story 5: Integrations & Automation */

        /* Star Button */
        .item-star-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px 8px;
            margin-left: auto;
            transition: transform 0.2s, color 0.2s;
            color: #666;
        }

        .item-star-btn:hover {
            transform: scale(1.2);
            color: #ffc107;
        }

        .item-star-btn.starred {
            color: #ffc107;
        }

        .item-star-btn.starred:hover {
            color: #ff9800;
        }

        .item-star-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .star-count {
            font-size: 0.75rem;
            color: #888;
            margin-left: 2px;
        }

        /* GitHub Integration Badge */
        .github-integration-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            color: #58a6ff;
        }

        .github-integration-badge.synced {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .create-issue-btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .create-issue-btn:hover {
            background: linear-gradient(135deg, #2ea043, #3fb950);
            transform: translateY(-1px);
        }

        .create-issue-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Comments Section */
        .item-comments {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .comments-count {
            color: #888;
            font-size: 0.75rem;
        }

        .comment-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4fc3f7, #0f3460);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: white;
            font-weight: 600;
        }

        .comment-author {
            color: #4fc3f7;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .comment-timestamp {
            color: #666;
            font-size: 0.7rem;
            margin-left: auto;
        }

        .comment-body {
            color: #ccc;
            font-size: 0.8rem;
            line-height: 1.4;
            padding-left: 32px;
        }

        .add-comment-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .add-comment-input {
            flex: 1;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px 12px;
            color: #eaeaea;
            font-size: 0.8rem;
        }

        .add-comment-input:focus {
            outline: none;
            border-color: #4fc3f7;
        }

        .add-comment-btn {
            background: #4fc3f7;
            border: none;
            color: #0a1628;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .add-comment-btn:hover {
            background: #81d4fa;
        }

        .add-comment-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Assignee Section */
        .item-assignees {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .assignee-label {
            color: #888;
            font-size: 0.7rem;
        }

        .assignee-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ce93d8, #0f3460);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: white;
            font-weight: 600;
            border: 2px solid #16213e;
            margin-left: -6px;
        }

        .assignee-avatar:first-of-type {
            margin-left: 0;
        }

        .assignee-avatar.add {
            background: transparent;
            border: 2px dashed #666;
            color: #666;
            cursor: pointer;
        }

        .assignee-avatar.add:hover {
            border-color: #4fc3f7;
            color: #4fc3f7;
        }

        /* Automation Indicator */
        .automation-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            font-size: 0.65rem;
            color: #ffc107;
        }

        .automation-badge.active {
            animation: automationPulse 2s infinite;
        }

        @keyframes automationPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Sign-in prompt for features */
        .feature-signin-prompt {
            color: #888;
            font-size: 0.75rem;
            font-style: italic;
        }

        .feature-signin-prompt a {
            color: #4fc3f7;
            text-decoration: none;
        }

        .feature-signin-prompt a:hover {
            text-decoration: underline;
        }

        /* ========== STORY 6: FLEXIBILITY & ITERATION ========== */

        /* View Mode Toggle */
        .progress-view-toggle {
            display: flex;
            gap: 4px;
            background: #1a1a2e;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .progress-view-btn {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .progress-view-btn:hover {
            color: #eaeaea;
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-view-btn.active {
            background: #4fc3f7;
            color: #0a1628;
            font-weight: 500;
        }

        .progress-view-btn:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Enhanced focus-visible handled in ACCESSIBILITY section */

        /* Themes Section */
        .progress-themes {
            margin-bottom: 20px;
        }

        .theme-card {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 12px;
            border-left: 4px solid #4fc3f7;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .theme-card:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Base focus-within style - enhanced version in ACCESSIBILITY section */
        .theme-card:focus-within {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        .theme-card.theme-performance {
            border-left-color: #e94560;
        }

        .theme-card.theme-ux {
            border-left-color: #4caf50;
        }

        .theme-card.theme-reliability {
            border-left-color: #ff9800;
        }

        .theme-card.theme-growth {
            border-left-color: #9c27b0;
        }

        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .theme-title {
            color: #eaeaea;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-icon {
            font-size: 1rem;
        }

        .theme-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #888;
        }

        .theme-description {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .theme-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-progress-bar {
            flex: 1;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }

        .theme-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #81d4fa);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .theme-progress-text {
            color: #888;
            font-size: 0.7rem;
            min-width: 40px;
        }

        .theme-items {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .theme-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
            color: #ccc;
        }

        .theme-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .theme-item-status.completed {
            background: #4caf50;
        }

        .theme-item-status.in-progress {
            background: #ffa726;
            animation: pulse 2s infinite;
        }

        .theme-item-status.pending {
            background: #666;
        }

        /* Custom Fields Section */
        .custom-fields-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .custom-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-field:last-child {
            border-bottom: none;
        }

        .custom-field-label {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .custom-field-value {
            color: #eaeaea;
            font-size: 0.8rem;
        }

        .custom-field-value.editable {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .custom-field-value.editable:hover {
            background: rgba(79, 195, 247, 0.1);
        }

        .custom-field-value.editable:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Automation Rules */
        .automation-rules-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .automation-rule {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255, 193, 7, 0.05);
            border: 1px solid rgba(255, 193, 7, 0.15);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .automation-rule-icon {
            color: #ffc107;
            font-size: 1rem;
        }

        .automation-rule-text {
            flex: 1;
            color: #ccc;
        }

        .automation-rule-toggle {
            position: relative;
            width: 36px;
            height: 20px;
        }

        .automation-rule-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .automation-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            border-radius: 20px;
            transition: 0.3s;
        }

        .automation-toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background: #666;
            border-radius: 50%;
            transition: 0.3s;
        }

        .automation-rule-toggle input:checked + .automation-toggle-slider {
            background: rgba(76, 175, 80, 0.3);
        }

        .automation-rule-toggle input:checked + .automation-toggle-slider:before {
            transform: translateX(16px);
            background: #4caf50;
        }

        .automation-rule-toggle input:focus + .automation-toggle-slider {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Accessibility: Skip Links */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #4fc3f7;
            color: #0a1628;
            padding: 8px 16px;
            z-index: 3000;
            border-radius: 0 0 4px 0;
            font-weight: 500;
            text-decoration: none;
            transition: top 0.3s;
        }

        .skip-link:focus {
            top: 0;
        }

        /* ========== ACCESSIBILITY: ENHANCED FOCUS INDICATORS ========== */
        /* WCAG 2.4.7 Focus Visible (Level AA) - Highly visible focus indicators */

        /* Base focus style for all interactive elements in modals */
        /* Uses double-ring effect: white inner ring + colored outer ring for maximum visibility */
        .modal button:focus-visible,
        .modal a:focus-visible,
        .modal select:focus-visible,
        .modal input:focus-visible,
        .modal textarea:focus-visible,
        .modal [role="button"]:focus-visible,
        .modal [tabindex="0"]:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Specific focus styles for roadmap/progress modal elements */
        .roadmap-item:focus-visible,
        .timeline-item:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        .progress-filter-chip:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Stats buttons focus */
        .roadmap-stats .stat-btn:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* View toggle buttons focus */
        .progress-view-btn:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Theme card focus */
        .theme-card:focus-visible,
        .theme-card:focus-within {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Milestone card focus */
        .milestone-card:focus-visible,
        .milestone-card-clickable:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Search and sort controls focus */
        .progress-search-input:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 0;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 0 0 5px rgba(79, 195, 247, 0.5);
        }

        .progress-sort-select:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 0;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 0 0 5px rgba(79, 195, 247, 0.5);
        }

        .progress-search-clear:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Link button focus (used in no-results message) */
        .link-btn:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Modal close button focus */
        .modal-close:focus-visible {
            outline: 3px solid #4fc3f7;
            outline-offset: 2px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.3), 0 0 0 7px rgba(79, 195, 247, 0.5);
        }

        /* Legacy :focus styles for older browsers (fallback) */
        .roadmap-item:focus,
        .timeline-item:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        .progress-filter-chip:focus {
            outline: 2px solid #4fc3f7;
            outline-offset: 2px;
        }

        /* Accessibility: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            .timeline-item.in-progress::before,
            .sdlc-stage.current,
            .automation-badge.active,
            .theme-item-status.in-progress {
                animation: none;
            }

            /* Disable spinner animation - show static indicator instead */
            .spinner {
                animation: none;
                border-top-color: #4fc3f7;
                opacity: 0.7;
            }

            /* Disable skeleton loading animations */
            .skeleton-item {
                animation: none;
            }

            .skeleton-title,
            .skeleton-badge,
            .skeleton-content,
            .skeleton-progress {
                animation: none;
                background: #2a2a4e;
            }

            /* Disable toast slide animations - show instantly */
            .toast {
                animation: none;
            }

            .toast.hiding {
                animation: none;
                opacity: 0;
            }

            /* Disable all non-essential transitions */
            .theme-card,
            .roadmap-item,
            .item-progress-fill,
            .theme-progress-fill,
            .progress-view-btn,
            .progress-filter-chip,
            .automation-toggle-slider,
            .automation-toggle-slider:before,
            .skip-link,
            .milestone-progress-circle,
            .toast-close,
            .feature-signin-prompt a,
            button,
            a,
            input,
            select {
                transition: none !important;
            }

            /* Preserve essential visual feedback without animation */
            .progress-bar-fill,
            .item-progress-fill,
            .theme-progress-fill,
            #sources-storage-bar {
                transition: none !important;
            }
        }

        /* Accessibility: High Contrast Mode */
        @media (prefers-contrast: high) {
            .roadmap-item,
            .timeline-content,
            .theme-card,
            .milestone-card {
                border: 2px solid #eaeaea;
            }

            .progress-filter-chip {
                border: 2px solid #888;
            }

            .progress-filter-chip.active {
                border-color: #4fc3f7;
            }
        }

        /* Accessibility: Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus visible styles moved to ENHANCED FOCUS INDICATORS section above */

        /* ========== ACCESSIBILITY: TOUCH TARGET SIZES ========== */
        /* WCAG 2.5.5 (AAA) recommends 44x44px touch targets */
        /* WCAG 2.5.8 (AA) requires 24x24px minimum with adequate spacing */

        /* Ensure minimum touch target for filter chips */
        .progress-filter-chip {
            min-height: 44px;
            min-width: 44px;
            padding: 10px 14px;
        }

        /* Ensure minimum touch target for view toggle buttons */
        .progress-view-btn {
            min-height: 44px;
            padding: 12px 16px;
        }

        /* Ensure minimum touch target for create issue button */
        .create-issue-btn {
            min-height: 44px;
            min-width: 44px;
            padding: 10px 14px;
        }

        /* Ensure minimum touch target for add comment button */
        .add-comment-btn {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 18px;
        }

        /* Ensure minimum touch target for star button */
        .item-star-btn {
            min-height: 44px;
            min-width: 44px;
            padding: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Ensure minimum touch target for mode buttons */
        .mode-btn {
            min-height: 44px;
        }

        /* Ensure minimum touch target for assignee add button */
        .assignee-avatar.add {
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
        }

        /* Ensure adequate touch targets on mobile devices */
        @media (pointer: coarse) {
            /* Filter chips need larger touch targets on touch devices */
            .progress-filter-chip {
                min-height: 48px;
                padding: 12px 16px;
                margin: 4px;
            }

            /* View toggle buttons */
            .progress-view-btn {
                min-height: 48px;
                padding: 14px 18px;
            }

            /* Create issue button */
            .create-issue-btn {
                min-height: 48px;
                padding: 12px 16px;
            }

            /* Add comment button */
            .add-comment-btn {
                min-height: 48px;
                padding: 14px 20px;
            }

            /* Star button */
            .item-star-btn {
                min-height: 48px;
                min-width: 48px;
                padding: 12px;
            }

            /* Mode buttons */
            .mode-btn {
                min-height: 48px;
                padding: 14px 18px;
            }

            /* Roadmap labels when used as interactive elements */
            .roadmap-label {
                min-height: 44px;
                padding: 10px 14px;
                display: inline-flex;
                align-items: center;
            }

            /* Type ID badges when interactive */
            .type-id-badge {
                min-height: 44px;
                padding: 10px 12px;
                display: inline-flex;
                align-items: center;
            }

            /* Assignee add button */
            .assignee-avatar.add {
                min-width: 48px;
                min-height: 48px;
                width: 48px;
                height: 48px;
            }

            /* Ensure adequate spacing between small interactive elements */
            .progress-filters {
                gap: 8px;
            }

            .progress-view-toggle {
                gap: 8px;
                padding: 6px;
            }

            /* GitHub integration badge if clickable */
            .github-integration-badge {
                min-height: 44px;
                padding: 10px 14px;
            }

            /* Automation badge if clickable */
            .automation-badge {
                min-height: 44px;
                padding: 10px 12px;
            }

            /* Item priority indicator if interactive */
            .item-priority {
                min-height: 44px;
                padding: 10px 14px;
            }

            /* Dependency items if clickable */
            .dependency-item {
                min-height: 48px;
                padding: 12px 14px;
            }
        }

        /* Additional spacing for very small screens */
        @media (max-width: 480px) and (pointer: coarse) {
            .progress-filter-chip {
                margin: 6px 4px;
            }

            .progress-filters {
                gap: 10px;
            }

            /* Ensure buttons in modals have adequate touch targets */
            .confirm-modal-buttons .btn,
            .selection-modal-footer .btn {
                min-height: 48px;
                padding: 14px 20px;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- Skip Link for Accessibility (WCAG 2.4.1 Bypass Blocks) -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay modal-top hidden">
        <div class="confirm-modal-content" onclick="event.stopPropagation()">
            <div id="confirm-modal-icon" class="confirm-modal-icon"></div>
            <div id="confirm-modal-title" class="confirm-modal-title"></div>
            <div class="confirm-modal-buttons">
                <button class="btn" id="confirm-modal-cancel">Cancel</button>
                <button class="btn btn-danger" id="confirm-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Selection Modal -->
    <div id="selection-modal" class="modal-overlay modal-top hidden">
        <div class="selection-modal-content" onclick="event.stopPropagation()">
            <div class="selection-modal-header">
                <h3 id="selection-modal-title">Select an Option</h3>
                <p id="selection-modal-subtitle"></p>
            </div>
            <div id="selection-modal-list" class="selection-modal-list"></div>
            <div class="selection-modal-footer">
                <button class="btn" id="selection-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="selection-modal-confirm" disabled>Select</button>
            </div>
        </div>
    </div>

    <div id="deploy-banner" class="deploy-banner hidden">Deploying update...</div>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="welcome-screen hidden">
        <div class="welcome-content">
            <div class="welcome-logo">üìö</div>
            <h1 class="welcome-title">QuizMyself</h1>
            <p class="welcome-tagline">Quiz yourself on anything</p>

            <div class="welcome-features">
                <div class="welcome-feature">
                    <span class="welcome-feature-icon">‚ú®</span>
                    <span class="welcome-feature-text">Import your own study material from files or paste text directly</span>
                </div>
                <div class="welcome-feature">
                    <span class="welcome-feature-icon">üéØ</span>
                    <span class="welcome-feature-text">Track your progress with spaced repetition learning</span>
                </div>
                <div class="welcome-feature">
                    <span class="welcome-feature-icon">‚òÅÔ∏è</span>
                    <span class="welcome-feature-text">Sync across devices with a free account</span>
                </div>
            </div>

            <div class="welcome-category-section">
                <p class="welcome-category-title">Try a demo quiz to get started:</p>
                <div class="welcome-categories" id="welcome-categories">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="welcome-actions">
                <button class="welcome-btn welcome-btn-primary" onclick="startWelcomeQuiz()">Start Quiz</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="dismissWelcome()">Skip intro</button>
            </div>

            <p class="welcome-footer">No account required to try it out</p>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-status free" id="top-bar-status" onclick="toggleHamburgerMenu()">
            <span id="top-bar-status-text">Free Account</span>
        </div>
        <!-- Hamburger Menu -->
        <div class="hamburger-menu" id="hamburger-menu">
            <button class="hamburger-btn" onclick="toggleHamburgerMenu()">‚ò∞</button>
            <div class="hamburger-dropdown" id="hamburger-dropdown">
                <!-- Signed Out State -->
                <div id="menu-signin-section">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                        <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
                    </div>
                    <div id="auth-login-form" class="auth-form">
                        <input type="email" id="login-email" placeholder="Email" onkeypress="if(event.key==='Enter')handleLogin()">
                        <input type="password" id="login-password" placeholder="Password" onkeypress="if(event.key==='Enter')handleLogin()">
                        <button class="menu-signin-btn" onclick="handleLogin()" style="width:100%">Sign In</button>
                        <a href="#" onclick="showForgotPassword(); return false;" style="display:block; text-align:center; margin-top:8px; color:#4fc3f7; font-size:13px;">Forgot password?</a>
                    </div>
                    <div id="auth-forgot-form" class="auth-form" style="display: none;">
                        <p style="color:#888; font-size:13px; margin-bottom:10px;">Enter your email to receive a password reset link.</p>
                        <input type="email" id="forgot-email" placeholder="Email" onkeypress="if(event.key==='Enter')handleForgotPassword()">
                        <button class="menu-signin-btn" onclick="handleForgotPassword()" style="width:100%">Send Reset Link</button>
                        <a href="#" onclick="hideForgotPassword(); return false;" style="display:block; text-align:center; margin-top:8px; color:#4fc3f7; font-size:13px;">Back to login</a>
                    </div>
                    <div id="auth-register-form" class="auth-form" style="display: none;">
                        <input type="email" id="register-email" placeholder="Email">
                        <input type="password" id="register-password" placeholder="Password (6+ chars)">
                        <input type="password" id="register-confirm" placeholder="Confirm Password" onkeypress="if(event.key==='Enter')handleRegister()">
                        <button class="menu-signin-btn" onclick="handleRegister()" style="width:100%">Create Account</button>
                    </div>
                    <div id="auth-error" class="auth-error" style="display: none;"></div>
                    <div class="menu-divider"></div>
                    <div class="menu-hint">Or use quick access (limited features):</div>
                    <div class="menu-signin-form">
                        <input type="text" id="menu-keyword-input" placeholder="Quiz name"
                            onkeypress="if(event.key==='Enter')submitKeywordFromMenu()">
                        <button class="menu-signin-btn" onclick="submitKeywordFromMenu()">Go</button>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item" onclick="showRoadmapModal(); closeHamburgerMenu();">Progress</div>
                    <div class="menu-item" onclick="showFeedbackModal(); closeHamburgerMenu();">Send Feedback</div>
                </div>
                <!-- Signed In State -->
                <div id="menu-account-section" style="display: none;">
                    <div id="menu-email-section">
                        <div class="menu-label">Account</div>
                        <div class="menu-value" id="menu-email">-</div>
                        <div class="menu-divider"></div>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-label">Status</div>
                    <div class="menu-value" id="menu-license-status">Free Account</div>
                    <button id="menu-upgrade-btn" class="menu-upgrade-btn" onclick="showUpgradeModal()">Upgrade to Pro</button>
                    <div class="menu-divider"></div>
                    <div class="menu-item" onclick="showSourcesModal(); closeHamburgerMenu();">Quiz Data</div>
                    <div class="menu-item" onclick="handleSignOut();">Sign Out</div>
                    <div class="menu-divider"></div>
                    <div class="menu-item" onclick="showRoadmapModal(); closeHamburgerMenu();">Progress</div>
                    <div class="menu-item" onclick="showFeedbackModal(); closeHamburgerMenu();">Send Feedback</div>
                </div>
            </div>
        </div>
    </div>

    <main id="main-content" class="container" role="main" tabindex="-1">
        <header>
            <h1>QuizMyself</h1>
            <p class="subtitle">Quiz Yourself on Anything</p>
        </header>

        <!-- Keyword Selector -->
        <div id="keyword-selector" class="keyword-selector" style="display: none;">
            <label for="keyword-dropdown">Quiz:</label>
            <select id="keyword-dropdown" onchange="onKeywordSelect(this.value)">
                <option value="">Select a quiz...</option>
            </select>
            <button class="btn btn-small" onclick="showCreateQuizModal()" title="Create new quiz">+</button>
        </div>

        <div id="stats-bar" class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="right-count">0</div>
                <div class="stat-label">Right</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="wrong-count">0</div>
                <div class="stat-label">Wrong</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="mastered-count">0</div>
                <div class="stat-label">Mastered</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accuracy">0%</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="menu-screen" class="menu">
            <!-- Category Filter for Demo Questions -->
            <div id="category-filter" class="category-filter">
                <div class="category-filter-header">
                    <span class="category-filter-title">Filter by Category</span>
                    <div class="category-filter-actions">
                        <button onclick="selectAllCategories()">All</button>
                        <button onclick="clearAllCategories()">None</button>
                    </div>
                </div>
                <div class="category-chips" id="category-chips">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <button id="practice-quiz-btn" class="btn btn-primary" onclick="startPractice()">Practice Quiz</button>
            <button id="resume-exam-btn" class="btn hidden" onclick="resumeExam()" style="background: #ff9800; color: #1a1a2e; font-weight: bold;">Resume Exam</button>
            <button id="final-exam-btn" class="btn" onclick="startFinalExam()">Final Exam (100% Required)</button>
            <button id="view-progress-btn" class="btn" onclick="showProgress()">View Progress</button>
            <button id="manage-mastered-btn" class="btn" onclick="showMasteredList()">Manage Mastered Questions</button>
            <button id="edit-quiz-btn" class="btn" onclick="showQuizEditor()">‚úèÔ∏è Edit Quiz</button>
            <button id="course-content-btn" class="btn hidden" onclick="showCourseContent()" style="text-align: center;">View Study Material</button>
            <button class="btn btn-danger btn-small" onclick="resetProgress()">Reset All Progress</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <a href="#" class="back-link" onclick="backToMenu(); return false;">&larr; Back to Menu</a>
            <div class="quiz-card">
                <div class="question-counter" id="question-counter"></div>
                <div class="question-header">
                    <span class="category-badge" id="category-badge"></span>
                    <button class="help-btn" onclick="openStudyMaterial()">?</button>
                    <span class="streak-indicator hidden" id="streak-indicator"></span>
                </div>
                <div class="question-context collapsed hidden" id="question-context" onclick="this.classList.toggle('collapsed')"></div>
                <p class="question-text" id="question-text"></p>

                <!-- Multiple Choice -->
                <div id="choice-phase">
                    <div class="choices" id="choices-container"></div>
                    <div id="practice-next-btn" class="btn-group hidden" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="proceedToNextQuestion()">Next Question</button>
                        <button id="view-source-btn" class="view-source-btn" onclick="viewQuestionInSource()">üìñ View in Source</button>
                    </div>
                </div>

                <!-- Skip / I Already Know This Buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="skipQuestion()" style="opacity: 0.7;">Skip ‚è≠</button>
                    <button class="btn btn-small" onclick="markAlwaysKnow()" style="opacity: 0.7;">I already know this</button>
                </div>
            </div>
        </div>

        <!-- Final Exam Screen -->
        <div id="exam-screen" class="hidden">
            <a href="#" class="back-link" onclick="backToMenu(); return false;">&larr; Back to Menu</a>
            <div class="progress-bar">
                <div class="progress-fill" id="exam-progress"></div>
            </div>
            <div class="quiz-card">
                <div class="question-counter" id="exam-counter"></div>
                <div class="question-header">
                    <span class="category-badge" id="exam-category"></span>
                    <button class="help-btn" onclick="openStudyMaterial()">?</button>
                </div>
                <div class="question-context collapsed hidden" id="exam-question-context" onclick="this.classList.toggle('collapsed')"></div>
                <p class="question-text" id="exam-question"></p>
                <div class="choices" id="exam-choices"></div>
                <div id="exam-next-btn" class="btn-group hidden" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="proceedToNextExamQuestion()">Next Question</button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden">
            <div class="quiz-card result-card">
                <h2 id="result-title">Final Exam Results</h2>
                <div class="result-score" id="result-score">0%</div>
                <p class="result-message" id="result-message"></p>
                <div class="btn-group" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="backToMenu()">Back to Menu</button>
                    <button class="btn" id="retry-btn" onclick="startFinalExam()">Retry Exam</button>
                </div>
            </div>
        </div>

        <!-- Progress Screen -->
        <div id="progress-screen" class="hidden">
            <a href="#" class="back-link" onclick="backToMenu(); return false;">&larr; Back to Menu</a>
            <div class="quiz-card">
                <h2 style="margin-bottom: 20px;">Your Progress</h2>
                <div id="progress-details"></div>
            </div>
        </div>

        <!-- Mastered Questions Screen -->
        <div id="mastered-screen" class="hidden">
            <a href="#" class="back-link" onclick="backToMenu(); return false;">&larr; Back to Menu</a>
            <div class="quiz-card">
                <h2 style="margin-bottom: 20px;">Mastered Questions</h2>
                <p style="color: #888; margin-bottom: 15px;">Click "Remove" to add a question back to your practice queue.</p>
                <div id="mastered-list" class="mastered-list"></div>
            </div>
        </div>

        <!-- Course Content Screen -->
        <div id="course-content-screen" class="hidden">
            <a href="#" class="back-link" onclick="backToMenu(); return false;">&larr; Back to Menu</a>
            <div class="quiz-card">
                <h2 style="margin-bottom: 10px;">Study Material</h2>
                <p style="color: #888; margin-bottom: 20px;">Learn from the quiz questions and their explanations.</p>
                <div id="course-content-filter" class="category-filter" style="margin-bottom: 20px;">
                    <div class="category-filter-header">
                        <span class="category-filter-title">Filter by Category</span>
                    </div>
                    <div class="category-chips" id="course-category-chips">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                <div id="course-content-list"></div>
            </div>
        </div>
    </main>

    <!-- Study Material Modal -->
    <div id="study-modal" class="modal-overlay hidden" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Study Material</h2>
                <button class="modal-close" onclick="closeStudyMaterial()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <!-- Quiz Data Modal (combined import + sources) -->
    <div id="sources-modal" class="modal-overlay hidden" onclick="closeSourcesModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Quiz Data</h2>
                <button class="modal-close" onclick="closeSourcesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Import Section (collapsible) -->
                <div style="margin-bottom: 20px; background: #2a2a2a; border-radius: 8px; overflow: hidden;">
                    <button onclick="toggleImportSection()" style="width: 100%; padding: 15px; background: #1a5a1a; border: none; color: white; font-size: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span>Import Quiz Data</span>
                        <span id="import-toggle-icon">+</span>
                    </button>
                    <div id="import-section" style="display: none; padding: 15px;">
                        <!-- Drop Zone -->
                        <div class="drop-zone" id="drop-zone-modal" onclick="document.getElementById('file-input-modal').click()" style="padding: 20px; border: 2px dashed #444; border-radius: 8px; text-align: center; cursor: pointer; margin-bottom: 15px;">
                            <div style="font-size: 32px; margin-bottom: 10px;">üìÅ</div>
                            <div style="color: #ccc;">Drop a file here or click to browse</div>
                            <div style="color: #888; font-size: 0.85rem;">Supports JSON, CSV, or TXT files</div>
                            <input type="file" id="file-input-modal" accept=".json,.csv,.txt" style="display: none;" onchange="handleFileSelectModal(event)">
                        </div>

                        <p style="text-align: center; color: #666; margin-bottom: 15px;">‚Äî or paste text directly ‚Äî</p>

                        <textarea id="import-textarea-modal" style="width: 100%; height: 120px; padding: 10px; background: #1a1a2e; border: 1px solid #333; border-radius: 6px; color: #fff; font-family: monospace; font-size: 13px; resize: vertical;" placeholder="Paste quiz data here (JSON, CSV, or Q&A format)..."></textarea>

                        <!-- Preview Section -->
                        <div id="import-preview-section-modal" style="display: none; margin-top: 15px; padding: 10px; background: #1a1a2e; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Questions found: <strong id="import-count-modal">0</strong></span>
                                <span>Format: <strong id="import-format-modal">Unknown</strong></span>
                            </div>
                            <div id="import-preview-modal" style="max-height: 100px; overflow-y: auto; font-size: 0.85rem; color: #888;"></div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn" onclick="parseImportDataModal()">Preview</button>
                            <button class="btn btn-primary" id="import-confirm-btn-modal" onclick="confirmImportModal()" disabled>Import Questions</button>
                        </div>

                        <!-- Import Options -->
                        <label style="display: flex; align-items: center; gap: 10px; color: #888; cursor: pointer; margin-top: 10px; font-size: 0.9rem;">
                            <input type="checkbox" id="import-replace-modal" style="width: 16px; height: 16px;">
                            Replace existing questions
                        </label>
                    </div>
                </div>

                <!-- Storage Info -->
                <div id="sources-storage-info" style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Storage Used:</span>
                        <span id="sources-storage-text">Loading...</span>
                    </div>
                    <div style="margin-top: 10px; height: 8px; background: #444; border-radius: 4px; overflow: hidden;">
                        <div id="sources-storage-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>

                <!-- Upload Source File Button -->
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="document.getElementById('source-file-upload').click()" style="width: 100%;">
                        üìÅ Upload Source File (PDF, HTML, TXT)
                    </button>
                    <input type="file" id="source-file-upload" accept=".pdf,.html,.htm,.txt,.json,.csv" style="display: none;" onchange="handleSourceFileUpload(event)">
                </div>

                <!-- Import from URL -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="url" id="source-url-input" placeholder="https://example.com/article"
                               style="flex: 1; padding: 12px; background: #1a1a2e; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 14px;">
                        <button class="btn" id="scrape-url-btn" onclick="scrapeUrlSource()" style="white-space: nowrap;">
                            üåê Import URL
                        </button>
                    </div>
                    <div id="url-scrape-status" style="display: none; margin-top: 10px; padding: 10px; border-radius: 6px; font-size: 0.9rem;"></div>
                </div>

                <!-- Sources List -->
                <div id="sources-list" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #888;">Loading sources...</div>
                </div>

                <!-- View Source Content -->
                <div id="source-content-view" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="source-content-title" style="margin: 0; color: #ffd700;"></h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span id="source-content-type-badge" style="background: #0f3460; color: #4fc3f7; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;"></span>
                            <button class="btn-generate" id="generate-quiz-btn" onclick="generateQuizFromSource()">
                                <span>‚ú®</span> Generate Quiz
                            </button>
                            <button class="btn btn-small" onclick="hideSourceContent()">Back to List</button>
                        </div>
                    </div>
                    <!-- Generation Usage Counter -->
                    <div id="generation-usage-display" style="margin-bottom: 15px; display: none;">
                        <span class="usage-badge" id="generation-usage-badge">
                            <span id="generation-usage-text">Loading...</span>
                        </span>
                    </div>

                    <!-- Text/JSON/CSV Viewer -->
                    <pre id="source-viewer-text" style="display: none; background: #1a1a1a; padding: 15px; border-radius: 8px; max-height: 350px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; line-height: 1.5;"></pre>

                    <!-- HTML Viewer (sandboxed iframe) -->
                    <iframe id="source-viewer-html" style="display: none; width: 100%; height: 350px; border: none; border-radius: 8px; background: #fff;" sandbox="allow-same-origin"></iframe>

                    <!-- PDF Viewer -->
                    <div id="source-viewer-pdf" style="display: none;">
                        <div id="pdf-controls" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; padding: 10px; background: #2a2a2a; border-radius: 8px;">
                            <button class="btn btn-small" onclick="pdfPrevPage()" id="pdf-prev-btn">Previous</button>
                            <span id="pdf-page-info" style="color: #ccc;">Page 1 of 1</span>
                            <button class="btn btn-small" onclick="pdfNextPage()" id="pdf-next-btn">Next</button>
                        </div>
                        <div style="background: #2a2a2a; border-radius: 8px; padding: 15px; max-height: 400px; overflow: auto; text-align: center;">
                            <canvas id="pdf-canvas" style="max-width: 100%;"></canvas>
                        </div>
                    </div>

                    <!-- Loading/Error state -->
                    <div id="source-viewer-loading" style="display: none; text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 24px; margin-bottom: 10px;">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgrade-modal" class="modal-overlay hidden" onclick="closeUpgradeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Upgrade to Pro</h2>
                <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Login Required Message -->
                <div id="upgrade-login-required" style="display: none; text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üîê</div>
                    <h3 style="color: #ffd700; margin-bottom: 10px;">Account Required</h3>
                    <p style="color: #ccc; margin-bottom: 20px; line-height: 1.6;">
                        To upgrade to Pro, you need to create an account first.<br>
                        This ensures your license is securely tied to your account.
                    </p>
                    <button class="btn btn-primary" onclick="closeUpgradeModal(); openHamburgerMenu();" style="padding: 12px 30px; font-size: 16px;">
                        Sign In / Create Account
                    </button>
                    <p style="color: #888; font-size: 0.85rem; margin-top: 15px;">
                        Already have a license key? Sign in first to activate it.
                    </p>
                </div>

                <!-- Upgrade Content (shown when logged in) -->
                <div id="upgrade-content">
                <div class="pricing-card featured">
                    <h3 style="color: #ffd700; margin-bottom: 10px;">Pro Monthly</h3>
                    <div class="pricing-price">$4.99<span>/mo</span></div>
                    <ul class="pricing-features">
                        <li>Unlimited imported questions</li>
                        <li>Cloud sync across devices</li>
                        <li>Priority support</li>
                        <li>Early access to new features</li>
                    </ul>
                    <button class="btn-upgrade" onclick="startCheckout('monthly')" style="width: 100%;">Subscribe Monthly</button>
                </div>

                <div class="pricing-card">
                    <h3 style="color: #4fc3f7; margin-bottom: 10px;">Pro Yearly</h3>
                    <div class="pricing-price">$29.99<span>/yr</span></div>
                    <p style="color: #27ae60; font-size: 0.85rem; margin-bottom: 10px;">Save 50%!</p>
                    <ul class="pricing-features">
                        <li>Everything in Pro Monthly</li>
                        <li>2 months free</li>
                    </ul>
                    <button class="btn btn-primary" onclick="startCheckout('yearly')" style="width: 100%;">Subscribe Yearly</button>
                </div>

                <!-- License Status (shown after payment) -->
                <div id="license-status-section" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #1a472a, #2d5a3d); border-radius: 8px; border: 1px solid #ffd700;">
                    <div id="license-pending" style="display: none;">
                        <p style="color: #ffd700; font-weight: bold; margin-bottom: 10px;">‚è≥ Payment Received!</p>
                        <p style="color: #ccc; font-size: 0.9rem; margin-bottom: 15px;">Your license is being processed. This usually takes a few seconds. Check your email for the license key, or click below to check again.</p>
                        <button class="btn btn-primary" onclick="checkForLicense()" id="check-license-btn" style="width: 100%;">Check for License</button>
                    </div>
                    <div id="license-found" style="display: none;">
                        <p style="color: #27ae60; font-weight: bold; margin-bottom: 10px;">‚úì License Found!</p>
                        <p style="color: #ccc; font-size: 0.9rem; margin-bottom: 10px;">Your license key:</p>
                        <div style="background: #0f3460; padding: 12px; border-radius: 6px; font-family: monospace; color: #ffd700; font-size: 14px; word-break: break-all; margin-bottom: 10px;" id="license-display"></div>
                        <button class="btn btn-small" onclick="copyLicenseKey()" style="width: 100%;">Copy License Key</button>
                    </div>
                </div>

                <!-- License Key Entry -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Already have a license key?</p>
                    <input type="text" id="license-key-input" placeholder="XXXX-XXXX-XXXX-XXXX"
                        style="width: 100%; padding: 10px; font-size: 14px; border-radius: 6px; border: 1px solid #333; background: #0f3460; color: white; margin-bottom: 10px; box-sizing: border-box;">
                    <button class="btn btn-small" onclick="activateLicense()" style="width: 100%;">Activate License</button>
                </div>

                <p id="upgrade-error" style="color: #e94560; margin-top: 10px; display: none;"></p>
                <p id="upgrade-success" style="color: #27ae60; margin-top: 10px; display: none;"></p>
                </div><!-- End upgrade-content -->
            </div>
        </div>
    </div>

    <!-- AI Quiz Generation Modal -->
    <div id="ai-generate-modal" class="modal-overlay hidden" onclick="closeAIGenerateModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚ú® AI Quiz Generation</h2>
                <button class="modal-close" onclick="closeAIGenerateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Generation State: Initial -->
                <div id="ai-gen-initial">
                    <p style="color: #ccc; margin-bottom: 15px;">Generate quiz questions from your source material using AI.</p>

                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <button class="mode-btn active" id="mode-btn-quick" onclick="setGenerationMode('quick')">Quick Quiz</button>
                        <button class="mode-btn" id="mode-btn-coverage" onclick="setGenerationMode('coverage')">
                            Full Coverage <span class="pro-badge">PRO</span>
                        </button>
                    </div>

                    <!-- Quick Quiz Options -->
                    <div id="quick-quiz-options">
                        <div style="margin-bottom: 15px;">
                            <label style="color: #888; font-size: 0.9rem;">Number of questions:</label>
                            <select id="ai-question-count" style="width: 100%; padding: 10px; margin-top: 5px; background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 6px;">
                                <option value="5">5 questions</option>
                                <option value="10" selected>10 questions</option>
                                <option value="15">15 questions</option>
                                <option value="20">20 questions</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="color: #888; font-size: 0.9rem;">Difficulty:</label>
                            <select id="ai-difficulty" style="width: 100%; padding: 10px; margin-top: 5px; background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 6px;">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="color: #888; font-size: 0.9rem;">Focus area (optional):</label>
                            <input type="text" id="ai-focus-area" placeholder="e.g., Chapter 3, Security concepts"
                                style="width: 100%; padding: 10px; margin-top: 5px; background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 6px; box-sizing: border-box;">
                        </div>

                        <div id="ai-gen-usage" class="usage-badge" style="margin-bottom: 15px;">
                            <span id="ai-gen-usage-text">Loading usage...</span>
                        </div>

                        <button class="btn-generate" id="ai-start-generate-btn" onclick="startAIGeneration()" style="width: 100%; justify-content: center;">
                            <span>‚ú®</span> Generate Questions
                        </button>
                    </div>

                    <!-- Full Coverage Options -->
                    <div id="coverage-options" style="display: none;">
                        <div class="coverage-options">
                            <p style="color: #888; font-size: 0.85rem; margin-bottom: 15px;">
                                Generate questions from <strong style="color: #4fc3f7;">every section</strong> of your source material. Perfect for comprehensive exam prep.
                            </p>

                            <div style="margin-bottom: 15px;">
                                <label style="color: #888; font-size: 0.9rem;">Questions per section:</label>
                                <select id="coverage-questions-per-section" onchange="loadCoverageEstimate()" style="width: 100%; padding: 10px; margin-top: 5px; background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 6px;">
                                    <option value="5" selected>5 questions</option>
                                    <option value="7">7 questions</option>
                                    <option value="10">10 questions</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="color: #888; font-size: 0.9rem;">Difficulty:</label>
                                <select id="coverage-difficulty" style="width: 100%; padding: 10px; margin-top: 5px; background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 6px;">
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <!-- Estimate Display -->
                            <div id="coverage-estimate-container" style="display: none;">
                                <div class="coverage-estimate">
                                    <div class="estimate-item">
                                        <div class="estimate-value" id="estimate-sections">-</div>
                                        <div class="estimate-label">Sections</div>
                                    </div>
                                    <div class="estimate-item">
                                        <div class="estimate-value" id="estimate-questions">-</div>
                                        <div class="estimate-label">Est. Questions</div>
                                    </div>
                                    <div class="estimate-item">
                                        <div class="estimate-value" id="estimate-calls">-</div>
                                        <div class="estimate-label">API Calls</div>
                                    </div>
                                </div>
                            </div>

                            <div id="coverage-estimate-loading" style="text-align: center; padding: 15px; color: #888; display: none;">
                                Analyzing source...
                            </div>

                            <div id="coverage-block-reason" style="display: none; margin-top: 15px; padding: 12px; background: #1a1a2e; border: 1px solid #ff6b6b; border-radius: 8px; color: #ff6b6b; font-size: 0.85rem;"></div>
                        </div>

                        <div id="coverage-usage" class="usage-badge" style="margin-bottom: 15px;">
                            <span id="coverage-usage-text">Loading usage...</span>
                        </div>

                        <button class="btn-generate" id="coverage-start-btn" onclick="startFullCoverage()" style="width: 100%; justify-content: center;">
                            <span>üìö</span> Start Full Coverage
                        </button>
                    </div>
                </div>

                <!-- Generation State: Coverage Progress -->
                <div id="ai-gen-coverage-progress" style="display: none;">
                    <div class="coverage-progress">
                        <div class="progress-header">
                            <span class="progress-title">Full Coverage Generation</span>
                            <span class="progress-stats"><span id="coverage-questions-count">0</span> questions</span>
                        </div>

                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="coverage-progress-bar" style="width: 0%;">
                                <span class="progress-bar-text" id="coverage-progress-text">0%</span>
                            </div>
                        </div>

                        <div class="section-list" id="coverage-section-list">
                            <!-- Section items will be inserted here -->
                        </div>

                        <div id="coverage-rate-limit-warning" class="rate-limit-warning" style="display: none;">
                            <div class="warning-icon">‚è≥</div>
                            <div class="warning-message">Rate limit reached. Generation paused.</div>
                            <div class="resume-time">Resume in <span id="rate-limit-countdown">6:00</span></div>
                            <button class="btn" onclick="resumeCoverage()" style="margin-top: 10px;">Resume Now</button>
                        </div>

                        <div class="coverage-actions">
                            <button class="btn btn-pause" id="coverage-pause-btn" onclick="pauseCoverage()" style="flex: 1;">Pause</button>
                            <button class="btn btn-cancel-coverage" onclick="cancelCoverage()" style="flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Generation State: Coverage Complete -->
                <div id="ai-gen-coverage-complete" style="display: none;">
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                        <h3 style="color: #4caf50; margin-bottom: 10px;">Full Coverage Complete!</h3>
                        <p style="color: #888; margin-bottom: 20px;">Generated <span id="coverage-final-count">0</span> questions from <span id="coverage-final-sections">0</span> sections</p>
                    </div>

                    <div id="coverage-preview-questions" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                        <!-- Question previews will be inserted here -->
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="acceptCoverageQuestions()" style="flex: 1;">Accept & Import</button>
                        <button class="btn" onclick="resetAIGeneration()" style="flex: 1; background: #555;">Start Over</button>
                    </div>
                </div>

                <!-- Generation State: Loading -->
                <div id="ai-gen-loading" style="display: none; text-align: center; padding: 40px 0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üß†</div>
                    <p style="color: #4fc3f7; font-size: 1.1rem;">Generating questions...</p>
                    <p style="color: #888; font-size: 0.9rem;">This may take 15-30 seconds</p>
                </div>

                <!-- Generation State: Preview -->
                <div id="ai-gen-preview" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #4fc3f7;">Generated <span id="ai-preview-count">0</span> Questions</h3>
                        <span class="usage-badge" id="ai-preview-usage"></span>
                    </div>

                    <div id="ai-preview-questions" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                        <!-- Question previews will be inserted here -->
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="acceptGeneratedQuestions()" style="flex: 1;">Accept & Import</button>
                        <button class="btn" onclick="openRefinementChat()" style="flex: 1;">Refine with Chat</button>
                    </div>

                    <button class="btn btn-small" onclick="regenerateQuestions()" style="width: 100%; background: #555;">Regenerate All</button>
                </div>

                <!-- Generation State: Chat Refinement -->
                <div id="ai-gen-chat" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; color: #4fc3f7;">Refine Questions</h3>
                        <span class="usage-badge" id="ai-chat-usage"></span>
                    </div>
                    <p style="color: #888; font-size: 0.85rem; margin-bottom: 10px;">Tell the AI how to improve the questions. Try: "make harder", "add more about security", "focus on chapter 2"</p>

                    <div class="ai-chat-container">
                        <div class="ai-chat-messages" id="ai-chat-messages">
                            <!-- Chat messages will be inserted here -->
                        </div>
                        <div class="ai-chat-input-row">
                            <input type="text" class="ai-chat-input" id="ai-chat-input" placeholder="Type your refinement request..."
                                onkeypress="if(event.key === 'Enter') sendChatRefinement()">
                            <button class="ai-chat-send" id="ai-chat-send-btn" onclick="sendChatRefinement()">Send</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="backToPreview()" style="flex: 1; background: #555;">Back to Preview</button>
                        <button class="btn btn-success" onclick="acceptGeneratedQuestions()" style="flex: 1;">Accept & Import</button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="ai-gen-error" style="display: none; text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                    <p style="color: #ff6b6b;" id="ai-gen-error-message">An error occurred</p>
                    <button class="btn" onclick="resetAIGeneration()" style="margin-top: 15px;">Try Again</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pro Features Modal -->
    <div id="pro-features-modal" class="modal-overlay hidden" onclick="closeProFeaturesModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1a472a, #2d5a3d); border-bottom: 2px solid #ffd700;">
                <h2 style="color: #ffd700;">Pro Member Benefits</h2>
                <button class="modal-close" onclick="closeProFeaturesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 18px;">PRO</span>
                </div>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 12px 0; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 12px;">
                        <span style="color: #27ae60; font-size: 20px;">‚úì</span>
                        <span><strong>Unlimited imported questions</strong><br><span style="color: #888; font-size: 13px;">Import as many quizzes as you need</span></span>
                    </li>
                    <li style="padding: 12px 0; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 12px;">
                        <span style="color: #27ae60; font-size: 20px;">‚úì</span>
                        <span><strong>Cloud sync across devices</strong><br><span style="color: #888; font-size: 13px;">Your progress follows you everywhere</span></span>
                    </li>
                    <li style="padding: 12px 0; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 12px;">
                        <span style="color: #27ae60; font-size: 20px;">‚úì</span>
                        <span><strong>Priority support</strong><br><span style="color: #888; font-size: 13px;">Get help when you need it</span></span>
                    </li>
                    <li style="padding: 12px 0; display: flex; align-items: center; gap: 12px;">
                        <span style="color: #27ae60; font-size: 20px;">‚úì</span>
                        <span><strong>Early access to new features</strong><br><span style="color: #888; font-size: 13px;">Be the first to try new updates</span></span>
                    </li>
                </ul>
                <div style="margin-top: 20px; padding: 15px; background: #0d1117; border-radius: 8px; text-align: center;">
                    <div style="color: #888; font-size: 12px; margin-bottom: 5px;">License Key</div>
                    <div style="color: #4fc3f7; font-family: monospace; font-size: 14px;" id="pro-license-display">-</div>
                </div>
                <p style="text-align: center; color: #27ae60; margin-top: 15px;">Thank you for supporting QuizMyself!</p>
            </div>
        </div>
    </div>

    <!-- Keyword Manager Modal -->
    <div id="keyword-modal" class="modal-overlay hidden" onclick="closeKeywordModal()">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Manage Quizzes</h2>
                <button class="modal-close" onclick="closeKeywordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 1rem; color: #4fc3f7; margin-bottom: 10px;">Add New Quiz</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-keyword-input" placeholder="Enter quiz name" style="flex: 1; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 5px; color: white;">
                        <button class="btn btn-primary btn-small" onclick="handleAddKeyword()">Add</button>
                    </div>
                </div>

                <div>
                    <h3 style="font-size: 1rem; color: #4fc3f7; margin-bottom: 10px;">Your Quizzes</h3>
                    <div id="keyword-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="keyword-modal-message" style="margin-top: 15px; display: none; padding: 10px; border-radius: 5px;"></div>
            </div>
        </div>
    </div>

    <!-- Create Quiz Modal -->
    <div id="create-quiz-modal" class="modal-overlay hidden" onclick="closeCreateQuizModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 550px;">
            <div class="modal-header">
                <h2>Create New Quiz</h2>
                <button class="modal-close" onclick="closeCreateQuizModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Quiz Name -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 0.9rem;">Quiz Name</label>
                    <input type="text" id="create-quiz-name" placeholder="my-quiz-name"
                        style="width: 100%; padding: 12px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; font-size: 1rem; box-sizing: border-box;">
                    <div style="color: #888; font-size: 0.8rem; margin-top: 5px;">Letters, numbers, and dashes only (3-50 characters)</div>
                </div>

                <!-- Source Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 0.9rem;">Study Material (Optional)</label>

                    <!-- Source Options -->
                    <div id="create-quiz-source-options" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- No Source Option -->
                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #2a2a2a; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" class="source-option" data-option="none">
                            <input type="radio" name="source-option" value="none" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="color: #fff;">Skip for now</div>
                                <div style="color: #888; font-size: 0.85rem;">Create quiz without study material</div>
                            </div>
                        </label>

                        <!-- Select Existing Source -->
                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #2a2a2a; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" class="source-option" data-option="existing">
                            <input type="radio" name="source-option" value="existing" style="width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="color: #fff;">Use existing source</div>
                                <div style="color: #888; font-size: 0.85rem;" id="existing-source-count">Loading...</div>
                            </div>
                        </label>
                    </div>

                    <!-- Existing Sources Picker (hidden by default) -->
                    <div id="create-quiz-existing-section" style="display: none; margin-top: 15px;">
                        <div id="create-quiz-sources-list" style="max-height: 200px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 10px;">
                            Loading sources...
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="create-quiz-error" style="display: none; color: #e94560; margin-bottom: 15px; padding: 10px; background: rgba(233,69,96,0.1); border-radius: 6px;"></div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="closeCreateQuizModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="createQuizWithSource()" id="create-quiz-submit" style="flex: 1;">Create Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Editor Modal -->
    <div id="quiz-editor-modal" class="modal-overlay hidden" onclick="closeQuizEditorModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Quiz</h2>
                <button class="modal-close" onclick="closeQuizEditorModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Quiz Info -->
                <div id="quiz-editor-info" style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="quiz-editor-name" style="font-weight: bold; color: #ffd700;"></span>
                            <span id="quiz-editor-count" style="color: #888; margin-left: 10px;"></span>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="showAddQuestionForm()">+ Add Question</button>
                    </div>
                </div>

                <!-- Add/Edit Question Form (hidden by default) -->
                <div id="question-form" style="display: none; margin-bottom: 20px; padding: 20px; background: #1a3a1a; border-radius: 8px; border: 1px solid #4CAF50;">
                    <h3 id="question-form-title" style="color: #4CAF50; margin-bottom: 15px;">Add New Question</h3>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9rem;">Category</label>
                        <input type="text" id="question-form-category" placeholder="e.g., Math, History, Science"
                            style="width: 100%; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9rem;">Question *</label>
                        <textarea id="question-form-text" placeholder="Enter your question..."
                            style="width: 100%; height: 80px; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; box-sizing: border-box; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ccc; margin-bottom: 5px; font-size: 0.9rem;">Full Answer / Explanation</label>
                        <textarea id="question-form-answer" placeholder="Detailed answer or explanation (optional)..."
                            style="width: 100%; height: 60px; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; box-sizing: border-box; resize: vertical;"></textarea>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: #ccc; margin-bottom: 10px; font-size: 0.9rem;">Answer Choices * (select the correct one)</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="radio" name="correct-choice" value="0" checked style="width: 20px; height: 20px;">
                                <input type="text" id="question-form-choice-0" placeholder="Choice A"
                                    style="flex: 1; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white;">
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="radio" name="correct-choice" value="1" style="width: 20px; height: 20px;">
                                <input type="text" id="question-form-choice-1" placeholder="Choice B"
                                    style="flex: 1; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white;">
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="radio" name="correct-choice" value="2" style="width: 20px; height: 20px;">
                                <input type="text" id="question-form-choice-2" placeholder="Choice C"
                                    style="flex: 1; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white;">
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="radio" name="correct-choice" value="3" style="width: 20px; height: 20px;">
                                <input type="text" id="question-form-choice-3" placeholder="Choice D"
                                    style="flex: 1; padding: 10px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white;">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="hideQuestionForm()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveQuestionFromForm()">Save Question</button>
                    </div>
                    <input type="hidden" id="question-form-edit-id" value="">
                </div>

                <!-- Questions List -->
                <div id="quiz-editor-questions" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #888;">Loading questions...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal-overlay hidden" onclick="closeFeedbackModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Send Feedback</h2>
                <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #888; margin-bottom: 15px;">We would love to hear from you! Share your thoughts, report bugs, or suggest new features.</p>

                <!-- Feedback Type -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 0.9rem;">Type</label>
                    <select id="feedback-type" style="width: 100%; padding: 12px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; font-size: 1rem; box-sizing: border-box;">
                        <option value="feedback">General Feedback</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="question">Question</option>
                    </select>
                </div>

                <!-- Feedback Message -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 0.9rem;">Message</label>
                    <textarea id="feedback-message" placeholder="Tell us what's on your mind..."
                        style="width: 100%; height: 150px; padding: 12px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; font-size: 1rem; box-sizing: border-box; resize: vertical;"></textarea>
                </div>

                <!-- Email (optional for non-logged in users) -->
                <div id="feedback-email-section" style="margin-bottom: 15px;">
                    <label style="display: block; color: #ccc; margin-bottom: 8px; font-size: 0.9rem;">Email (optional, for follow-up)</label>
                    <input type="email" id="feedback-email" placeholder="your@email.com"
                        style="width: 100%; padding: 12px; background: #0f3460; border: 1px solid #333; border-radius: 6px; color: white; font-size: 1rem; box-sizing: border-box;">
                </div>

                <!-- Status Message -->
                <div id="feedback-status" style="display: none; margin-bottom: 15px; padding: 12px; border-radius: 6px;"></div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="closeFeedbackModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="submitFeedback()" id="feedback-submit" style="flex: 1;">Send Feedback</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Roadmap Modal -->
    <div id="roadmap-modal" class="modal-overlay hidden" onclick="closeRoadmapModalOnOverlay(event)" role="dialog" aria-modal="true" aria-labelledby="roadmap-modal-title">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="roadmap-modal-title">Progress</h2>
                <button class="modal-close" onclick="closeRoadmapModal()" aria-label="Close progress modal">&times;</button>
            </div>
            <div class="modal-body" id="roadmap-content">
                <!-- Dynamic content loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ========== TOAST & MODAL UTILITIES ==========

        // Show a toast notification
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-content">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);

            return toast;
        }

        // Show a confirmation modal (returns a Promise)
        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const iconEl = document.getElementById('confirm-modal-icon');
                const titleEl = document.getElementById('confirm-modal-title');
                const cancelBtn = document.getElementById('confirm-modal-cancel');
                const confirmBtn = document.getElementById('confirm-modal-confirm');

                // Set content
                iconEl.textContent = options.icon || '‚ö†';
                titleEl.textContent = message;
                cancelBtn.textContent = options.cancelText || 'Cancel';
                confirmBtn.textContent = options.confirmText || 'Confirm';
                confirmBtn.className = `btn ${options.danger ? 'btn-danger' : 'btn-primary'}`;

                // Show modal
                modal.classList.remove('hidden');

                // Handle responses
                const cleanup = () => {
                    modal.classList.add('hidden');
                    cancelBtn.onclick = null;
                    confirmBtn.onclick = null;
                };

                cancelBtn.onclick = () => { cleanup(); resolve(false); };
                confirmBtn.onclick = () => { cleanup(); resolve(true); };
            });
        }

        // Show a selection modal (returns a Promise with selected value or null)
        function showSelection(title, subtitle, items, options = {}) {
            console.log('[DEBUG showSelection] Called with:', { title, subtitle, items, options });
            return new Promise((resolve) => {
                const modal = document.getElementById('selection-modal');
                const titleEl = document.getElementById('selection-modal-title');
                const subtitleEl = document.getElementById('selection-modal-subtitle');
                const listEl = document.getElementById('selection-modal-list');
                const cancelBtn = document.getElementById('selection-modal-cancel');
                const confirmBtn = document.getElementById('selection-modal-confirm');

                console.log('[DEBUG showSelection] Elements:', {
                    modal: !!modal,
                    titleEl: !!titleEl,
                    subtitleEl: !!subtitleEl,
                    listEl: !!listEl,
                    cancelBtn: !!cancelBtn,
                    confirmBtn: !!confirmBtn
                });

                if (!modal) {
                    console.error('[DEBUG showSelection] Modal element not found!');
                    resolve(null);
                    return;
                }

                let selectedValue = null;

                // Set content
                titleEl.textContent = title;
                subtitleEl.textContent = subtitle || '';
                confirmBtn.textContent = options.confirmText || 'Select';
                confirmBtn.disabled = true;

                // Render items with escaped HTML attributes
                listEl.innerHTML = items.map((item, index) => `
                    <div class="selection-modal-item" data-value="${escapeAttr(item.value)}" data-index="${index}">
                        <div class="selection-modal-item-title">${escapeHtml(item.title)}</div>
                        ${item.subtitle ? `<div class="selection-modal-item-subtitle">${escapeHtml(item.subtitle)}</div>` : ''}
                    </div>
                `).join('');

                // Handle item selection with proper event handling
                const itemClickHandlers = [];
                listEl.querySelectorAll('.selection-modal-item').forEach(el => {
                    const handler = (e) => {
                        e.stopPropagation();
                        listEl.querySelectorAll('.selection-modal-item').forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                        selectedValue = el.dataset.value;
                        confirmBtn.disabled = false;
                    };
                    el.addEventListener('click', handler);
                    itemClickHandlers.push({ el, handler });
                });

                // Show modal
                modal.classList.remove('hidden');
                console.log('[DEBUG showSelection] Modal shown, classes:', modal.className);
                console.log('[DEBUG showSelection] Modal computed display:', window.getComputedStyle(modal).display);

                // Handle responses with cleanup
                const cleanup = () => {
                    modal.classList.add('hidden');
                    // Clear all event handlers
                    cancelBtn.onclick = null;
                    confirmBtn.onclick = null;
                    itemClickHandlers.forEach(({ el, handler }) => {
                        el.removeEventListener('click', handler);
                    });
                };

                cancelBtn.onclick = (e) => { e.stopPropagation(); cleanup(); resolve(null); };
                confirmBtn.onclick = (e) => { e.stopPropagation(); cleanup(); resolve(selectedValue); };
            });
        }

        // Owner account that can see all data
        const OWNER_EMAIL = 'noxestyle@gmail.com';

        // Demo questions for non-owner users - 7 categories of engaging trivia
        const demoQuestions = [
            // POP CULTURE (10 questions)
            { id: 1, category: "Pop Culture", q: "Which social media platform is known for its disappearing messages called 'Snaps'?", a: "Snapchat pioneered the ephemeral messaging format where photos and videos disappear after being viewed", choices: ["Instagram", "TikTok", "Snapchat", "Twitter"], correct: 2 },
            { id: 2, category: "Pop Culture", q: "What fictional country is the setting for Marvel's Black Panther?", a: "Wakanda is a technologically advanced fictional African nation, home to the superhero Black Panther", choices: ["Latveria", "Wakanda", "Genosha", "Sokovia"], correct: 1 },
            { id: 3, category: "Pop Culture", q: "Which video game franchise features a character named Mario who rescues Princess Peach?", a: "Super Mario Bros. is Nintendo's flagship franchise, first appearing in 1985", choices: ["Sonic the Hedgehog", "The Legend of Zelda", "Super Mario Bros.", "Donkey Kong"], correct: 2 },
            { id: 4, category: "Pop Culture", q: "What is the name of the fictional wizarding school in Harry Potter?", a: "Hogwarts School of Witchcraft and Wizardry is where Harry Potter learns magic in J.K. Rowling's series", choices: ["Beauxbatons", "Durmstrang", "Ilvermorny", "Hogwarts"], correct: 3 },
            { id: 5, category: "Pop Culture", q: "Which streaming service created the shows 'Stranger Things' and 'The Crown'?", a: "Netflix has produced numerous original series including these award-winning shows", choices: ["Netflix", "Amazon Prime", "Hulu", "Disney+"], correct: 0 },
            { id: 6, category: "Pop Culture", q: "What is the best-selling video game console of all time?", a: "The PlayStation 2 sold over 155 million units worldwide between 2000 and 2013", choices: ["Nintendo Wii", "PlayStation 2", "Xbox 360", "Nintendo Switch"], correct: 1 },
            { id: 7, category: "Pop Culture", q: "Which K-pop group performed 'Dynamite' and has a massive fanbase called ARMY?", a: "BTS (Bangtan Sonyeondan) became a global phenomenon with their song Dynamite in 2020", choices: ["BLACKPINK", "EXO", "BTS", "TWICE"], correct: 2 },
            { id: 8, category: "Pop Culture", q: "What animated series features the Simpson family living in Springfield?", a: "The Simpsons debuted in 1989 and became the longest-running American animated program", choices: ["Family Guy", "South Park", "The Simpsons", "Futurama"], correct: 2 },
            { id: 9, category: "Pop Culture", q: "Which company created the iPhone?", a: "Apple Inc. released the first iPhone in 2007, revolutionizing the smartphone industry", choices: ["Samsung", "Google", "Microsoft", "Apple"], correct: 3 },
            { id: 10, category: "Pop Culture", q: "What is the name of the virtual reality world in the movie 'Ready Player One'?", a: "The OASIS is a virtual universe where most of humanity spends their time in Ernest Cline's story", choices: ["The Matrix", "The OASIS", "Metaverse", "Second Life"], correct: 1 },

            // POLITICS (8 questions)
            { id: 11, category: "Politics", q: "How many members serve in the United States Senate?", a: "The U.S. Senate has 100 members, with 2 senators representing each of the 50 states", choices: ["50", "100", "435", "538"], correct: 1 },
            { id: 12, category: "Politics", q: "What is the term length for a U.S. House of Representatives member?", a: "Representatives serve 2-year terms, requiring frequent re-election campaigns", choices: ["2 years", "4 years", "6 years", "8 years"], correct: 0 },
            { id: 13, category: "Politics", q: "Which document begins with 'We the People'?", a: "The U.S. Constitution's preamble starts with these famous words, establishing popular sovereignty", choices: ["Declaration of Independence", "Bill of Rights", "U.S. Constitution", "Articles of Confederation"], correct: 2 },
            { id: 14, category: "Politics", q: "What is the minimum age requirement to become President of the United States?", a: "Article II of the Constitution requires the President to be at least 35 years old", choices: ["25 years", "30 years", "35 years", "40 years"], correct: 2 },
            { id: 15, category: "Politics", q: "Which branch of the U.S. government is responsible for interpreting laws?", a: "The Judicial Branch, headed by the Supreme Court, interprets the Constitution and federal laws", choices: ["Executive", "Legislative", "Judicial", "Administrative"], correct: 2 },
            { id: 16, category: "Politics", q: "What is the electoral college threshold needed to win the U.S. presidency?", a: "A candidate needs 270 electoral votes out of 538 total to win the presidency", choices: ["218", "270", "326", "435"], correct: 1 },
            { id: 17, category: "Politics", q: "Which amendment to the U.S. Constitution abolished slavery?", a: "The 13th Amendment, ratified in 1865, abolished slavery throughout the United States", choices: ["13th Amendment", "14th Amendment", "15th Amendment", "19th Amendment"], correct: 0 },
            { id: 18, category: "Politics", q: "What is the term for a two-chamber legislature?", a: "A bicameral legislature has two separate chambers, like the U.S. Congress with Senate and House", choices: ["Unicameral", "Bicameral", "Tricameral", "Parliamentary"], correct: 1 },

            // HISTORY (10 questions)
            { id: 19, category: "History", q: "In what year did World War II end?", a: "WWII ended in 1945 with Germany surrendering in May and Japan in September", choices: ["1943", "1944", "1945", "1946"], correct: 2 },
            { id: 20, category: "History", q: "Who was the first President of the United States?", a: "George Washington served as the first President from 1789 to 1797", choices: ["Thomas Jefferson", "John Adams", "Benjamin Franklin", "George Washington"], correct: 3 },
            { id: 21, category: "History", q: "What ancient wonder was located in Alexandria, Egypt?", a: "The Lighthouse of Alexandria (Pharos) was one of the Seven Wonders of the Ancient World", choices: ["Hanging Gardens", "Colossus of Rhodes", "Lighthouse of Alexandria", "Temple of Artemis"], correct: 2 },
            { id: 22, category: "History", q: "Which empire built the Colosseum in Rome?", a: "The Roman Empire constructed the Colosseum, completed in 80 AD under Emperor Titus", choices: ["Greek Empire", "Roman Empire", "Byzantine Empire", "Ottoman Empire"], correct: 1 },
            { id: 23, category: "History", q: "What was the name of the ship that brought the Pilgrims to America in 1620?", a: "The Mayflower transported 102 passengers from England to Plymouth, Massachusetts", choices: ["Santa Maria", "Mayflower", "HMS Victory", "Endeavour"], correct: 1 },
            { id: 24, category: "History", q: "Which civilization built Machu Picchu?", a: "The Inca Empire built Machu Picchu in the 15th century in present-day Peru", choices: ["Aztec", "Maya", "Inca", "Olmec"], correct: 2 },
            { id: 25, category: "History", q: "In what year did the Berlin Wall fall?", a: "The Berlin Wall fell on November 9, 1989, symbolizing the end of the Cold War", choices: ["1987", "1988", "1989", "1990"], correct: 2 },
            { id: 26, category: "History", q: "Who wrote the Declaration of Independence?", a: "Thomas Jefferson was the principal author of the Declaration of Independence in 1776", choices: ["George Washington", "Benjamin Franklin", "John Adams", "Thomas Jefferson"], correct: 3 },
            { id: 27, category: "History", q: "What ancient trade route connected China to the Mediterranean?", a: "The Silk Road was a network of trade routes connecting East Asia to the Mediterranean", choices: ["Spice Route", "Silk Road", "Amber Road", "Tea Route"], correct: 1 },
            { id: 28, category: "History", q: "Which queen ruled England for 63 years during the Victorian era?", a: "Queen Victoria reigned from 1837 to 1901, the longest reign until Queen Elizabeth II", choices: ["Queen Elizabeth I", "Queen Victoria", "Queen Anne", "Queen Mary"], correct: 1 },

            // ART (8 questions)
            { id: 29, category: "Art", q: "Who painted the Mona Lisa?", a: "Leonardo da Vinci painted the Mona Lisa between 1503 and 1519, now housed in the Louvre", choices: ["Michelangelo", "Raphael", "Leonardo da Vinci", "Botticelli"], correct: 2 },
            { id: 30, category: "Art", q: "What art movement is Salvador Dali associated with?", a: "Surrealism explored the unconscious mind through dreamlike imagery; Dali was a leading figure", choices: ["Impressionism", "Cubism", "Surrealism", "Pop Art"], correct: 2 },
            { id: 31, category: "Art", q: "Which artist is famous for painting sunflowers and 'Starry Night'?", a: "Vincent van Gogh created these iconic Post-Impressionist works in the late 1880s", choices: ["Claude Monet", "Vincent van Gogh", "Paul Cezanne", "Edgar Degas"], correct: 1 },
            { id: 32, category: "Art", q: "What famous sculpture depicts a man deep in thought?", a: "The Thinker was created by Auguste Rodin, originally part of a larger work called The Gates of Hell", choices: ["David", "The Thinker", "Venus de Milo", "Pieta"], correct: 1 },
            { id: 33, category: "Art", q: "Which artist painted the ceiling of the Sistine Chapel?", a: "Michelangelo painted the Sistine Chapel ceiling between 1508 and 1512 in Vatican City", choices: ["Leonardo da Vinci", "Raphael", "Michelangelo", "Caravaggio"], correct: 2 },
            { id: 34, category: "Art", q: "What museum in Paris houses the Mona Lisa?", a: "The Louvre Museum in Paris is home to the Mona Lisa and thousands of other artworks", choices: ["Musee d'Orsay", "The Louvre", "Centre Pompidou", "Rodin Museum"], correct: 1 },
            { id: 35, category: "Art", q: "Which art movement featured artists like Monet and Renoir painting with visible brushstrokes?", a: "Impressionism emerged in 1870s France, focusing on light, color, and everyday scenes", choices: ["Baroque", "Romanticism", "Impressionism", "Expressionism"], correct: 2 },
            { id: 36, category: "Art", q: "Who created the sculpture of David, depicting the biblical hero?", a: "Michelangelo carved the marble statue of David between 1501 and 1504 in Florence", choices: ["Donatello", "Bernini", "Michelangelo", "Rodin"], correct: 2 },

            // MUSIC (10 questions)
            { id: 37, category: "Music", q: "Which band performed 'Bohemian Rhapsody'?", a: "Queen released Bohemian Rhapsody in 1975, featuring Freddie Mercury's iconic vocals", choices: ["The Beatles", "Led Zeppelin", "Queen", "Pink Floyd"], correct: 2 },
            { id: 38, category: "Music", q: "What instrument has 88 keys?", a: "A standard piano has 88 keys, spanning over seven octaves", choices: ["Organ", "Piano", "Harpsichord", "Accordion"], correct: 1 },
            { id: 39, category: "Music", q: "Who is known as the 'King of Pop'?", a: "Michael Jackson earned this title through his groundbreaking music and performances", choices: ["Elvis Presley", "Prince", "Michael Jackson", "James Brown"], correct: 2 },
            { id: 40, category: "Music", q: "Which classical composer became deaf but continued to compose music?", a: "Ludwig van Beethoven began losing his hearing in his late 20s but composed his greatest works while deaf", choices: ["Mozart", "Bach", "Beethoven", "Chopin"], correct: 2 },
            { id: 41, category: "Music", q: "What music genre originated in New Orleans and features improvisation?", a: "Jazz emerged in New Orleans in the early 20th century, blending African and European musical traditions", choices: ["Blues", "Jazz", "Rock and Roll", "Country"], correct: 1 },
            { id: 42, category: "Music", q: "Which Beatles album features the iconic Abbey Road crosswalk cover?", a: "Abbey Road (1969) shows the four Beatles walking across a zebra crossing near their studio", choices: ["Sgt. Pepper's", "Let It Be", "Abbey Road", "Revolver"], correct: 2 },
            { id: 43, category: "Music", q: "What is the highest female singing voice called?", a: "Soprano is the highest female voice type, typically ranging from middle C to high C", choices: ["Alto", "Mezzo-soprano", "Soprano", "Contralto"], correct: 2 },
            { id: 44, category: "Music", q: "Which instrument is Yo-Yo Ma famous for playing?", a: "Yo-Yo Ma is a world-renowned cellist who has won multiple Grammy Awards", choices: ["Violin", "Cello", "Viola", "Double Bass"], correct: 1 },
            { id: 45, category: "Music", q: "What country is credited as the birthplace of opera?", a: "Opera originated in Italy during the late 16th century, with Florence being a key early center", choices: ["Germany", "France", "Italy", "Austria"], correct: 2 },
            { id: 46, category: "Music", q: "Which music streaming service is known for its green logo and was founded in Sweden?", a: "Spotify was founded in Stockholm, Sweden in 2006 and launched in 2008", choices: ["Apple Music", "Spotify", "Pandora", "Tidal"], correct: 1 },

            // MOVIES (10 questions)
            { id: 47, category: "Movies", q: "What film won the first Academy Award for Best Picture?", a: "Wings (1927) was the first film to win the Academy Award for Best Picture at the inaugural ceremony", choices: ["The Jazz Singer", "Wings", "Sunrise", "Ben-Hur"], correct: 1 },
            { id: 48, category: "Movies", q: "Who directed the Star Wars original trilogy?", a: "George Lucas created and directed the original Star Wars (1977), starting the iconic franchise", choices: ["Steven Spielberg", "George Lucas", "James Cameron", "Ridley Scott"], correct: 1 },
            { id: 49, category: "Movies", q: "What is the highest-grossing film of all time (adjusted for inflation)?", a: "Gone with the Wind (1939) remains the highest-grossing film when adjusted for inflation", choices: ["Avatar", "Titanic", "Gone with the Wind", "Avengers: Endgame"], correct: 2 },
            { id: 50, category: "Movies", q: "Which actor played the character of James Bond in the most films?", a: "Roger Moore played James Bond in seven films, more than any other actor", choices: ["Sean Connery", "Roger Moore", "Daniel Craig", "Pierce Brosnan"], correct: 1 },
            { id: 51, category: "Movies", q: "What 1994 film features the quote 'Life is like a box of chocolates'?", a: "Forrest Gump starred Tom Hanks and became one of the most quoted films in cinema history", choices: ["The Shawshank Redemption", "Pulp Fiction", "Forrest Gump", "The Lion King"], correct: 2 },
            { id: 52, category: "Movies", q: "Which film features a great white shark terrorizing a beach community?", a: "Jaws (1975) directed by Steven Spielberg became the first summer blockbuster", choices: ["The Meg", "Deep Blue Sea", "Jaws", "Sharknado"], correct: 2 },
            { id: 53, category: "Movies", q: "What was the first feature-length animated film by Disney?", a: "Snow White and the Seven Dwarfs (1937) was Disney's first full-length animated feature", choices: ["Fantasia", "Pinocchio", "Snow White and the Seven Dwarfs", "Dumbo"], correct: 2 },
            { id: 54, category: "Movies", q: "Which film franchise features a character named Ellen Ripley fighting aliens?", a: "The Alien franchise stars Sigourney Weaver as Ellen Ripley, beginning with Alien (1979)", choices: ["Predator", "Alien", "Species", "Event Horizon"], correct: 1 },
            { id: 55, category: "Movies", q: "What is the name of the fictional African kingdom in Coming to America?", a: "Zamunda is the fictional wealthy African nation ruled by King Jaffe Joffer in the 1988 comedy", choices: ["Wakanda", "Zamunda", "Genovia", "Aldovia"], correct: 1 },
            { id: 56, category: "Movies", q: "Which director is known for films like 'Inception', 'The Dark Knight', and 'Interstellar'?", a: "Christopher Nolan is celebrated for his complex narratives and practical effects", choices: ["David Fincher", "Denis Villeneuve", "Christopher Nolan", "Quentin Tarantino"], correct: 2 },

            // CURRENT EVENTS - Timeless/Evergreen Topics (9 questions)
            { id: 57, category: "Current Events", q: "What international organization has its headquarters in New York City?", a: "The United Nations headquarters has been in New York City since 1952", choices: ["World Bank", "United Nations", "NATO", "World Health Organization"], correct: 1 },
            { id: 58, category: "Current Events", q: "Which renewable energy source generates electricity from sunlight?", a: "Solar power converts sunlight directly into electricity using photovoltaic cells", choices: ["Wind power", "Hydroelectric", "Solar power", "Geothermal"], correct: 2 },
            { id: 59, category: "Current Events", q: "What does 'cryptocurrency' refer to?", a: "Cryptocurrency is digital currency using cryptography for security, operating on blockchain technology", choices: ["Government-issued digital currency", "Digital currency using cryptography", "Virtual currency in video games", "Credit card rewards points"], correct: 1 },
            { id: 60, category: "Current Events", q: "What is the European Union's common currency called?", a: "The Euro is used by 20 of the 27 EU member states in the eurozone", choices: ["Pound", "Euro", "Franc", "Mark"], correct: 1 },
            { id: 61, category: "Current Events", q: "Which global agreement addresses climate change by setting emission reduction targets?", a: "The Paris Agreement (2015) aims to limit global warming to 1.5-2 degrees Celsius", choices: ["Kyoto Protocol", "Paris Agreement", "Montreal Protocol", "Geneva Convention"], correct: 1 },
            { id: 62, category: "Current Events", q: "What does the acronym 'AI' stand for in technology?", a: "Artificial Intelligence refers to computer systems capable of performing tasks that require human intelligence", choices: ["Automated Integration", "Artificial Intelligence", "Advanced Internet", "Algorithmic Interface"], correct: 1 },
            { id: 63, category: "Current Events", q: "What is 'electric vehicle' commonly abbreviated as?", a: "EV stands for Electric Vehicle, which uses electric motors powered by batteries", choices: ["EV", "EC", "EM", "EP"], correct: 0 },
            { id: 64, category: "Current Events", q: "Which organization is responsible for space exploration including the Mars rovers?", a: "NASA (National Aeronautics and Space Administration) has sent multiple rovers to Mars", choices: ["SpaceX", "NASA", "ESA", "Blue Origin"], correct: 1 },
            { id: 65, category: "Current Events", q: "What does '5G' refer to in telecommunications?", a: "5G is the fifth generation of cellular network technology, offering faster speeds and lower latency", choices: ["5 Gigabytes of data", "Fifth generation cellular network", "5 Gigahertz frequency", "5 Global networks"], correct: 1 }
        ];

        // Question Bank - 200+ questions from WGU D322 course (owner only)
        const wguQuestions = [
            // IT Roles & Functions
            { id: 1, category: "IT Roles", q: "Computer Engineering (CE) primarily focuses on:", a: "The design of hardware systems and the software that makes them work, including drivers for peripheral devices and embedded systems", choices: ["The design of hardware systems and the software that makes them work", "The theoretical study of algorithms and computational complexity", "Integrating IT solutions with organizational business processes", "Managing and securing enterprise network infrastructure"], correct: 0 },
            { id: 2, category: "IT Roles", q: "The discipline of Computer Science (CS) is characterized by:", a: "The design and implementation of software with emphasis on developing effective ways to solve computing problems, including robotics, AI, and algorithms", choices: ["Building and maintaining physical computing hardware", "Design and implementation of software to solve computing problems", "Managing database systems and data warehouses", "Configuring and troubleshooting network systems"], correct: 1 },
            { id: 3, category: "IT Roles", q: "Software Engineering (SE) can be defined as:", a: "The development and maintenance of reliable and efficient software systems for enterprises", choices: ["Designing computer hardware and circuit boards", "Managing IT infrastructure and cloud services", "Development and maintenance of reliable software systems", "Analyzing business requirements without implementation"], correct: 2 },
            { id: 4, category: "IT Roles", q: "An organization uses Information Systems (IS) professionals to:", a: "Integrating IT solutions to meet organizational business goals, addressing systems that generate, process, and distribute information", choices: ["Writing low-level system drivers and firmware", "Building and repairing computer hardware", "Designing algorithms for artificial intelligence", "Integrating IT solutions to meet organizational business goals"], correct: 3 },
            { id: 5, category: "IT Roles", q: "The primary purpose of Information Technology (IT) is:", a: "The technology supporting information systems in an organization, responding to practical needs including reliable and secure solutions", choices: ["Technology supporting information systems in organizations", "Theoretical computer science research", "Developing new programming languages", "Manufacturing computer components"], correct: 0 },
            { id: 6, category: "IT Roles", q: "A System Administrator primarily:", a: "Providing technical support for hardware and software issues, including log-in issues, and understanding network vulnerabilities", choices: ["Designing software architecture and writing code", "Providing technical support for hardware and software issues", "Creating database schemas and SQL queries", "Developing machine learning models"], correct: 1 },
            { id: 7, category: "IT Roles", q: "Which role is responsible for designing, planning, and maintaining an organization's network?", a: "Designing, planning, setting up, and maintaining an organization's network", choices: ["Writing application software and APIs", "Managing database backups and recovery", "Network Engineer", "Developing cybersecurity policies and procedures"], correct: 2 },
            { id: 8, category: "IT Roles", q: "A Database Administrator's primary duties include:", a: "Installing and configuring databases, fixing database errors, and creating user accounts", choices: ["Configuring routers and network switches", "Managing cloud computing infrastructure", "Writing front-end user interfaces", "Installing and configuring databases"], correct: 3 },
            { id: 9, category: "IT Roles", q: "The role of Security Administrator involves:", a: "Installing, administering, and troubleshooting network security issues", choices: ["Installing and troubleshooting network security issues", "Developing web applications and services", "Managing database performance tuning", "Designing user experience interfaces"], correct: 0 },
            { id: 10, category: "IT Roles", q: "Select the description that matches a Web Administrator:", a: "Troubleshooting website errors, tracking and analyzing website usage data, and reporting security breaches", choices: ["Managing physical server hardware", "Troubleshooting website errors and analyzing usage data", "Designing network topology and architecture", "Writing database stored procedures"], correct: 1 },
            { id: 11, category: "IT Roles", q: "A Cloud Architect's core responsibility involves:", a: "Overseeing a company's cloud computing systems", choices: ["Installing and maintaining physical on-premises servers", "Writing embedded systems firmware", "Overseeing cloud computing systems", "Managing help desk support tickets"], correct: 2 },
            { id: 12, category: "IT Roles", q: "A Network Architect primarily focuses on:", a: "Designing networks, monitoring traffic, installing routers and modems, and upgrading hardware and software", choices: ["Developing mobile applications", "Creating data visualization dashboards", "Managing relational database systems", "Designing networks and monitoring traffic"], correct: 3 },
            { id: 13, category: "IT Roles", q: "Which role designs, builds, and implements security systems within IT networks?", a: "Designing, building, testing, and implementing security systems within an organization's IT network", choices: ["Security Architect", "Developing e-commerce web applications", "Managing software development lifecycles", "Creating business intelligence reports"], correct: 0 },
            { id: 14, category: "IT Roles", q: "An organization employs a Machine Learning Engineer to:", a: "Allows an organization to take full control of its data using Python, R, or Java with machine learning frameworks", choices: ["Repairs and maintains computer hardware", "Enables organizations to leverage data using ML frameworks", "Manages network infrastructure and protocols", "Designs relational database schemas"], correct: 1 },
            { id: 15, category: "IT Roles", q: "Software Engineers design and develop:", a: "Software that makes hardware and software systems work, including operating systems, database systems, and embedded systems", choices: ["Only client-facing web applications", "Only mobile applications for smartphones", "Software for hardware and software systems including OS and databases", "Only video games and entertainment software"], correct: 2 },
            { id: 16, category: "IT Roles", q: "A Computer Support Specialist primarily:", a: "Supporting, monitoring, and maintaining workplace technology and responding to user requests for help", choices: ["Developing enterprise software applications", "Creating machine learning algorithms", "Designing network security architecture", "Supporting and maintaining workplace technology"], correct: 3 },
            { id: 17, category: "IT Roles", q: "A Systems Analyst's primary function is to:", a: "Investigates business problems and creates information systems to provide solutions", choices: ["Investigates business problems and creates IS solutions", "Manages physical IT infrastructure", "Writes low-level operating system code", "Configures network firewalls and routers"], correct: 0 },
            { id: 18, category: "IT Roles", q: "The primary function of a Data Analyst is:", a: "Uses statistical and quantitative methods to gain insights that support organizational decision-making", choices: ["Manages database server administration", "Uses statistics to gain insights for decision-making", "Develops software applications from scratch", "Configures enterprise network systems"], correct: 1 },
            { id: 19, category: "IT Roles", q: "A Security Analyst is characterized by:", a: "Monitors an organization's network for security breaches", choices: ["Develops new encryption algorithms", "Designs database architecture", "Monitors networks for security breaches", "Creates mobile applications"], correct: 2 },
            { id: 20, category: "IT Roles", q: "In IT, a Project Manager is responsible for:", a: "Organizes people, time, and resources to ensure projects meet requirements and are completed on time and within budget", choices: ["Writes code and develops software", "Manages database administration", "Configures network infrastructure", "Organizes resources to complete projects on time and budget"], correct: 3 },

            // Data & Information
            { id: 21, category: "Data & Information", q: "Which describes the difference between data and information?", a: "Data includes raw facts or observations; information is data given context that makes it meaningful", choices: ["Data is raw facts; information is data with context", "Data is analyzed; information is raw and unprocessed", "Information is collected first; data is derived from it", "Data requires interpretation; information does not"], correct: 0 },
            { id: 22, category: "Data & Information", q: "The DIKW pyramid consists of four levels from bottom to top:", a: "Data, Information, Knowledge, Wisdom", choices: ["Data, Knowledge, Information, Wisdom", "Data, Information, Knowledge, Wisdom", "Facts, Information, Understanding, Insight", "Data, Information, Intelligence, Action"], correct: 1 },
            { id: 23, category: "Data & Information", q: "In the DIKW pyramid, knowledge refers to:", a: "A dynamic combination of experience, values, contextual information, expert insight, and grounded intuition", choices: ["Information that has been validated as accurate", "Structured data stored in a database system", "A combination of experience, values, and contextual information", "Raw facts that have been collected and organized"], correct: 2 },
            { id: 24, category: "Data & Information", q: "Wisdom, in the DIKW context, can be described as:", a: "Knowing the right thing to do", choices: ["Having accumulated large amounts of knowledge", "The ability to process information quickly", "Understanding how to collect accurate data", "Knowing the right thing to do"], correct: 3 },
            { id: 25, category: "Data & Information", q: "Structured data is characterized by:", a: "Data coded in a way that makes it easy to convert into a form usable for analysis, such as names, dates, and phone numbers", choices: ["Data easily converted for analysis like names and dates", "Data stored in NoSQL document databases", "Data that follows no predefined schema", "Data stored in uncompressed file formats"], correct: 0 },
            { id: 26, category: "Data & Information", q: "Unstructured data refers to:", a: "Data that is more complex and possibly stored in a format not easily decoded, such as text, videos, and audio", choices: ["Data organized in relational database tables", "Complex data not easily decoded like text and videos", "Data with clearly defined field types", "Data stored in spreadsheet columns"], correct: 1 },
            { id: 27, category: "Data & Information", q: "Big Data can be defined as:", a: "A large collection of data that is incapable of being processed by previous generations of analytical tools", choices: ["Any data stored in cloud infrastructure", "Data that exceeds 1 terabyte in size", "Large data collections requiring advanced analytical tools", "Enterprise data stored in data warehouses"], correct: 2 },
            { id: 28, category: "Data & Information", q: "The purpose of data hygiene is:", a: "The processes of ensuring the cleanliness of data - that it is relatively error-free", choices: ["Encrypting sensitive data for security", "Backing up data to prevent loss", "Compressing data to save storage space", "Processes ensuring data is error-free"], correct: 3 },
            { id: 29, category: "Data & Information", q: "Data scrubbing involves:", a: "The process of amending or removing data that is incorrect, incomplete, improperly formatted, or duplicated", choices: ["Amending or removing incorrect/incomplete data", "Permanently deleting data for compliance", "Converting data between different formats", "Transferring data between systems"], correct: 0 },
            { id: 30, category: "Data & Information", q: "The five quality data attributes are:", a: "Precise, valid, reliable, timely, and complete", choices: ["Accessible, secure, backed-up, indexed, normalized", "Precise, valid, reliable, timely, complete", "Encrypted, compressed, deduplicated, archived, replicated", "Structured, unstructured, semi-structured, metadata, binary"], correct: 1 },
            { id: 31, category: "Data & Information", q: "IaaS (Infrastructure as a Service) provides:", a: "A cloud model providing access in a virtualized environment with computing resources like network connections and virtual server space", choices: ["Cloud-hosted development tools and runtime environments for building apps", "Ready-to-use software applications delivered over the internet", "Virtual servers, storage, and networking resources on demand", "Managed container orchestration and serverless computing"], correct: 2 },
            { id: 32, category: "Data & Information", q: "What is PaaS (Platform as a Service)?", a: "A cloud model where customers access a platform supporting development and management of web applications", choices: ["Raw compute, storage, and networking resources you manage yourself", "Complete applications accessed through a web browser", "Managed databases and analytics services only", "Development frameworks and tools for building applications"], correct: 3 },
            { id: 33, category: "Data & Information", q: "What is SaaS (Software as a Service)?", a: "A model where software is licensed to customers with subscriptions and central hosting, like Gmail or Office 365", choices: ["Ready-to-use applications accessed via browser or API", "Virtual infrastructure resources like servers and storage", "Development environments and deployment pipelines", "Managed container and microservices platforms"], correct: 0 },
            { id: 34, category: "Data & Information", q: "What is personally identifiable information (PII)?", a: "Sensitive data including social security numbers, names, and telephone numbers that could identify an individual", choices: ["Anonymized data used for analytics", "Sensitive data that could identify an individual", "Encrypted corporate financial records", "Aggregated demographic statistics"], correct: 1 },

            // Computer Hardware
            { id: 35, category: "Hardware", q: "What are the four functions of a computer system according to IPOS?", a: "Input, Process, Output, Storage", choices: ["Input, Parse, Output, Store", "Initialize, Process, Operate, Save", "Input, Process, Output, Storage", "Input, Program, Output, System"], correct: 2 },
            { id: 36, category: "Hardware", q: "What is the CPU responsible for?", a: "Processing all information from programs and executing computer program instructions", choices: ["Storing data in volatile memory temporarily", "Managing network communications", "Rendering graphics and visual output", "Processing information and executing instructions"], correct: 3 },
            { id: 37, category: "Hardware", q: "What are the three parts of a CPU?", a: "Arithmetic Logic Unit (ALU), Control Unit, and Processor Registers", choices: ["ALU, Control Unit, Processor Registers", "Cache, Core, and Clock multiplier", "L1 Cache, L2 Cache, L3 Cache", "Northbridge, Southbridge, Memory Controller"], correct: 0 },
            { id: 38, category: "Hardware", q: "What does RAM stand for and what does it do?", a: "Random Access Memory - temporarily stores information created by programs for immediate access", choices: ["Read-only Access Memory - stores firmware permanently", "Random Access Memory - temporary storage for immediate access", "Rapid Application Memory - accelerates program execution", "Remote Access Memory - enables network data storage"], correct: 1 },
            { id: 39, category: "Hardware", q: "What is the difference between RAM and ROM?", a: "RAM is volatile (loses data when powered off) while ROM is non-volatile (retains data when powered off)", choices: ["RAM is slower but larger; ROM is faster but smaller", "RAM stores firmware; ROM stores user data", "RAM is volatile; ROM is non-volatile", "RAM is read-only; ROM is read-write"], correct: 2 },
            { id: 40, category: "Hardware", q: "What is the motherboard?", a: "The main circuit board containing both soldered components and sockets for removable components like CPU and RAM", choices: ["The processor that controls all computations", "The power supply unit for the computer", "The primary storage device for the operating system", "The main circuit board holding CPU, RAM, and other components"], correct: 3 },
            { id: 41, category: "Hardware", q: "What is a GPU (Graphics Processing Unit)?", a: "A processor that handles graphic data processing, especially important for 3D rendering", choices: ["A processor for handling graphic data and 3D rendering", "The main processor that runs all computer programs", "A type of high-speed volatile memory", "A controller for peripheral input devices"], correct: 0 },
            { id: 42, category: "Hardware", q: "What is the difference between HDD and SSD?", a: "HDD uses spinning magnetic disks (platters) while SSD uses static flash memory chips with no moving parts", choices: ["HDD is volatile memory; SSD is non-volatile", "HDD uses magnetic platters; SSD uses flash memory", "SSD uses spinning disks; HDD uses flash memory", "HDD stores more data; SSD cannot be partitioned"], correct: 1 },
            { id: 43, category: "Hardware", q: "What is a bit?", a: "The smallest unit of storage, set to either 0 or 1", choices: ["A group of 4 binary digits", "One eighth of a byte", "The smallest storage unit (0 or 1)", "A unit equal to 8 binary values"], correct: 2 },
            { id: 44, category: "Hardware", q: "What is a byte?", a: "A group of 8 bits, containing enough information to store a single character", choices: ["A single binary digit (0 or 1)", "A quarter of a kilobyte", "A unit of 1024 bits", "8 bits - enough to store one character"], correct: 3 },
            { id: 45, category: "Hardware", q: "How many bytes are in a kilobyte (KB)?", a: "1,024 bytes (2^10)", choices: ["1,024 bytes", "1,000 bytes (decimal)", "512 bytes", "2,048 bytes"], correct: 0 },
            { id: 46, category: "Hardware", q: "How many megabytes are in a gigabyte (GB)?", a: "1,024 MB", choices: ["1,000 MB (decimal)", "1,024 MB", "512 MB", "2,048 MB"], correct: 1 },
            { id: 47, category: "Hardware", q: "What characterized first-generation computers (1946-1959)?", a: "Vacuum tubes for circuitry and magnetic drums for memory; large, expensive, generated excessive heat", choices: ["Transistors and magnetic core memory", "Integrated circuits on silicon chips", "Vacuum tubes and magnetic drums", "Microprocessors and semiconductor memory"], correct: 2 },
            { id: 48, category: "Hardware", q: "What characterized second-generation computers (1959-1965)?", a: "Transistors replaced vacuum tubes; smaller, more reliable, used assembly and high-level languages", choices: ["Vacuum tubes and punch card input", "Single-chip microprocessors", "Integrated circuits combining multiple transistors", "Transistors replacing vacuum tubes"], correct: 3 },
            { id: 49, category: "Hardware", q: "What characterized third-generation computers (1965-1971)?", a: "Integrated circuits on silicon chips; cheaper, faster, smaller; could run multiple applications", choices: ["Integrated circuits on silicon chips", "Discrete transistors on circuit boards", "Vacuum tubes and magnetic drum memory", "VLSI microprocessors with millions of transistors"], correct: 0 },
            { id: 50, category: "Hardware", q: "What characterized fourth-generation computers (1971-present)?", a: "Microprocessors with thousands of integrated circuits on a single chip; personal computers emerged", choices: ["Vacuum tubes as primary components", "Microprocessors on single chips", "Small-scale integrated circuits", "Individual transistors wired together"], correct: 1 },
            { id: 51, category: "Hardware", q: "What are the three types of buses in a computer?", a: "Address bus, Data bus, and Control bus", choices: ["System bus, Expansion bus, Local bus", "PCI bus, USB bus, SATA bus", "Address bus, Data bus, Control bus", "Front-side bus, Back-side bus, Memory bus"], correct: 2 },
            { id: 52, category: "Hardware", q: "What does the system clock do?", a: "Sends out pulses of electricity at regular intervals that electronic components need to operate; measured in MHz or GHz", choices: ["Maintains the current date and time for the OS", "Controls the timing of data writes to storage", "Measures CPU temperature and adjusts fan speed", "Sends electrical pulses for component operation"], correct: 3 },
            { id: 53, category: "Hardware", q: "What is an expansion slot?", a: "A socket on the motherboard where expansion cards (graphics, sound, network) can be installed", choices: ["A socket for installing expansion cards", "A memory slot for installing RAM modules", "A connector for external USB devices", "A slot for inserting storage drives"], correct: 0 },
            { id: 54, category: "Hardware", q: "What is the keyboard classified as?", a: "An input device - it translates data into a form the computer can understand", choices: ["An output device that displays text", "Input device", "A storage device for keystrokes", "A processing device for text"], correct: 1 },
            { id: 55, category: "Hardware", q: "What are monitors and printers classified as?", a: "Output devices - they translate information into a form humans can understand", choices: ["Input devices for capturing visual data", "Storage devices for display data", "Output devices", "Processing devices for rendering"], correct: 2 },
            { id: 56, category: "Hardware", q: "What is a supercomputer?", a: "The biggest and fastest computers, designed to process huge amounts of data using thousands of interconnected processors", choices: ["A high-end workstation for professional use", "A personal computer with enhanced graphics", "A server with redundant components", "The biggest/fastest computers for processing huge data"], correct: 3 },
            { id: 57, category: "Hardware", q: "What is a mainframe computer?", a: "A computer designed to support hundreds or thousands of users simultaneously and multiple programs at once", choices: ["A computer supporting hundreds/thousands of users simultaneously", "A powerful single-user workstation", "A cluster of standard PCs networked together", "A computer optimized for scientific calculations"], correct: 0 },
            { id: 58, category: "Hardware", q: "What is a workstation?", a: "A single-user computer designed for technical or scientific applications with faster processors and more RAM", choices: ["A multi-user server for enterprise applications", "A single-user computer for technical/scientific work", "A basic PC for home use", "A mobile computing device"], correct: 1 },

            // Networking
            { id: 59, category: "Networking", q: "Which network type spans a single building or campus?", a: "A network spanning a single building or building complex, connecting devices within the same location", choices: ["MAN (Metropolitan Area Network)", "VPN (Virtual Private Network)", "LAN (Local Area Network)", "WAN (Wide Area Network)"], correct: 2 },
            { id: 60, category: "Networking", q: "Which network type reaches across cities, states, or countries?", a: "A network that reaches across cities, states, or even across the world; the internet is the largest WAN", choices: ["LAN (Local Area Network)", "PAN (Personal Area Network)", "MAN (Metropolitan Area Network)", "WAN (Wide Area Network)"], correct: 3 },
            { id: 61, category: "Networking", q: "Which network type connects devices within a few feet, like wireless headphones to a phone?", a: "A network used for short-range communications within a few feet, like wireless headphones to a smartphone", choices: ["PAN (Personal Area Network)", "MAN (Metropolitan Area Network)", "LAN (Local Area Network)", "WAN (Wide Area Network)"], correct: 0 },
            { id: 62, category: "Networking", q: "Which topology connects devices to a shared communication line?", a: "A topology where machines are connected to a common communication line called a bus", choices: ["Ring topology", "Bus topology", "Star topology", "Mesh topology"], correct: 1 },
            { id: 63, category: "Networking", q: "Which topology connects all devices to a single central point?", a: "A topology with a single machine serving as a central point to which all others are connected", choices: ["Ring topology", "Bus topology", "Star topology", "Mesh topology"], correct: 2 },
            { id: 64, category: "Networking", q: "Which topology connects devices in a continuous loop?", a: "A topology where devices connect directly to each other as peers in a circular arrangement", choices: ["Bus topology", "Star topology", "Mesh topology", "Ring topology"], correct: 3 },
            { id: 65, category: "Networking", q: "Which topology connects every device to every other device for redundancy?", a: "A topology connecting every device to every other device, enabling redundancy", choices: ["Mesh topology", "Bus topology", "Star topology", "Ring topology"], correct: 0 },
            { id: 66, category: "Networking", q: "What is the client/server model?", a: "A model where clients make requests and servers satisfy those requests", choices: ["All devices share equal responsibilities", "Requesters send queries to centralized providers for resources", "Devices communicate without any hierarchy", "Multiple servers compete to serve requests"], correct: 1 },
            { id: 67, category: "Networking", q: "What is peer-to-peer (P2P) networking?", a: "A model where processes both request and provide services to each other, like instant messaging", choices: ["A dedicated server handles all requests", "Only receiving data is possible", "Processes both request and provide services", "A hierarchical network structure"], correct: 2 },
            { id: 68, category: "Networking", q: "What is TCP/IP?", a: "The most popular protocol for network communication, commonly found on the internet and home networks", choices: ["A physical network interface standard", "A wireless networking standard", "A type of network cabling", "The most popular network communication protocol"], correct: 3 },
            { id: 69, category: "Networking", q: "What is twisted pair cable?", a: "The most widely used transmission media; two insulated copper wires wound around each other", choices: ["Two insulated copper wires wound together", "A single copper conductor with shielding", "Glass fiber transmitting light signals", "A coaxial cable with inner and outer conductors"], correct: 0 },
            { id: 70, category: "Networking", q: "What is the maximum segment length for twisted pair cable?", a: "100 meters (328 feet)", choices: ["50 meters (164 feet)", "100 meters (328 feet)", "200 meters (656 feet)", "500 meters (1640 feet)"], correct: 1 },
            { id: 71, category: "Networking", q: "What minimum cable category is required for 1 Gbps?", a: "CAT5e", choices: ["CAT3", "CAT5", "CAT5e", "CAT4"], correct: 2 },
            { id: 72, category: "Networking", q: "What is fiber-optic cable?", a: "Cable using light reflection through a glass or plastic core; can provide up to 26,000 times the bandwidth of twisted pair", choices: ["Copper cable with improved shielding", "Enhanced coaxial cable design", "High-frequency radio transmission", "Cable using light through glass/plastic core"], correct: 3 },
            { id: 73, category: "Networking", q: "What does a repeater do?", a: "Extends the range of cabling by increasing the strength of the network signal", choices: ["Extends cable range by increasing signal strength", "Filters network traffic by MAC address", "Routes packets between different networks", "Connects different network protocols"], correct: 0 },
            { id: 74, category: "Networking", q: "What does a bridge do in networking?", a: "Connects different types of networks and only bridges messages addressed to devices on the other side", choices: ["Amplifies signals without filtering", "Connects different network types intelligently", "Routes traffic between subnets", "Provides wireless access points"], correct: 1 },
            { id: 75, category: "Networking", q: "What does a switch do?", a: "Reduces network traffic on LANs by sending messages only to the destination device instead of all devices", choices: ["Forwards packets between different IP networks using routing tables", "Connects network segments and forwards frames based on IP addresses", "Sends frames only to the specific port for the destination MAC address", "Regenerates and retimes network signals to extend cable distances"], correct: 2 },
            { id: 76, category: "Networking", q: "What does a router do?", a: "Makes the internet possible by forwarding messages between networks using routing tables", choices: ["Forwards frames to ports based on MAC address tables", "Segments collision domains within a single broadcast domain", "Extends network range by regenerating electrical signals", "Forwards packets between networks using IP routing tables"], correct: 3 },
            { id: 77, category: "Networking", q: "What are the three tiers of ISPs?", a: "Tier 1 (backbone), Tier 2 (regional), Tier 3 (access ISPs for homes/businesses)", choices: ["Tier 1 backbone, Tier 2 regional, Tier 3 access", "Enterprise, Business, Consumer tiers", "High-speed, Medium-speed, Low-speed tiers", "Fiber, Cable, DSL tiers"], correct: 0 },
            { id: 78, category: "Networking", q: "What is cluster computing?", a: "Using many independent computers to provide computation comparable to a larger machine", choices: ["A single powerful supercomputer", "Many independent computers working together", "Virtual machines on one physical host", "Remote desktop computing"], correct: 1 },
            { id: 79, category: "Networking", q: "What is grid computing?", a: "A distributed system more loosely coupled than clusters, working together to complete large tasks", choices: ["Tightly coupled computers in one location", "A single mainframe computer", "Loosely coupled systems completing large tasks together", "Virtual machine clusters"], correct: 2 },
            { id: 80, category: "Networking", q: "What is cloud computing?", a: "Large pools of shared computers allocated to clients as needed, like Amazon's EC2", choices: ["Dedicated on-premises servers", "Mainframe time-sharing systems", "Personal computers networked together", "Shared computers allocated to clients as needed"], correct: 3 },

            // Internet & Web
            { id: 81, category: "Internet", q: "What does DNS stand for and what does it do?", a: "Domain Name System - translates human-readable domain names into IP addresses", choices: ["Domain Name System - converts website names to numeric addresses", "Dynamic Network Service - manages network connections", "Data Naming Standard - organizes file names", "Distributed Node System - manages server clusters"], correct: 0 },
            { id: 82, category: "Internet", q: "What is an IP address?", a: "A unique identifier assigned to each machine on a network; IPv4 uses 32-bit, IPv6 uses 128-bit", choices: ["A domain name like google.com", "A unique network identifier for machines", "A MAC address assigned by manufacturers", "A port number for applications"], correct: 1 },
            { id: 83, category: "Internet", q: "How are IPv4 addresses written?", a: "In dotted decimal notation with bytes separated by periods (e.g., 192.207.177.103)", choices: ["In hexadecimal with colons like IPv6", "In pure binary format only", "In dotted decimal notation like 192.207.177.103", "In domain name format only"], correct: 2 },
            { id: 84, category: "Internet", q: "What is a URL?", a: "Uniform Resource Locator - the unique address of a web document including protocol, domain, and path", choices: ["Universal Routing Language - a network protocol", "User Request Link - a browser feature", "Unified Record Locator - a database term", "Uniform Resource Locator - web address with protocol, domain, and path"], correct: 3 },
            { id: 85, category: "Internet", q: "What does HTTP stand for?", a: "HyperText Transfer Protocol - the protocol for transferring hypertext over networks", choices: ["HyperText Transfer Protocol - used by browsers to fetch web pages", "Hyperlink Text Transport Protocol - links documents together", "Host Terminal Transfer Process - manages server connections", "Hybrid Text Transmission Protocol - combines text formats"], correct: 0 },
            { id: 86, category: "Internet", q: "What is HTML?", a: "HyperText Markup Language - a way of encoding documents with tags describing appearance and links", choices: ["Hosted Text Management Layer - a server-side technology", "HyperText Markup Language - tag-based language for web pages", "Hierarchical Template Modeling Language - for data structures", "High-level Text Manipulation Logic - a scripting approach"], correct: 1 },
            { id: 87, category: "Internet", q: "Who invented the World Wide Web?", a: "Tim Berners-Lee in the late 1980s", choices: ["Vint Cerf", "Steve Wozniak", "Tim Berners-Lee", "Marc Andreessen"], correct: 2 },
            { id: 88, category: "Internet", q: "What is VoIP?", a: "Voice over Internet Protocol - used for voice communication over the internet", choices: ["Video over Internet Protocol - streams visual content online", "Verified Online Identity Protocol - authenticates users", "Virtual Operating Internet Platform - hosts cloud services", "Voice over Internet Protocol - enables phone calls via internet"], correct: 3 },
            { id: 89, category: "Internet", q: "What is streaming?", a: "Transporting audio and video data across the internet in near real-time", choices: ["Transporting audio/video in near real-time", "Downloading complete files before playback", "Uploading content to servers", "Compressing media for storage"], correct: 0 },
            { id: 90, category: "Internet", q: "What is ICANN responsible for?", a: "Internet Corporation for Assigned Names and Numbers - coordinates internet operations and awards IP address blocks to ISPs", choices: ["Developing web standards and protocols", "Coordinating internet operations and IP addresses", "Regulating internet service providers", "Managing internet security threats"], correct: 1 },
            { id: 91, category: "Internet", q: "What does the TLD '.edu' indicate?", a: "An educational institution", choices: ["A commercial business", "A government agency", "An educational institution", "A nonprofit organization"], correct: 2 },
            { id: 92, category: "Internet", q: "What does the TLD '.gov' indicate?", a: "A government agency", choices: ["An educational institution", "A commercial business", "A nonprofit organization", "A government agency"], correct: 3 },

            // Security
            { id: 93, category: "Security", q: "What is malware?", a: "Malicious software intentionally designed to cause damage to a computer, server, client, or network", choices: ["Malicious software designed to cause damage", "Software with unintentional bugs", "Outdated software needing updates", "Beta software in testing"], correct: 0 },
            { id: 94, category: "Security", q: "What is a computer virus?", a: "Software that infects a computer by inserting itself into existing programs and executes when the host program runs", choices: ["Self-replicating malware that spreads across networks without user action", "Malware that attaches to host programs and runs when they execute", "Malware disguised as legitimate software to trick users into installing it", "Malware that encrypts files and demands payment for decryption"], correct: 1 },
            { id: 95, category: "Security", q: "What is a worm?", a: "An autonomous program that forwards copies of itself to other machines in a network", choices: ["Malware that requires attaching to executable files to spread", "Malware that appears legitimate but contains hidden malicious code", "Self-propagating malware that spreads without needing a host program", "Malware that records keystrokes and sends them to attackers"], correct: 2 },
            { id: 96, category: "Security", q: "What is spyware?", a: "Malicious software that resides on a computer, collecting information and reporting back to its creator", choices: ["Malware that displays unwanted advertisements in browsers", "Malware that encrypts user files and demands ransom", "Malware that replicates itself across network connections", "Malware that secretly monitors activity and exfiltrates data"], correct: 3 },
            { id: 97, category: "Security", q: "What is phishing?", a: "A technique to obtain private information by posing as a legitimate business and asking for it", choices: ["Posing as legitimate to obtain private information", "Scanning networks for vulnerabilities", "Intercepting encrypted communications", "Overloading servers with requests"], correct: 0 },
            { id: 98, category: "Security", q: "What is a denial-of-service (DoS) attack?", a: "The process of overloading a computer with messages, suffocating network resources", choices: ["Stealing user credentials through deception", "Overloading a computer to suffocate resources", "Intercepting data between two parties", "Guessing passwords through trial and error"], correct: 1 },
            { id: 99, category: "Security", q: "What is a man-in-the-middle (MITM) attack?", a: "An attack where the attacker intercepts data traveling to or from a victim's device", choices: ["Overwhelming a server with traffic", "Trying all password combinations", "Intercepting data between victim and destination", "Injecting malicious code into websites"], correct: 2 },
            { id: 100, category: "Security", q: "Which attack systematically tries every possible character combination to crack passwords?", a: "An attack using all possible character combinations to learn a user's password", choices: ["Rainbow table attack", "Dictionary attack", "Phishing attack", "Brute force attack"], correct: 3 },
            { id: 101, category: "Security", q: "Which attack uses wordlists of common terms and phrases to guess passwords?", a: "An attack trying hundreds or thousands of words from a dictionary file to identify passwords", choices: ["Dictionary attack", "Brute force attack", "Rainbow table attack", "SQL injection attack"], correct: 0 },
            { id: 102, category: "Security", q: "What is a firewall?", a: "A program that filters traffic passing through a point in the network, blocking suspicious messages", choices: ["A system that detects and alerts on suspicious network activity", "A barrier that filters traffic based on security rules", "Software that scans files for known malware signatures", "A tool that encrypts data in transit between endpoints"], correct: 1 },
            { id: 103, category: "Security", q: "What is a proxy server?", a: "Software that acts as an intermediary between client and server to shield the client from adverse actions", choices: ["A firewall blocking network traffic", "A VPN encrypting all traffic", "An intermediary protecting clients from server threats", "A load balancer distributing requests"], correct: 2 },
            { id: 104, category: "Security", q: "What is encryption?", a: "Encoding information to keep it confidential even if stolen", choices: ["Compressing data to save space", "Backing up data for recovery", "Hashing data for verification", "Encoding information to keep it confidential"], correct: 3 },
            { id: 105, category: "Security", q: "What is network auditing software?", a: "Software that monitors network behaviors looking for anomalies to proactively mitigate unwanted occurrences", choices: ["Software monitoring networks for anomalies", "Software that blocks malicious traffic", "Antivirus software scanning files", "Encryption software protecting data"], correct: 0 },

            // Operating Systems
            { id: 106, category: "Operating Systems", q: "What is an operating system?", a: "Software that manages computer hardware and software resources and provides common services for programs", choices: ["The CPU that processes instructions", "Software managing hardware/software resources", "The BIOS firmware on the motherboard", "Application software like web browsers"], correct: 1 },
            { id: 107, category: "Operating Systems", q: "What are the four categories of operating systems?", a: "Network OS, Server OS, Mobile OS, and Personal Computer OS", choices: ["Real-time, Batch, Distributed, Embedded", "Single-user, Multi-user, Single-task, Multi-task", "Network, Server, Mobile, Personal Computer", "Desktop, Laptop, Tablet, Smartphone"], correct: 2 },
            { id: 108, category: "Operating Systems", q: "What is Windows?", a: "A closed-source operating system developed by Microsoft with the largest market share for servers and PCs", choices: ["An open-source OS based on Unix", "A mobile-only operating system", "A Unix-based system like macOS", "Closed-source OS by Microsoft with largest market share"], correct: 3 },
            { id: 109, category: "Operating Systems", q: "What is macOS?", a: "A closed-source operating system developed by Apple, designed to run only on Apple hardware", choices: ["Closed-source OS by Apple for Apple hardware", "An open-source Unix derivative", "A Linux distribution for desktops", "A Windows-compatible system"], correct: 0 },
            { id: 110, category: "Operating Systems", q: "What is Linux?", a: "An open-source operating system that can be modified and distributed by anyone; has many distributions (flavors)", choices: ["Closed-source like Windows", "Open-source OS with many distributions", "Made by Apple for servers", "A proprietary Unix system"], correct: 1 },
            { id: 111, category: "Operating Systems", q: "What is Android?", a: "An open-source mobile operating system allowing OEMs to customize it; has the largest mobile user base", choices: ["A closed-source mobile OS by Apple", "A desktop operating system", "Open-source mobile OS with largest user base", "A proprietary OS by Samsung"], correct: 2 },
            { id: 112, category: "Operating Systems", q: "What is iOS?", a: "Apple's proprietary mobile operating system designed for Apple hardware only", choices: ["An open-source mobile OS", "An Android variant for Apple", "A mobile version of macOS", "Apple's proprietary mobile OS for Apple devices"], correct: 3 },
            { id: 113, category: "Operating Systems", q: "What is the kernel?", a: "The internal part of an operating system containing components that perform basic functions", choices: ["The internal core of an OS performing basic functions", "The graphical user interface", "The file system structure", "The device driver collection"], correct: 0 },
            { id: 114, category: "Operating Systems", q: "What is a file manager?", a: "An OS component that coordinates storage, maintains file records, controls access, and manages available space", choices: ["The memory management system", "An OS component managing files and storage", "The process scheduler", "The network stack"], correct: 1 },
            { id: 115, category: "Operating Systems", q: "What is utility software?", a: "Software that extends the capabilities of an operating system, like compression or network communication tools", choices: ["Core kernel components", "Device driver software", "Software extending OS capabilities", "System BIOS firmware"], correct: 2 },
            { id: 116, category: "Operating Systems", q: "What is the difference between CLI and GUI?", a: "CLI (Command Line Interface) uses text commands; GUI (Graphical User Interface) uses visual elements and input devices", choices: ["CLI is faster; GUI is more accurate", "CLI is newer; GUI is older technology", "CLI requires more RAM; GUI requires more storage", "CLI uses text; GUI uses visual elements"], correct: 3 },
            { id: 117, category: "Operating Systems", q: "What is a device driver?", a: "Software that communicates with controllers or peripheral devices, translating generic requests into technical steps", choices: ["Software enabling communication with peripherals", "The physical controller on the device", "The cable connecting devices", "The port on the motherboard"], correct: 0 },
            { id: 118, category: "Operating Systems", q: "What is virtual memory?", a: "Additional memory space created in secondary memory by paging when more main memory is needed", choices: ["RAM installed in the computer", "Additional memory created by paging to secondary storage", "Cache memory in the CPU", "Read-only memory for firmware"], correct: 1 },
            { id: 119, category: "Operating Systems", q: "What is paging?", a: "A technique where the OS rotates programs and data between primary and secondary memory", choices: ["Allocating memory in fixed blocks", "Caching frequently used data", "Rotating programs between primary and secondary memory", "Defragmenting the hard drive"], correct: 2 },
            { id: 120, category: "Operating Systems", q: "In Windows, what character separates directory paths?", a: "Backward slash (\\)", choices: ["Forward slash (/)", "Semicolon (;)", "Colon (:)", "Backward slash (\\)"], correct: 3 },
            { id: 121, category: "Operating Systems", q: "In Linux, what character separates directory paths?", a: "Forward slash (/)", choices: ["Forward slash (/)", "Backward slash (\\)", "Colon (:)", "Semicolon (;)"], correct: 0 },
            { id: 122, category: "Operating Systems", q: "Is Linux case-sensitive for file names?", a: "Yes, Linux is case-sensitive", choices: ["No, Linux ignores case", "Yes, Linux is case-sensitive", "Only for executable files", "Only in the home directory"], correct: 1 },

            // Programming
            { id: 123, category: "Programming", q: "What is source code?", a: "Computer programs written in high-level language that humans can understand", choices: ["Compiled executable files", "Binary machine instructions", "Human-readable code in high-level languages", "Assembly language mnemonics"], correct: 2 },
            { id: 124, category: "Programming", q: "What is machine code?", a: "Programs written in binary (0s and 1s) that computers can directly execute", choices: ["High-level source code", "Pseudocode algorithms", "Interpreted script files", "Binary code (0s and 1s) computers execute directly"], correct: 3 },
            { id: 125, category: "Programming", q: "What does a compiler do?", a: "Translates entire source code into machine language at once, checking for errors before translation", choices: ["Converts all source code to executable machine code before running", "Translates and executes source code one statement at a time", "Checks syntax without producing executable output", "Links object files together into a single executable"], correct: 0 },
            { id: 126, category: "Programming", q: "What does an interpreter do?", a: "Translates and executes source code into machine language one line at a time", choices: ["Converts entire program to machine code before execution begins", "Translates and runs code one statement at a time during execution", "Combines multiple object files into a single executable", "Converts bytecode into native machine instructions"], correct: 1 },
            { id: 127, category: "Programming", q: "Which languages use compilers?", a: "C, C++, C#, Java, Go/GoLang, Visual Basic .NET", choices: ["Python, JavaScript, PHP, Ruby", "Perl, TCL, Bash, PowerShell", "C, C++, C#, Java, Go", "HTML, CSS, SQL, XML"], correct: 2 },
            { id: 128, category: "Programming", q: "Which languages use interpreters?", a: "Python, Perl, JavaScript, PHP, TCL, Ruby", choices: ["C, C++, C#, Go", "Assembly, COBOL, Fortran", "Java, Kotlin, Swift, Rust", "Python, Perl, JavaScript, PHP"], correct: 3 },
            { id: 129, category: "Programming", q: "What is an algorithm?", a: "A step-by-step formula or set of instructions outlining how to execute a task", choices: ["Step-by-step instructions for executing a task", "A specific programming language syntax", "A compiled executable program", "A debugging tool for code"], correct: 0 },
            { id: 130, category: "Programming", q: "What is debugging?", a: "The process of finding and fixing errors in code", choices: ["Adding new features to code", "Finding and fixing code errors", "Compiling source code", "Documenting code functionality"], correct: 1 },

            // Licensing & IP
            { id: 131, category: "Licensing", q: "Which license type allows anyone to modify and distribute the software with accessible source code?", a: "Software that can be modified and distributed by anyone, with accessible source code", choices: ["Proprietary software", "Commercial software", "Open-source software", "Public domain software"], correct: 2 },
            { id: 132, category: "Licensing", q: "Which license type restricts code modification to only the owning company?", a: "Software where only the owning company can modify the code", choices: ["Open-source software", "Public domain software", "Freeware", "Proprietary software"], correct: 3 },
            { id: 133, category: "Licensing", q: "Which license type provides trial software with time or feature limitations?", a: "An application installed as a trial limited by time and/or functionality", choices: ["Shareware", "Public domain software", "Open-source software", "Freeware"], correct: 0 },
            { id: 134, category: "Licensing", q: "Which license type provides free software protected by EULA and copyright?", a: "Free software protected by EULA and copyright laws", choices: ["Shareware", "Freeware", "Public domain software", "Open-source software"], correct: 1 },
            { id: 135, category: "Licensing", q: "What is public domain software?", a: "Software with no EULA and no intellectual property protections, available for anyone to use", choices: ["Software protected by copyright", "Software requiring license fees", "Software with no EULA or IP protections", "Open-source with GPL restrictions"], correct: 2 },
            { id: 136, category: "Licensing", q: "What is a EULA?", a: "End-User License Agreement - defines terms and conditions for legally using software", choices: ["Extended Utility License Application - grants extra permissions", "Encrypted User Login Access - secures authentication", "Enterprise Unified Licensing Arrangement - covers organizations", "End-User License Agreement - defines software usage terms"], correct: 3 },
            { id: 137, category: "Licensing", q: "What is copyright?", a: "Legal protection giving an author the ability to prevent unauthorized duplication for at least 35 years", choices: ["Legal protection against unauthorized duplication", "A license to freely copy software", "A type of software patent", "Permission to modify source code"], correct: 0 },
            { id: 138, category: "Licensing", q: "What does a patent protect in software?", a: "Unique methods, algorithms, or processes embedded within software applications", choices: ["The source code itself", "Unique methods, algorithms, or processes", "The user interface design", "The software's brand name"], correct: 1 },
            { id: 139, category: "Licensing", q: "What is bespoke software?", a: "Custom-made software specifically designed and developed for an organization", choices: ["Generic software for mass market", "Open-source community software", "Custom software made for a specific organization", "Pre-packaged enterprise solutions"], correct: 2 },
            { id: 140, category: "Licensing", q: "What is off-the-shelf software?", a: "Software providing general features useful to a broad range of users, not customizable", choices: ["Custom-developed enterprise software", "Software built to specific requirements", "Open-source modifiable software", "General software for broad use, not customizable"], correct: 3 },

            // Databases
            { id: 141, category: "Databases", q: "What is a database?", a: "An organized collection of data stored and maintained by an organization, integrated across systems", choices: ["An organized collection of integrated data", "A single spreadsheet file", "A data backup system", "A file storage system"], correct: 0 },
            { id: 142, category: "Databases", q: "What is a DBMS?", a: "Database Management System - software that manages the database and handles queries from applications", choices: ["A type of database model", "Software managing databases and handling queries", "A query language like SQL", "A database backup tool"], correct: 1 },
            { id: 143, category: "Databases", q: "What is a record in a database?", a: "A row in a table containing related information about a single entity", choices: ["A column containing one data type", "The entire database table", "A row containing related information", "A relationship between tables"], correct: 2 },
            { id: 144, category: "Databases", q: "What is a field in a database?", a: "A column containing a single piece of data about the subject of a record", choices: ["A complete row of data", "A table relationship", "A database index", "A column with a single piece of data"], correct: 3 },
            { id: 145, category: "Databases", q: "What is a primary key?", a: "A unique identifier for each record in a table that creates relationships among tables", choices: ["A field that uniquely identifies each record in a table", "A field that references the primary key of another table", "A data structure that speeds up query performance", "A constraint that ensures values in a column are not null"], correct: 0 },
            { id: 146, category: "Databases", q: "What is a foreign key?", a: "A field in one table that refers to the primary key in another table, creating a relationship", choices: ["A field that uniquely identifies each record within its own table", "A field that references the primary key of a different table", "A composite key made from multiple columns combined", "A candidate key that was not chosen as the primary key"], correct: 1 },
            { id: 147, category: "Databases", q: "Which database type stores data in plain text with one record per line?", a: "A database storing data in a plain text file with one record per line, using delimiters", choices: ["Relational database", "Hierarchical database", "Flat-file database", "Graph database"], correct: 2 },
            { id: 148, category: "Databases", q: "Which database type organizes data in a tree structure with parent-child relationships?", a: "A database with data organized in a tree structure with parent-child relationships", choices: ["Flat-file database", "Document database", "Relational database", "Hierarchical database"], correct: 3 },
            { id: 149, category: "Databases", q: "Which database type uses tables joined together via primary and foreign keys?", a: "A database containing tables that can be joined together using primary and foreign keys", choices: ["Relational database", "Flat-file database", "Hierarchical database", "Key-value database"], correct: 0 },
            { id: 150, category: "Databases", q: "What is SQL?", a: "Structured Query Language - code used to query, manipulate, and manage relational databases", choices: ["A general-purpose programming language", "Language for querying and managing databases", "A NoSQL query format", "A database modeling notation"], correct: 1 },
            { id: 151, category: "Databases", q: "What does SELECT * FROM Patient mean in SQL?", a: "Retrieve all fields from all records in the Patient table", choices: ["Delete all records from Patient table", "Insert a new record into Patient", "Retrieve all data from Patient table", "Update all records in Patient"], correct: 2 },
            { id: 152, category: "Databases", q: "What does the WHERE clause do in SQL?", a: "Specifies conditions for filtering which records to return", choices: ["Sorts the results in order", "Joins tables together", "Groups records by a field", "Filters records based on conditions"], correct: 3 },
            { id: 153, category: "Databases", q: "What is NoSQL?", a: "Not Only SQL - databases accommodating various data models including key-value, document, and graph formats", choices: ["Databases with various models beyond traditional SQL", "Databases that don't use any queries", "A newer version of SQL syntax", "Relational databases without tables"], correct: 0 },
            { id: 154, category: "Databases", q: "What is a cloud database?", a: "A database optimized for cloud environments with scalability and high availability", choices: ["A database storing weather data", "A remotely-hosted DB with elastic scaling and high availability", "An on-premises database server", "A local SQLite database"], correct: 1 },
            { id: 155, category: "Databases", q: "What is a data lake?", a: "A system storing data in raw format, including both structured and unstructured enterprise data", choices: ["A normalized relational database", "A data warehouse with processed data", "Storage for raw structured and unstructured data", "A backup and recovery system"], correct: 2 },
            { id: 156, category: "Databases", q: "What are DBA responsibilities?", a: "Database security, tuning, high availability, business continuity, backup/recovery, reporting, and development", choices: ["Only performing backups", "Only managing user accounts", "Only writing SQL queries", "Security, tuning, availability, backup, reporting, development"], correct: 3 },

            // Project Management
            { id: 157, category: "Project Management", q: "What is a project?", a: "A purpose-driven event with a defined start and finish", choices: ["A purpose-driven event with defined start and finish", "Continuous operational work", "Ongoing maintenance activities", "Regular business operations"], correct: 0 },
            { id: 158, category: "Project Management", q: "What are the four phases of the project management life cycle?", a: "Initiation, Planning, Execution, and Closure", choices: ["Analysis, Design, Development, Testing", "Initiation, Planning, Execution, Closure", "Requirements, Design, Implementation, Maintenance", "Concept, Development, Testing, Release"], correct: 1 },
            { id: 159, category: "Project Management", q: "What happens during project initiation?", a: "The project is broadly defined with a business case, feasibility study, and project charter", choices: ["Actual development work begins", "Quality assurance testing starts", "Project is defined with business case and charter", "Final deliverables are handed off"], correct: 2 },
            { id: 160, category: "Project Management", q: "What happens during project planning?", a: "Goals are set, scope defined, and project management plan created with resources, cost, and time estimates", choices: ["The actual project work is performed", "Initial concept is developed", "The project is handed off to stakeholders", "Goals, scope, and plan created with estimates"], correct: 3 },
            { id: 161, category: "Project Management", q: "What does SMART stand for in goal setting?", a: "Specific, Measurable, Attainable, Realistic, Timely", choices: ["Specific, Measurable, Attainable, Realistic, Timely", "Strategic, Managed, Actionable, Reviewed, Tracked", "Simple, Modular, Agile, Rapid, Technical", "Scoped, Monitored, Approved, Resourced, Tested"], correct: 0 },
            { id: 162, category: "Project Management", q: "What is scope creep?", a: "Uncontrolled change of a project's scope, typically adding tasks and unplanned costs", choices: ["Proper scope management and control", "Uncontrolled scope changes adding tasks and costs", "Reducing project scope to meet deadlines", "Formal change request process"], correct: 1 },
            { id: 163, category: "Project Management", q: "What is a work breakdown structure (WBS)?", a: "A document breaking the project into manageable segments for the team", choices: ["A detailed project budget", "A timeline with milestones", "Breaking project into manageable segments", "A list of team members"], correct: 2 },
            { id: 164, category: "Project Management", q: "What are key performance indicators (KPIs)?", a: "Metrics used to monitor project progress and determine if milestones are being met", choices: ["Employee satisfaction scores", "Software testing results", "Financial accounting measures", "Metrics monitoring project progress"], correct: 3 },

            // SDLC
            { id: 165, category: "SDLC", q: "What is SDLC?", a: "Software Development Life Cycle - a framework for developing software through defined phases", choices: ["Software Development Life Cycle - framework for building software through phases", "System Data Logic Controller - hardware component for processing", "Structured Design Language Code - a programming paradigm", "Software Debug and Log Checker - a testing tool"], correct: 0 },
            { id: 166, category: "SDLC", q: "What is the waterfall model?", a: "A sequential development process where each phase must be completed before moving to the next", choices: ["Iterative cycles with continuous feedback", "Sequential development completing phases in order", "Rapid prototyping with user testing", "Flexible development without fixed phases"], correct: 1 },
            { id: 167, category: "SDLC", q: "What is the incremental model?", a: "A model where the system is constructed in increments, with each version adding more features", choices: ["Building complete system at once", "Prototyping without final production", "System built in increments adding features", "Sequential phases without iteration"], correct: 2 },
            { id: 168, category: "SDLC", q: "What is prototyping?", a: "Building and evaluating basic versions of a proposed system before full development", choices: ["Completing full development immediately", "Documenting requirements without building", "Testing only after development", "Building and evaluating basic versions first"], correct: 3 },
            { id: 169, category: "SDLC", q: "What is Agile methodology?", a: "System development with incremental implementations, responding to rapidly changing requirements", choices: ["Incremental development responding to changing requirements", "Rigid sequential development phases", "Extensive upfront planning without changes", "Single delivery at project end"], correct: 0 },
            { id: 170, category: "SDLC", q: "What is Scrum?", a: "An Agile methodology using sprints, daily scrums, and prioritized wish lists", choices: ["A waterfall-based methodology", "An iterative approach with time-boxed cycles and daily standups", "A testing framework", "A documentation standard"], correct: 1 },
            { id: 171, category: "SDLC", q: "What is requirements analysis?", a: "Determining what services the system will provide and how users will interact with it", choices: ["Writing implementation code", "Performing system testing", "Determining system services and user interaction", "Deploying the final system"], correct: 2 },
            { id: 172, category: "SDLC", q: "What is the SRS?", a: "System Requirement Specification - a written agreement recording system requirements to guide development", choices: ["Software Release Schedule - timeline for deployments", "System Recovery Script - restores after failures", "Structured Review Summary - feedback from code reviews", "Software Requirements Specification - documents what the system must do"], correct: 3 },

            // Testing
            { id: 173, category: "Testing", q: "What is alpha testing?", a: "First stage testing where developers and/or internal UX team test a preliminary version", choices: ["Internal testing by developers before external release", "Testing by selected external users in a controlled environment", "Final validation testing in production by end users", "Automated testing that runs after each code commit"], correct: 0 },
            { id: 174, category: "Testing", q: "What is beta testing?", a: "Second stage where end users test the system before final release, also called pilot testing", choices: ["Internal testing by the development team before any external exposure", "External user testing in real-world conditions before final release", "Formal validation that system meets documented requirements", "Testing individual code modules in isolation"], correct: 1 },
            { id: 175, category: "Testing", q: "What is user acceptance testing?", a: "Final stage where users test the system in an operational setting to ensure business objectives are met", choices: ["Initial developer testing phase", "Automated integration testing", "Final operational testing for business objectives", "Code review by developers"], correct: 2 },
            { id: 176, category: "Testing", q: "What is white-box testing?", a: "Testing based on knowledge of a system's internal components, also called glass-box testing", choices: ["Testing system behavior without viewing source code", "Testing against documented requirements only", "Testing user interface and user experience", "Testing with full visibility into internal code structure"], correct: 3 },
            { id: 177, category: "Testing", q: "What is black-box testing?", a: "Testing focused on user experience without knowledge of the system's internal structure", choices: ["Testing inputs and outputs without knowledge of internal code", "Testing internal logic paths and code coverage", "Testing individual functions in complete isolation", "Testing with access to source code and documentation"], correct: 0 },
            { id: 178, category: "Testing", q: "What is the Pareto principle in testing?", a: "The theory that 80% of errors come from 20% of the system", choices: ["All modules have equal defects", "80% of errors come from 20% of the system", "Testing covers 100% of code", "Defects are evenly distributed"], correct: 1 },

            // System Maintenance
            { id: 179, category: "Maintenance", q: "What is corrective maintenance?", a: "Maintenance to remove errors and ensure system functionality", choices: ["Adding new features to the system", "Improving system performance", "Removing errors for functionality", "Preventing future issues"], correct: 2 },
            { id: 180, category: "Maintenance", q: "What is adaptive maintenance?", a: "Maintenance performed when organizational changes affect system requirements", choices: ["Fixing bugs and defects", "Preventive code restructuring", "Performance optimization", "Changes due to organizational requirement changes"], correct: 3 },
            { id: 181, category: "Maintenance", q: "What is perfective maintenance?", a: "Maintenance when new components are added or existing components improved for better performance", choices: ["Adding or improving components for performance", "Fixing critical system bugs", "Adapting to external changes", "Restructuring to prevent decay"], correct: 0 },
            { id: 182, category: "Maintenance", q: "What is preventive maintenance?", a: "Changes to increase system life span, including restructuring, optimizing code, and updating documentation", choices: ["Fixing reported bugs", "Changes to increase system life span", "Adding requested features", "Emergency security patches"], correct: 1 },

            // IT Governance & Organization
            { id: 183, category: "IT Governance", q: "What is IT governance?", a: "The system of processes ensuring effective and efficient IT use to achieve business goals", choices: ["Government IT regulations", "IT department management only", "Processes ensuring effective IT use for business goals", "Technical standards compliance"], correct: 2 },
            { id: 184, category: "IT Governance", q: "What are the five IT function domains?", a: "Communication, data collection/management, information security, customer relationship management, process improvement", choices: ["Hardware, software, network, security, support", "Planning, execution, monitoring, closing, maintenance", "Development, testing, deployment, monitoring, support", "Communication, data, security, CRM, process improvement"], correct: 3 },
            { id: 185, category: "IT Governance", q: "What is outsourcing?", a: "Using resources and skills from an external organization for IT functions", choices: ["Contracting third-party vendors for business functions", "Hiring internal IT staff", "Developing in-house solutions", "Training existing employees"], correct: 0 },
            { id: 186, category: "IT Governance", q: "What is insourcing?", a: "Assigning a project to employees within the organization", choices: ["Hiring external contractors", "Using your own staff instead of third-party vendors", "Offshoring to other countries", "Using managed service providers"], correct: 1 },
            { id: 187, category: "IT Governance", q: "What is offshoring?", a: "Outsourcing outside country lines", choices: ["Keeping operations in the same country", "Moving operations nearby", "Relocating work to a foreign country", "Using local contractors"], correct: 2 },
            { id: 188, category: "IT Governance", q: "What is nearshoring?", a: "Offshoring to countries in a closer time zone or with similar economic structure", choices: ["Outsourcing to distant countries", "Using domestic contractors", "Keeping work fully internal", "Relocating work to geographically close regions"], correct: 3 },

            // Software Types
            { id: 189, category: "Software", q: "What is system software?", a: "General-purpose software used to operate computer hardware and provide a platform for application software", choices: ["Software to operate hardware and support applications", "End-user productivity applications", "Custom business applications", "Web-based services"], correct: 0 },
            { id: 190, category: "Software", q: "What is application software?", a: "Specific-purpose software used to perform specific tasks like word processing or email", choices: ["Operating system software", "Software for specific tasks like word processing", "Hardware driver software", "System utility programs"], correct: 1 },
            { id: 191, category: "Software", q: "What is productivity software?", a: "Software used to complete daily tasks such as writing documents, presentations, and managing data", choices: ["Entertainment and gaming software", "System administration tools", "Software for documents, presentations, data management", "Security and antivirus programs"], correct: 2 },
            { id: 192, category: "Software", q: "Which software type helps people communicate, work together, and share information?", a: "Software helping people communicate and work together, and computers share information", choices: ["System software", "Utility software", "Productivity software", "Groupware and teamwork platforms"], correct: 3 },
            { id: 193, category: "Software", q: "Give examples of word processing software.", a: "Microsoft Word, Google Docs, OpenOffice Writer", choices: ["Word, Google Docs, OpenOffice Writer", "Excel, Sheets", "PowerPoint, Slides", "Access, MySQL"], correct: 0 },
            { id: 194, category: "Software", q: "Give examples of spreadsheet software.", a: "Microsoft Excel, Google Sheets, OpenOffice Calc", choices: ["Word, Docs", "Excel, Google Sheets, OpenOffice Calc", "PowerPoint, Slides", "Access, MySQL"], correct: 1 },
            { id: 195, category: "Software", q: "Give examples of presentation software.", a: "Microsoft PowerPoint, Google Slides, OpenOffice Impress", choices: ["Word, Docs", "Excel, Sheets", "PowerPoint, Google Slides, OpenOffice Impress", "Access, MySQL"], correct: 2 },

            // More questions from embedded quizzes
            { id: 196, category: "IT Roles", q: "Which role is responsible for maintaining websites?", a: "Web Administrator", choices: ["Data analyst", "Network engineer", "Cloud architect", "Webmaster"], correct: 3 },
            { id: 197, category: "Databases", q: "What is the collection of names, addresses, and account balances called?", a: "A database", choices: ["A database", "A key field", "A file", "A record"], correct: 0 },
            { id: 198, category: "Databases", q: "What is a tree-like structure of records in a database called?", a: "Hierarchical database structure", choices: ["Flat file", "Hierarchical database structure", "Field", "Relational database structure"], correct: 1 },
            { id: 199, category: "Hardware", q: "What is the role of the CPU in a computing system?", a: "Performing instructions of computer programs", choices: ["Permanently storing all data", "Distributing signals", "Performing instructions of computer programs", "Temporary storage"], correct: 2 },
            { id: 200, category: "Networking", q: "Which network topology best handles downed links without losing connectivity?", a: "Mesh", choices: ["Bus", "Ring", "Star", "Mesh"], correct: 3 },
            { id: 201, category: "Networking", q: "Which type of network interconnects devices in a single office or building?", a: "LAN (Local Area Network)", choices: ["LAN", "PAN", "SAN", "WAN"], correct: 0 },
            { id: 202, category: "Internet", q: "IP addresses are traditionally written in what notation?", a: "Dotted decimal notation", choices: ["Encrypted", "Dotted decimal", "Mnemonic", "Binary"], correct: 1 },
            { id: 203, category: "Internet", q: "What tool is used to encode a document while focusing on appearance?", a: "HTML", choices: ["DNS", "HTTP", "HTML", "URL"], correct: 2 },
            { id: 205, category: "Security", q: "Which technique obtains sensitive information by pretending to be trustworthy?", a: "Phishing", choices: ["Phishing", "Black hat", "Packet sniffing", "Buffer overflow"], correct: 0 },
            { id: 206, category: "Security", q: "What role does a firewall play?", a: "Filtering incoming and outgoing network traffic for security purposes", choices: ["Managing local network traffic", "Filtering network traffic for security", "Directing data packets", "Converting signals"], correct: 1 },
            { id: 207, category: "Hardware", q: "Which component converts analog signals to digital signals?", a: "Modem", choices: ["Switch", "Router", "Modem", "Firewall"], correct: 2 },
            { id: 208, category: "Operating Systems", q: "Where are the basic functions of the operating system located?", a: "Kernel", choices: ["Applications", "File manager", "Utility software", "Kernel"], correct: 3 },
            { id: 209, category: "Operating Systems", q: "Which OS is known for open-source nature and server use?", a: "Linux", choices: ["Linux", "Windows", "macOS", "Android"], correct: 0 },
            { id: 210, category: "Programming", q: "What is the main difference between compiler and interpreter?", a: "Compiler translates all at once; interpreter translates line by line", choices: ["Compiler to machine code, interpreter to high-level", "Interpreter line by line, compiler all at once to executable", "Compiler for web, interpreter for software", "Compiler is faster"], correct: 1 },
            { id: 211, category: "Programming", q: "What is the function of a compiler?", a: "To convert high-level language code into machine code for execution", choices: ["Debug and test code", "Execute source code directly", "Convert high-level to machine code", "Interpret code line-by-line"], correct: 2 },
            { id: 213, category: "Databases", q: "What fundamental structure organizes data in a relational database?", a: "Tables", choices: ["Tables", "Arrays", "Loops", "Pointers"], correct: 0 },
            { id: 214, category: "Databases", q: "What characterizes NoSQL database organization?", a: "Flexibility in handling unstructured and semi-structured data", choices: ["Strict fixed schema", "Flexibility with unstructured data", "SQL queries only", "Relational models only"], correct: 1 },
            { id: 215, category: "SDLC", q: "Which phase organizes project scope, objectives, and deliverables?", a: "Planning", choices: ["Initiating", "Execution", "Planning", "Closing"], correct: 2 },
            { id: 216, category: "Data & Information", q: "Most stored data today is what type?", a: "Unstructured (text, blogs, tweets, audio)", choices: ["Structured", "Organized", "Semi-structured", "Unstructured"], correct: 3 },
            { id: 217, category: "Hardware", q: "What defines output in computing?", a: "Processed or generated information produced by a system", choices: ["Processed information produced by system", "Information stored for later", "Data awaiting processing", "Data input into system"], correct: 0 },
            { id: 219, category: "Hardware", q: "Which category do barcode scanners and webcams belong to?", a: "Input", choices: ["Temporary memory", "Output", "Input", "Storage"], correct: 2 },
            { id: 220, category: "Software", q: "Which software category performs system maintenance like disk cleaning?", a: "Utility Software", choices: ["System Software", "Security Software", "Firmware", "Utility Software"], correct: 3 },

            // CIA Triad
            { id: 221, category: "Security", q: "What does CIA stand for in cybersecurity?", a: "Confidentiality, Integrity, Availability", choices: ["Central Intelligence Agency - a government organization", "Confidentiality, Integrity, Availability - the security triad", "Cybersecurity, Internet, Accessibility - web standards", "Compliance, Information, Authorization - access controls"], correct: 1 },
            { id: 222, category: "Security", q: "Which element of the CIA triad ensures data is not modified by unauthorized users?", a: "Integrity", choices: ["Confidentiality", "Integrity", "Availability", "Authentication"], correct: 1 },
            { id: 223, category: "Security", q: "Which element of the CIA triad ensures authorized users can access data when needed?", a: "Availability", choices: ["Confidentiality", "Integrity", "Availability", "Authorization"], correct: 2 },
            { id: 224, category: "Security", q: "Which element of the CIA triad restricts access to only those who need to know?", a: "Confidentiality", choices: ["Confidentiality", "Integrity", "Availability", "Accountability"], correct: 0 },

            // Ethics & Professional Codes
            { id: 225, category: "Ethics", q: "What is the difference between ethics and regulations?", a: "Regulations are requirements from governing bodies with penalties; ethics are personal/organizational morals", choices: ["Ethics have legal penalties; regulations are optional", "Regulations are requirements with penalties; ethics are morals", "They are the same thing", "Ethics apply only to IT; regulations apply everywhere"], correct: 1 },
            { id: 226, category: "Ethics", q: "What is a conflict of interest?", a: "A situation where a person has two relationships that might be incompatible with each other", choices: ["A disagreement between colleagues", "When a person has incompatible loyalties or relationships", "A software licensing dispute", "A data privacy violation"], correct: 1 },
            { id: 227, category: "Ethics", q: "What is an Acceptable Use Policy (AUP)?", a: "A policy detailing how computer systems owned by an organization can be used", choices: ["A software license agreement", "A data backup policy", "Rules governing employee conduct on company IT resources", "A network security protocol"], correct: 2 },
            { id: 228, category: "Ethics", q: "What did the Computer Ethics Institute develop?", a: "Ten Commandments of Computer Ethics", choices: ["Ten Commandments of Computer Ethics", "IEEE Code of Ethics", "ACM Code of Conduct", "AITP Standards of Practice"], correct: 0 },
            { id: 229, category: "Ethics", q: "What does ACM stand for?", a: "Association for Computing Machinery", choices: ["American Computer Manufacturers - hardware trade group", "Association for Computing Machinery - professional CS organization", "Automated Computing Management - IT operations framework", "Advanced Computer Methods - programming techniques"], correct: 1 },
            { id: 230, category: "Ethics", q: "What does IEEE stand for?", a: "Institute of Electrical and Electronics Engineers", choices: ["International Electronics Engineering Entity - EU standards body", "Institute of Electrical and Electronics Engineers - professional association", "Information Engineering and Ethics Experts - advisory board", "Internet Engineering Excellence Establishment - web consortium"], correct: 1 },

            // Business Continuity & Disaster Recovery
            { id: 231, category: "IT Governance", q: "What is a disaster recovery plan (DRP)?", a: "A plan that ensures systems can recover from catastrophic events with minimal data loss", choices: ["A plan for daily backups", "A strategy for restoring IT systems after catastrophic failures", "An insurance policy for IT equipment", "A network monitoring strategy"], correct: 1 },
            { id: 232, category: "IT Governance", q: "What is a business continuity plan?", a: "A plan defining how to resume services and vital business operations during disruptions", choices: ["A marketing strategy", "A plan for resuming services during disruptions", "An employee training program", "A software development plan"], correct: 1 },
            { id: 233, category: "IT Governance", q: "What is hot storage in disaster recovery?", a: "Storage allowing quickest access to restore critical data after a disaster", choices: ["Storage in warm locations", "Always-online data with instant access for rapid restoration", "Storage that runs continuously", "Overheated storage devices"], correct: 1 },
            { id: 234, category: "IT Governance", q: "What is cold storage in disaster recovery?", a: "Less expensive storage with less frequent access and slower recovery times", choices: ["Refrigerated storage for servers", "Low-cost archival data accessed infrequently with longer retrieval time", "Storage in cold climates", "Frozen backup tapes"], correct: 1 },
            { id: 235, category: "IT Governance", q: "What does 'five nines' mean for system uptime?", a: "99.999% availability, approximately 5 minutes of downtime per year", choices: ["Five backup copies", "99.999% uptime availability", "Five data centers", "Five security levels"], correct: 1 },

            // IoT & Emerging Tech
            { id: 236, category: "Networking", q: "What is the Internet of Things (IoT)?", a: "A system of interconnected devices with unique identifiers that can transfer data via a network without human interaction", choices: ["The World Wide Web", "Smart devices communicating and exchanging data autonomously", "A social media network", "A cloud computing platform"], correct: 1 },
            { id: 237, category: "IT Governance", q: "What is globalization in the context of IT?", a: "The growing interdependence of world economies and cultures brought about by trade and the flow of information", choices: ["Using global IP addresses", "Growing interdependence of economies through trade and information", "Having servers worldwide", "Using international domain names"], correct: 1 },

            // Computer History
            { id: 238, category: "Hardware", q: "What was the abacus used for?", a: "One of the earliest computing devices for performing calculations using beads on rods", choices: ["Storing written documents", "Performing calculations using beads", "Sending messages", "Keeping time"], correct: 1 },
            { id: 239, category: "Hardware", q: "Who is considered the world's first computer programmer?", a: "Ada Lovelace", choices: ["Charles Babbage", "Ada Lovelace", "Alan Turing", "Grace Hopper"], correct: 1 },
            { id: 240, category: "Hardware", q: "What was ENIAC?", a: "Electronic Numerical Integrator and Calculator - an early electronic computer from the 1940s", choices: ["A programming language", "An early electronic computer", "A type of vacuum tube", "A network protocol"], correct: 1 },
            { id: 241, category: "Internet", q: "Who invented the World Wide Web?", a: "Tim Berners-Lee in the late 1980s", choices: ["Bill Gates", "Steve Jobs", "Tim Berners-Lee", "Vint Cerf"], correct: 2 },

            // Technical Details
            { id: 242, category: "Networking", q: "What is baseband transmission?", a: "A signal at a narrow frequency range on which data is transmitted, like Ethernet LANs", choices: ["High-speed wireless transmission", "Narrow frequency signal transmission like Ethernet", "Satellite communication", "Fiber optic transmission"], correct: 1 },
            { id: 243, category: "Networking", q: "What is broadband transmission?", a: "High-capacity transmission technologies for data, voice, and video across long distances", choices: ["Low-speed local transmission", "High-capacity transmission for data/voice/video", "Wireless Bluetooth transmission", "Near-field communication"], correct: 1 },
            { id: 244, category: "Hardware", q: "What is a petabyte (PB)?", a: "1,024 terabytes", choices: ["1,000 gigabytes", "1,024 gigabytes", "1,024 terabytes", "1,024 megabytes"], correct: 2 },
            { id: 245, category: "Operating Systems", q: "What is a superuser or root account?", a: "An administrator account that can alter settings, modify software, and perform maintenance activities", choices: ["A regular user with limited access", "An administrator account with full system access", "A guest account", "An automated system account"], correct: 1 },
            { id: 246, category: "Networking", q: "What is a CDN (Content Delivery Network)?", a: "A distributed network of servers that delivers web content based on user geographic location", choices: ["A central database network", "Geographically distributed servers caching data closer to users", "A computer data network", "A cable distribution node"], correct: 1 },
            { id: 247, category: "Internet", q: "What is VoIP?", a: "Voice over Internet Protocol - technology for delivering voice communications over IP networks", choices: ["Video over Internet Protocol - streams visual media online", "Voice over Internet Protocol - enables phone calls through internet", "Virtual Online Integration Platform - connects cloud services", "Verified Online Identity Protocol - authenticates users securely"], correct: 1 }
        ];

        // Active questions array - switches based on logged-in user
        let questions = [...demoQuestions];

        // Check if user is the owner and switch question sets
        function updateQuestionSet(email) {
            const isOwner = email && email.toLowerCase() === OWNER_EMAIL.toLowerCase();
            const rawLink = document.getElementById('raw-content-link');
            if (isOwner) {
                questions.length = 0;
                wguQuestions.forEach(q => questions.push(q));
                if (rawLink) rawLink.classList.remove('hidden');
            } else {
                questions.length = 0;
                demoQuestions.forEach(q => questions.push(q));
                if (rawLink) rawLink.classList.add('hidden');
            }
            // Reset progress when switching question sets
            state.mastered = [];
            state.answerCounts = {};
            state.totalCorrect = 0;
            state.totalAnswered = 0;
            state.examQuestions = [];
            state.examIndex = 0;
            state.examCorrect = 0;
            // Initialize category filter for new question set
            initCategoryFilter();
        }

        // State management
        let state = {
            mastered: [],
            answerCounts: {},
            totalCorrect: 0,
            totalAnswered: 0,
            currentQuestion: null,
            currentMode: 'menu', // menu, practice, exam
            examQuestions: [],
            examIndex: 0,
            examCorrect: 0,
            claimedKnowledge: false,
            isPro: false,
            licenseKey: null,
            email: null,
            importedQuestionCount: 0
        };

        // Category filter state
        let selectedCategories = new Set();
        let allCategories = [];
        let courseContentCategory = null;

        const VANDROMEDA_API = 'https://www.vandromeda.com/api';
        const FREE_IMPORT_LIMIT = 50;
        // TODO: Replace with LIVE Stripe price IDs before launch
        // Current: TEST mode prices - Create live products in Stripe Dashboard first
        const STRIPE_PRICES = {
            monthly: 'price_1SosTEE0LClU4PH9magrG0Bo',  // TODO: Replace with live price ID
            yearly: 'price_1SosUDE0LClU4PH9ycCWqpQ5'   // TODO: Replace with live price ID
        };
        let currentKeyword = '';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDC76Oepi1KPfHImPt51kTlgUT3X1iPWTY",
            authDomain: "quizmyself-f7c1b.firebaseapp.com",
            projectId: "quizmyself-f7c1b",
            storageBucket: "quizmyself-f7c1b.firebasestorage.app",
            messagingSenderId: "1038445985794",
            appId: "1:1038445985794:web:550af5efff1020679f671b",
            measurementId: "G-MY6LJ1Y3FS"
        };

        // Initialize Firebase
        let firebaseApp = null;
        let auth = null;
        let currentUser = null;
        let authToken = null;
        let userKeywords = [];

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
        } catch (e) {
            console.log('Firebase not configured yet');
        }

        // ========== AUTH FUNCTIONS ==========

        async function getAuthToken() {
            if (currentUser) {
                try {
                    authToken = await currentUser.getIdToken();
                    return authToken;
                } catch (e) {
                    console.error('Failed to get auth token:', e);
                    return null;
                }
            }
            return null;
        }

        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('auth-login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('auth-register-form').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('auth-forgot-form').style.display = 'none';
            document.getElementById('auth-error').style.display = 'none';
        }

        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            el.textContent = message;
            el.style.display = 'block';
        }

        async function handleLogin() {
            if (!auth) {
                showAuthError('Auth not configured. Use quick access.');
                return;
            }
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showAuthError('Please enter email and password');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('hamburger-dropdown').classList.remove('show');
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            } catch (error) {
                showAuthError(error.message);
            }
        }

        async function handleRegister() {
            if (!auth) {
                showAuthError('Auth not configured. Use quick access.');
                return;
            }
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (password !== confirm) {
                showAuthError('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                document.getElementById('hamburger-dropdown').classList.remove('show');
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirm').value = '';
            } catch (error) {
                showAuthError(error.message);
            }
        }

        function showForgotPassword() {
            document.getElementById('auth-login-form').style.display = 'none';
            document.getElementById('auth-forgot-form').style.display = 'block';
            document.getElementById('auth-error').style.display = 'none';
        }

        function hideForgotPassword() {
            document.getElementById('auth-forgot-form').style.display = 'none';
            document.getElementById('auth-login-form').style.display = 'block';
            document.getElementById('auth-error').style.display = 'none';
        }

        async function handleForgotPassword() {
            const email = document.getElementById('forgot-email').value.trim();

            if (!email) {
                showAuthError('Please enter your email');
                return;
            }

            try {
                const response = await fetch(`${VANDROMEDA_API}/auth/password-reset.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, product: 'quizmyself' })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('forgot-email').value = '';
                    showAuthError('Password reset email sent! Check your inbox.');
                    document.getElementById('auth-error').style.color = '#4caf50';
                } else {
                    document.getElementById('auth-error').style.color = '#ff5252';
                    showAuthError(data.error || 'Failed to send reset email');
                }
            } catch (error) {
                document.getElementById('auth-error').style.color = '#ff5252';
                showAuthError('Network error. Please try again.');
            }
        }

        async function handleSignOut() {
            // Always try to sign out from Firebase
            if (auth) {
                try {
                    await auth.signOut();
                } catch (e) {
                    console.error('Sign out error:', e);
                }
            }
            // Clear all local state
            currentUser = null;
            authToken = null;
            userKeywords = [];
            currentKeyword = '';
            questions = [];
            state.isPro = false;
            state.licenseKey = null;
            state.email = null;
            // Clear all localStorage items
            localStorage.removeItem('quizmyself_keyword');
            localStorage.removeItem('quizmyself_active_keyword');
            document.getElementById('stats-bar').style.display = 'none';
            document.getElementById('hamburger-dropdown').classList.remove('show');
            updateKeywordDropdown();
            updateHamburgerMenu();
            updateProUI();
            showScreen('menu-screen');
        }

        // Auth state listener
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                if (user) {
                    authToken = await user.getIdToken();
                    state.email = user.email;

                    // Switch question set based on user (owner gets full content)
                    updateQuestionSet(user.email);
                    updateStats();

                    // Load user's keywords from server
                    await loadUserKeywords();

                    // Check for payment success (user returning from Stripe)
                    const urlParams = new URLSearchParams(window.location.search);
                    let licenseJustCaptured = false;
                    if (urlParams.get('payment') === 'success') {
                        const sessionId = urlParams.get('session_id');
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        if (sessionId) {
                            licenseJustCaptured = await fetchLicenseFromSession(sessionId);
                        }
                    }

                    // Check license status (tied to account) - skip if we just captured a license
                    // to avoid overwriting the freshly captured license with potentially stale account data
                    if (!licenseJustCaptured) {
                        await checkProStatusForAccount();
                    }

                    // Restore last active keyword
                    const lastKeyword = localStorage.getItem('quizmyself_active_keyword');
                    if (lastKeyword && userKeywords.find(k => k.keyword === lastKeyword)) {
                        await selectKeyword(lastKeyword);
                    } else if (userKeywords.length > 0) {
                        await selectKeyword(userKeywords[0].keyword);
                    } else {
                        // No keywords yet - still show the keyword dropdown so user can create one
                        updateKeywordDropdown();
                    }

                    updateHamburgerMenu();
                    document.getElementById('stats-bar').style.display = currentKeyword ? 'flex' : 'none';
                } else {
                    // Not signed in - show demo questions
                    updateQuestionSet(null);
                    updateStats();

                    // Check for payment success for keyword-only users
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('payment') === 'success') {
                        const sessionId = urlParams.get('session_id');
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        if (sessionId && currentKeyword) {
                            await fetchLicenseFromSession(sessionId);
                        } else if (sessionId) {
                            // No keyword yet - show modal with pending status
                            showUpgradeModal({ pendingSessionId: sessionId });
                        }
                    }
                    updateHamburgerMenu();
                }
            });
        }

        // Initialize category filter on page load (for demo questions)
        initCategoryFilter();

        // ========== KEYWORD MANAGEMENT ==========

        async function loadUserKeywords() {
            if (!currentUser) return;

            try {
                const token = await getAuthToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/keywords.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    userKeywords = data.keywords || [];
                }
            } catch (error) {
                console.error('Failed to load keywords:', error);
            }
        }

        async function selectKeyword(keyword) {
            currentKeyword = keyword;
            localStorage.setItem('quizmyself_active_keyword', keyword);

            // Clear source viewing state to prevent cross-keyword contamination
            currentViewingSourceId = null;
            if (typeof aiGenerationState !== 'undefined') {
                aiGenerationState.sourceId = null;
                aiGenerationState.sourceName = null;
            }

            // Load progress for this keyword
            await loadState();

            // Update UI
            document.getElementById('stats-bar').style.display = 'flex';
            updateStats();
            updateHamburgerMenu();
            updateKeywordDropdown();
            initCategoryFilter(); // Show/hide category filter based on questions

            // Show/hide raw source links based on whether keyword has a linked source
            const rawLink = document.getElementById('raw-content-link');
            const courseBtn = document.getElementById('course-content-btn');
            const keywordInfo = userKeywords.find(kw => kw.keyword === keyword);
            const hasLinkedSource = keywordInfo && keywordInfo.source_id;
            if (rawLink) rawLink.classList.toggle('hidden', !hasLinkedSource);
            if (courseBtn) courseBtn.classList.toggle('hidden', !hasLinkedSource);

            // Update button states based on quiz content
            updateSourceDependentButtons();
        }

        // Update menu button states based on quiz content availability
        function updateSourceDependentButtons() {
            const practiceBtn = document.getElementById('practice-quiz-btn');
            const examBtn = document.getElementById('final-exam-btn');
            const progressBtn = document.getElementById('view-progress-btn');
            const masteredBtn = document.getElementById('manage-mastered-btn');
            const courseBtn = document.getElementById('course-content-btn');
            const rawLink = document.getElementById('raw-content-link');

            const keywordInfo = userKeywords.find(kw => kw.keyword === currentKeyword);
            const hasLinkedSource = keywordInfo && keywordInfo.source_id;
            const hasQuestions = questions && questions.length > 0;

            // Show/hide study material buttons based on linked source
            if (courseBtn) courseBtn.classList.toggle('hidden', !hasLinkedSource);
            if (rawLink) rawLink.classList.toggle('hidden', !hasLinkedSource);

            // Enable/disable quiz buttons based on whether questions exist
            const contentButtons = [practiceBtn, examBtn, progressBtn, masteredBtn];
            contentButtons.forEach(btn => {
                if (!btn) return;
                if (hasQuestions) {
                    btn.classList.remove('btn-disabled');
                    btn.disabled = false;
                } else {
                    btn.classList.add('btn-disabled');
                    btn.disabled = true;
                }
            });
        }

        // Update keyword dropdown to reflect current selection
        function updateKeywordDropdown() {
            const dropdown = document.getElementById('keyword-dropdown');
            const selector = document.getElementById('keyword-selector');

            if (!currentUser) {
                selector.style.display = 'none';
                return;
            }

            // Show selector for logged-in users (even with no keywords, so they can create one)
            selector.style.display = 'flex';

            // Build options
            if (userKeywords.length === 0) {
                dropdown.innerHTML = '<option value="">No quizzes yet - click + to create</option>';
                return;
            }

            dropdown.innerHTML = '<option value="">Select a quiz...</option>' +
                userKeywords.map(kw => {
                    const label = kw.display_name || kw.keyword;
                    const keywordSuffix = kw.display_name ? ` [${kw.keyword}]` : '';
                    const info = kw.question_count ? ` (${kw.question_count}q)` : '';
                    const sourceIcon = kw.source_id ? ' üìé' : '';
                    return `<option value="${kw.keyword}" ${kw.keyword === currentKeyword ? 'selected' : ''}>${label}${keywordSuffix}${info}${sourceIcon}</option>`;
                }).join('');
        }

        // Handle keyword selection from dropdown
        async function onKeywordSelect(keyword) {
            if (!keyword) return;
            await selectKeyword(keyword);
        }

        // ========== CREATE QUIZ MODAL ==========

        let createQuizUnlinkedSources = [];
        let createQuizSelectedSourceId = null;

        function showCreateQuizModal() {
            if (!currentUser) {
                showToast('Please sign in to create a quiz', 'warning');
                return;
            }

            // Reset modal state
            document.getElementById('create-quiz-name').value = '';
            document.getElementById('create-quiz-error').style.display = 'none';
            document.querySelector('input[name="source-option"][value="none"]').checked = true;
            document.getElementById('create-quiz-existing-section').style.display = 'none';
            createQuizSelectedSourceId = null;

            // Load unlinked sources
            loadSourcesForPicker();

            // Setup source option handlers
            document.querySelectorAll('input[name="source-option"]').forEach(radio => {
                radio.onchange = handleSourceOptionChange;
            });

            document.getElementById('create-quiz-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('create-quiz-name').focus();
        }

        function closeCreateQuizModal() {
            document.getElementById('create-quiz-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeCreateQuizModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeCreateQuizModal();
            }
        }

        // ========== QUIZ EDITOR MODAL ==========

        function showQuizEditor() {
            if (!currentUser) {
                showToast('Please sign in to edit quizzes.', 'warning');
                return;
            }
            if (!currentKeyword) {
                showToast('Please select or create a quiz first.', 'warning');
                return;
            }

            const keywordInfo = userKeywords.find(kw => kw.keyword === currentKeyword);
            const displayName = keywordInfo?.display_name || currentKeyword;

            document.getElementById('quiz-editor-name').textContent = displayName;
            document.getElementById('quiz-editor-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            hideQuestionForm();
            renderQuizEditorQuestions();
        }

        function closeQuizEditorModal() {
            document.getElementById('quiz-editor-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeQuizEditorModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeQuizEditorModal();
            }
        }

        function renderQuizEditorQuestions() {
            const listEl = document.getElementById('quiz-editor-questions');
            const countEl = document.getElementById('quiz-editor-count');

            countEl.textContent = `(${questions.length} question${questions.length !== 1 ? 's' : ''})`;

            if (questions.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
                        <p>No questions yet.</p>
                        <p style="font-size: 0.9rem;">Click "Add Question" to create your first question.</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const categories = {};
            questions.forEach((q, idx) => {
                const cat = q.category || 'Uncategorized';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ ...q, _index: idx });
            });

            let html = '';
            Object.keys(categories).sort().forEach(cat => {
                html += `<div style="margin-bottom: 15px;">
                    <div style="color: #4fc3f7; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; padding: 5px 10px; background: #0f3460; border-radius: 4px;">
                        ${escapeHtml(cat)} (${categories[cat].length})
                    </div>`;

                categories[cat].forEach(q => {
                    const correctChoice = q.choices && q.choices[q.correct] ? q.choices[q.correct] : 'N/A';
                    html += `
                    <div class="quiz-editor-question" style="padding: 12px; background: #2a2a2a; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #4CAF50;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: #fff; font-size: 0.95rem; margin-bottom: 5px;">${escapeHtml(q.q)}</div>
                                <div style="color: #4CAF50; font-size: 0.85rem;">‚úì ${escapeHtml(correctChoice)}</div>
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                <button class="btn btn-small" onclick="editQuestion(${q.id})" style="padding: 5px 10px;">Edit</button>
                                <button class="btn btn-danger btn-small" onclick="deleteQuestion(${q.id})" style="padding: 5px 10px;">Delete</button>
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });

            listEl.innerHTML = html;
        }

        function showAddQuestionForm() {
            document.getElementById('question-form-title').textContent = 'Add New Question';
            document.getElementById('question-form-edit-id').value = '';
            document.getElementById('question-form-category').value = '';
            document.getElementById('question-form-text').value = '';
            document.getElementById('question-form-answer').value = '';
            document.getElementById('question-form-choice-0').value = '';
            document.getElementById('question-form-choice-1').value = '';
            document.getElementById('question-form-choice-2').value = '';
            document.getElementById('question-form-choice-3').value = '';
            document.querySelector('input[name="correct-choice"][value="0"]').checked = true;

            document.getElementById('question-form').style.display = 'block';
            document.getElementById('question-form-text').focus();
        }

        function hideQuestionForm() {
            document.getElementById('question-form').style.display = 'none';
        }

        function editQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (!question) {
                showToast('Question not found.', 'error');
                return;
            }

            document.getElementById('question-form-title').textContent = 'Edit Question';
            document.getElementById('question-form-edit-id').value = id;
            document.getElementById('question-form-category').value = question.category || '';
            document.getElementById('question-form-text').value = question.q || '';
            document.getElementById('question-form-answer').value = question.a || '';

            // Fill in choices
            const choices = question.choices || ['', '', '', ''];
            document.getElementById('question-form-choice-0').value = choices[0] || '';
            document.getElementById('question-form-choice-1').value = choices[1] || '';
            document.getElementById('question-form-choice-2').value = choices[2] || '';
            document.getElementById('question-form-choice-3').value = choices[3] || '';

            // Set correct answer radio
            const correctIndex = question.correct || 0;
            const radio = document.querySelector(`input[name="correct-choice"][value="${correctIndex}"]`);
            if (radio) radio.checked = true;

            document.getElementById('question-form').style.display = 'block';
            document.getElementById('question-form-text').focus();
        }

        async function deleteQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (!question) return;

            const confirmed = confirm(`Delete this question?\n\n"${question.q.substring(0, 100)}..."`);
            if (!confirmed) return;

            // Remove from questions array
            const idx = questions.findIndex(q => q.id === id);
            if (idx !== -1) {
                questions.splice(idx, 1);
                state.importedQuestionCount = questions.length;

                // Also remove from mastered if it was mastered
                const masteredIdx = state.mastered.indexOf(id);
                if (masteredIdx !== -1) {
                    state.mastered.splice(masteredIdx, 1);
                }

                // Remove from answerCounts
                delete state.answerCounts[id];

                // Save changes
                saveState(true);
                renderQuizEditorQuestions();
                updateStats();
                initCategoryFilter(); // Refresh categories after deletion
                updateKeywords(); // Update question count in dropdown
                showToast('Question deleted.', 'success');
            }
        }

        function saveQuestionFromForm() {
            const editId = document.getElementById('question-form-edit-id').value;
            const category = document.getElementById('question-form-category').value.trim();
            const questionText = document.getElementById('question-form-text').value.trim();
            const answerText = document.getElementById('question-form-answer').value.trim();
            const choice0 = document.getElementById('question-form-choice-0').value.trim();
            const choice1 = document.getElementById('question-form-choice-1').value.trim();
            const choice2 = document.getElementById('question-form-choice-2').value.trim();
            const choice3 = document.getElementById('question-form-choice-3').value.trim();
            const correctChoice = parseInt(document.querySelector('input[name="correct-choice"]:checked').value);

            // Validation
            if (!questionText) {
                showToast('Please enter a question.', 'error');
                return;
            }

            // Need at least 2 choices
            const choices = [choice0, choice1, choice2, choice3].filter(c => c);
            if (choices.length < 2) {
                showToast('Please enter at least 2 answer choices.', 'error');
                return;
            }

            // Make sure the correct answer exists
            const allChoices = [choice0, choice1, choice2, choice3];
            if (!allChoices[correctChoice]) {
                showToast('The correct answer choice cannot be empty.', 'error');
                return;
            }

            // Build the question object
            const questionData = {
                category: category || 'General',
                q: questionText,
                a: answerText || allChoices[correctChoice],
                choices: allChoices,
                correct: correctChoice
            };

            if (editId) {
                // Update existing question
                const idx = questions.findIndex(q => q.id === parseInt(editId));
                if (idx !== -1) {
                    questions[idx] = { ...questions[idx], ...questionData };
                    showToast('Question updated!', 'success');
                }
            } else {
                // Add new question
                const maxId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) : 0;
                questionData.id = maxId + 1;
                questions.push(questionData);
                state.importedQuestionCount = questions.length;
                showToast('Question added!', 'success');
            }

            // Save and refresh
            saveState(true);
            hideQuestionForm();
            renderQuizEditorQuestions();
            updateStats();
            updateKeywords(); // Update question count in dropdown
            initCategoryFilter(); // Refresh category filter
        }

        async function loadSourcesForPicker() {
            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/source.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                // Filter to unlinked sources only
                createQuizUnlinkedSources = data.sources.filter(s => !s.linkedKeyword);

                // Update count display
                const countEl = document.getElementById('existing-source-count');
                if (createQuizUnlinkedSources.length === 0) {
                    countEl.textContent = 'No unlinked sources available';
                } else {
                    countEl.textContent = `${createQuizUnlinkedSources.length} source${createQuizUnlinkedSources.length > 1 ? 's' : ''} available`;
                }

                // Render sources list
                renderSourcesPicker();
            } catch (err) {
                console.error('Failed to load sources:', err);
                document.getElementById('existing-source-count').textContent = 'Failed to load';
            }
        }

        function renderSourcesPicker() {
            const listEl = document.getElementById('create-quiz-sources-list');

            if (createQuizUnlinkedSources.length === 0) {
                listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No unlinked sources. Upload a new file instead.</div>';
                return;
            }

            listEl.innerHTML = createQuizUnlinkedSources.map(source => `
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${createQuizSelectedSourceId === source.id ? '#0f3460' : '#2a2a2a'}; border-radius: 6px; margin-bottom: 8px; cursor: pointer; border: 2px solid ${createQuizSelectedSourceId === source.id ? '#4fc3f7' : 'transparent'};">
                    <input type="radio" name="existing-source" value="${source.id}" ${createQuizSelectedSourceId === source.id ? 'checked' : ''} onchange="selectExistingSource(${source.id})" style="width: 16px; height: 16px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(source.name)}</div>
                        <div style="color: #888; font-size: 0.8rem;">${getContentTypeIcon(source.contentType)} ${formatBytes(source.sizeBytes)} - ${formatDate(source.createdAt)}</div>
                    </div>
                </label>
            `).join('');
        }

        function selectExistingSource(sourceId) {
            createQuizSelectedSourceId = sourceId;
            renderSourcesPicker();
        }

        function handleSourceOptionChange(e) {
            const value = e.target.value;
            document.getElementById('create-quiz-existing-section').style.display = value === 'existing' ? 'block' : 'none';

            // Clear source selection when switching to 'none'
            if (value !== 'existing') {
                createQuizSelectedSourceId = null;
                renderSourcesPicker();
            }
        }

        function showCreateQuizError(msg) {
            const el = document.getElementById('create-quiz-error');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function getContentTypeIcon(contentType) {
            if (contentType.includes('pdf')) return 'üìï';
            if (contentType.includes('html')) return 'üåê';
            if (contentType.includes('json')) return 'üìã';
            if (contentType.includes('csv')) return 'üìä';
            return 'üìÑ';
        }

        async function createQuizWithSource() {
            const quizName = document.getElementById('create-quiz-name').value.trim();
            const sanitized = quizName.toLowerCase().replace(/[^a-z0-9-]/g, '');

            // Validate quiz name
            if (sanitized.length < 3) {
                showCreateQuizError('Quiz name must be at least 3 characters');
                return;
            }
            if (sanitized.length > 50) {
                showCreateQuizError('Quiz name must be 50 characters or less');
                return;
            }

            const selectedOption = document.querySelector('input[name="source-option"]:checked').value;
            let sourceId = null;

            document.getElementById('create-quiz-submit').disabled = true;
            document.getElementById('create-quiz-submit').textContent = 'Creating...';

            try {
                // Use existing source if selected
                if (selectedOption === 'existing' && createQuizSelectedSourceId) {
                    sourceId = createQuizSelectedSourceId;
                }

                // Create the quiz with optional source link
                const result = await addKeywordToAccount(sanitized, sourceId);

                if (result.success) {
                    closeCreateQuizModal();
                    showToast('Quiz created!' + (sourceId ? ' Source material has been linked.' : ''), 'success');
                } else {
                    // Prefer user-friendly message over error code
                    throw new Error(result.message || result.error || 'Failed to create quiz');
                }
            } catch (err) {
                showCreateQuizError(err.message);
            } finally {
                document.getElementById('create-quiz-submit').disabled = false;
                document.getElementById('create-quiz-submit').textContent = 'Create Quiz';
            }
        }

        async function uploadNewSource(file) {
            const token = await currentUser.getIdToken();

            // Read file content
            const content = await file.arrayBuffer();

            // Convert ArrayBuffer to base64 (chunk-based to avoid stack overflow)
            const bytes = new Uint8Array(content);
            let binary = '';
            const chunkSize = 8192;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode.apply(null, chunk);
            }
            const base64Content = btoa(binary);

            // Detect content type
            const ext = file.name.split('.').pop().toLowerCase();
            let contentType = 'text/plain';
            if (ext === 'pdf') contentType = 'application/pdf';
            else if (ext === 'html' || ext === 'htm') contentType = 'text/html';
            else if (ext === 'json') contentType = 'application/json';
            else if (ext === 'csv') contentType = 'text/csv';

            const response = await fetch(`${VANDROMEDA_API}/quizmyself/source.php`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: file.name,
                    originalFilename: file.name,
                    content: base64Content,
                    contentType: contentType,
                    isBase64: true
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Upload failed');
            }

            return data.id;
        }

        async function addKeywordToAccount(keyword, sourceId = null) {
            if (!currentUser) return { success: false, error: 'Not signed in' };

            try {
                const token = await getAuthToken();
                const payload = { keyword };
                if (sourceId) payload.sourceId = sourceId;

                const response = await fetch(`${VANDROMEDA_API}/quizmyself/add-keyword.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    await loadUserKeywords();
                    await selectKeyword(keyword);
                }

                return data;
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function deleteKeywordFromAccount(keyword) {
            if (!currentUser) return { success: false, error: 'Not signed in' };

            try {
                const token = await getAuthToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/delete-keyword.php`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword })
                });

                const data = await response.json();

                if (data.success) {
                    await loadUserKeywords();

                    if (currentKeyword === keyword) {
                        if (userKeywords.length > 0) {
                            await selectKeyword(userKeywords[0].keyword);
                        } else {
                            currentKeyword = '';
                            document.getElementById('stats-bar').style.display = 'none';
                            updateHamburgerMenu();
                        }
                    }
                }

                return data;
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function checkProStatusForAccount() {
            if (!currentUser) {
                state.isPro = false;
                state.licenseKey = null;
                updateProUI();
                return;
            }

            try {
                const token = await getAuthToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/account.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.license && data.license.status === 'active') {
                        state.isPro = true;
                        state.licenseKey = data.license.license_key;
                    } else {
                        state.isPro = false;
                        state.licenseKey = null;
                    }
                }
            } catch (error) {
                console.error('Pro status check failed:', error);
            }

            updateProUI();
        }

        // ========== KEYWORD MODAL ==========

        function showKeywordManager() {
            document.getElementById('keyword-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            renderKeywordList();
            document.getElementById('hamburger-dropdown').classList.remove('show');
        }

        function closeKeywordModal() {
            document.getElementById('keyword-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Feedback Modal Functions
        function showFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            // Pre-fill email if user is logged in
            if (currentUser?.email) {
                document.getElementById('feedback-email').value = currentUser.email;
                document.getElementById('feedback-email-section').style.display = 'none';
            } else {
                document.getElementById('feedback-email').value = '';
                document.getElementById('feedback-email-section').style.display = 'block';
            }
            // Reset form
            document.getElementById('feedback-type').value = 'feedback';
            document.getElementById('feedback-message').value = '';
            document.getElementById('feedback-status').style.display = 'none';
            document.getElementById('feedback-submit').disabled = false;
            document.getElementById('feedback-submit').textContent = 'Send Feedback';
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeFeedbackModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeFeedbackModal();
            }
        }

        // Roadmap Modal Functions
        function renderSkeletonLoading() {
            return `
                <div class="skeleton-container" role="status" aria-live="polite" aria-label="Loading progress items">
                    <div class="roadmap-loading-spinner">
                        <div class="spinner"></div>
                        <div class="roadmap-loading-text">Loading progress...</div>
                    </div>
                    <div class="skeleton-item">
                        <div class="skeleton-header">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-badge"></div>
                        </div>
                        <div class="skeleton-content"></div>
                        <div class="skeleton-progress"></div>
                    </div>
                    <div class="skeleton-item">
                        <div class="skeleton-header">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-badge"></div>
                        </div>
                        <div class="skeleton-content"></div>
                        <div class="skeleton-progress"></div>
                    </div>
                    <div class="skeleton-item">
                        <div class="skeleton-header">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-badge"></div>
                        </div>
                        <div class="skeleton-content"></div>
                        <div class="skeleton-progress"></div>
                    </div>
                </div>
            `;
        }

        function renderErrorState(error) {
            return `
                <div class="roadmap-error" role="alert">
                    <div class="roadmap-error-icon">‚ö†Ô∏è</div>
                    <div class="roadmap-error-title">Unable to load progress</div>
                    <div class="roadmap-error-message">
                        ${error.message === 'Failed to fetch'
                            ? 'Please check your internet connection and try again.'
                            : 'Something went wrong. Please try again.'}
                    </div>
                    <div class="roadmap-error-actions">
                        <button class="btn btn-primary" onclick="retryLoadRoadmap()">
                            Try Again
                        </button>
                        <button class="btn" onclick="closeRoadmapModal(); showFeedbackModal();">
                            Send Feedback
                        </button>
                    </div>
                </div>
            `;
        }

        async function showRoadmapModal() {
            document.getElementById('roadmap-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('roadmap-content').innerHTML = renderSkeletonLoading();

            // Setup keyboard navigation (Story 6: Accessibility)
            setupProgressModalKeyboardNav();

            // Focus management (Story 6: Accessibility)
            focusProgressModal();

            // Fetch user's starred items if logged in (for personalized tracking)
            if (currentUser) {
                fetchUserStarredItems();
            }

            // Load the roadmap data
            await loadRoadmapData();
        }

        async function loadRoadmapData() {
            try {
                // Fetch feedback data from API (now includes milestones directly)
                let data = await fetchFeedbackData();
                if (!data) {
                    throw new Error('Failed to load feedback data');
                }

                // Check if API returned milestones (new reconcile endpoint)
                if (data.milestones && data.milestones.length > 0) {
                    console.log('Using milestones from API:', data.milestones.length);
                    currentRoadmapData = { milestones: data.milestones };
                } else {
                    // Fallback: fetch roadmap.json for milestones (old path)
                    try {
                        const roadmapResponse = await fetch('roadmap.json');
                        if (roadmapResponse.ok) {
                            const roadmapData = await roadmapResponse.json();
                            if (roadmapData) {
                                currentRoadmapData = roadmapData;
                                console.log('Loaded roadmap.json fallback:', {
                                    milestones: roadmapData.milestones?.length || 0,
                                    issues: roadmapData.issues?.length || 0
                                });
                                // Merge milestone info into feedback items
                                data = mergeMilestoneData(data, roadmapData);
                            }
                        }
                    } catch (e) {
                        console.warn('roadmap.json fallback failed:', e.message);
                    }
                }

                renderRoadmapFromFeedback(data);
                announceToScreenReader(`Loaded ${data.feedback?.length || 0} progress items`);
            } catch (error) {
                console.error('Failed to load roadmap:', error);
                document.getElementById('roadmap-content').innerHTML = renderErrorState(error);
                announceToScreenReader('Failed to load progress items');
            }
        }

        // Fetch feedback data from API (tries reconcile first, then fallback)
        async function fetchFeedbackData() {
            // Try reconcile endpoint first (syncs with GitHub)
            try {
                const reconcileResponse = await fetch(`${VANDROMEDA_API}/quizmyself/reconcile-feedback.php?product=quizmyself`);
                if (reconcileResponse.ok) {
                    const reconcileData = await reconcileResponse.json();
                    if (reconcileData.success && reconcileData.feedback?.length > 0) {
                        console.log('Loaded via reconcile:', reconcileData.reconciliation);
                        return reconcileData;
                    }
                }
            } catch (e) {
                console.warn('Reconcile endpoint failed, falling back:', e.message);
            }

            // Fall back to simple feedback endpoint
            const feedbackResponse = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php?product=quizmyself&public=true`);
            if (!feedbackResponse.ok) throw new Error('Failed to load roadmap');
            const data = await feedbackResponse.json();
            if (!data.success) throw new Error(data.error || 'Failed to load');
            console.log('Loaded via fallback feedback endpoint');
            return data;
        }

        // Merge milestone data from roadmap.json into feedback items
        function mergeMilestoneData(feedbackData, roadmapData) {
            if (!roadmapData?.issues || !feedbackData?.feedback) {
                return feedbackData;
            }

            // Create a map of issue number -> milestone
            const issueMilestoneMap = {};
            roadmapData.issues.forEach(issue => {
                if (issue.milestone) {
                    issueMilestoneMap[issue.number] = issue.milestone;
                }
            });

            // Add milestone to each feedback item
            feedbackData.feedback = feedbackData.feedback.map(item => {
                if (item.github_issue && issueMilestoneMap[item.github_issue]) {
                    return { ...item, milestone: issueMilestoneMap[item.github_issue] };
                }
                return item;
            });

            // Add milestones array to feedback data for rendering milestone cards
            feedbackData.milestones = roadmapData.milestones || [];

            return feedbackData;
        }

        function retryLoadRoadmap() {
            document.getElementById('roadmap-content').innerHTML = renderSkeletonLoading();
            loadRoadmapData();
        }

        function closeRoadmapModal() {
            document.getElementById('roadmap-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeRoadmapModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeRoadmapModal();
            }
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);

            if (diffDays < 1) {
                if (diffHours < 1) return 'just now';
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays === 1) {
                return 'yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else if (diffWeeks < 4) {
                return `${diffWeeks} week${diffWeeks > 1 ? 's' : ''} ago`;
            } else {
                return `${diffMonths} month${diffMonths > 1 ? 's' : ''} ago`;
            }
        }

        // Format date as full human-readable string for tooltips
        function formatFullDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function renderRoadmap(data) {
            const container = document.getElementById('roadmap-content');
            let html = '';

            // Stats bar
            const openCount = data.issues?.filter(i => i.state === 'open').length || 0;
            const closedCount = data.issues?.filter(i => i.state === 'closed').length || 0;
            const totalCount = openCount + closedCount;

            html += `
                <div class="roadmap-stats">
                    <div class="stat">
                        <div class="stat-value">${openCount}</div>
                        <div class="stat-label">Open</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${closedCount}</div>
                        <div class="stat-label">Closed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${totalCount}</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            `;

            // Milestones section
            if (data.milestones && data.milestones.length > 0) {
                html += '<div class="roadmap-section"><h3>Milestones</h3>';
                data.milestones.forEach(milestone => {
                    const progress = milestone.open_issues + milestone.closed_issues > 0
                        ? Math.round((milestone.closed_issues / (milestone.open_issues + milestone.closed_issues)) * 100)
                        : 0;
                    html += `
                        <div class="roadmap-item">
                            <div class="roadmap-item-header">
                                <div class="roadmap-item-title">${escapeHtml(milestone.title)}</div>
                                <div class="roadmap-item-meta">${progress}%</div>
                            </div>
                            ${milestone.description ? `<div style="color: #888; font-size: 0.85rem;">${escapeHtml(milestone.description)}</div>` : ''}
                            <div class="roadmap-progress">
                                <div class="roadmap-progress-bar">
                                    <div class="roadmap-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div class="roadmap-progress-text">${milestone.closed_issues} of ${milestone.open_issues + milestone.closed_issues} completed</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Open issues section
            const openIssues = data.issues?.filter(i => i.state === 'open') || [];
            if (openIssues.length > 0) {
                html += '<div class="roadmap-section"><h3>Open Issues</h3>';
                openIssues.forEach(issue => {
                    html += renderIssueItem(issue);
                });
                html += '</div>';
            }

            // Recently completed section
            const closedIssues = data.issues?.filter(i => i.state === 'closed').slice(0, 5) || [];
            if (closedIssues.length > 0) {
                html += '<div class="roadmap-section"><h3>Recently Completed</h3>';
                closedIssues.forEach(issue => {
                    html += renderIssueItem(issue);
                });
                html += '</div>';
            }

            if (!data.milestones?.length && !data.issues?.length) {
                html = `
                    <div class="roadmap-empty">
                        <p>Progress updates coming soon! Submit feedback to help shape our priorities.</p>
                        <button class="btn btn-primary" onclick="closeRoadmapModal(); showFeedbackModal();">Send Feedback</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderIssueItem(issue) {
            const labelColors = {
                'bug': 'bug',
                'enhancement': 'enhancement',
                'question': 'question',
                'feature': 'feature'
            };

            let labelsHtml = '';
            if (issue.labels && issue.labels.length > 0) {
                labelsHtml = '<div class="roadmap-labels">' + issue.labels.map(label => {
                    const labelName = typeof label === 'string' ? label : label.name;
                    const colorClass = labelColors[labelName.toLowerCase()] || 'default';
                    return `<span class="roadmap-label ${colorClass}">${escapeHtml(labelName)}</span>`;
                }).join('') + '</div>';
            }

            const timeAgo = issue.created_at ? formatRelativeTime(issue.created_at) : '';

            // Build reference numbers (feedback ID and/or GitHub issue)
            let refHtml = '';
            if (issue.feedback_id || issue.number) {
                const refs = [];
                if (issue.feedback_id) refs.push(`#${issue.feedback_id}`);
                if (issue.number && issue.url) {
                    refs.push(`<a href="${escapeAttr(issue.url)}" target="_blank" rel="noopener" style="color: #4fc3f7;">GH-${issue.number}</a>`);
                } else if (issue.number) {
                    refs.push(`GH-${issue.number}`);
                }
                refHtml = `<span class="roadmap-item-refs">${refs.join(' | ')}</span>`;
            }

            return `
                <div class="roadmap-item">
                    <div class="roadmap-item-header">
                        <div class="roadmap-item-title">${refHtml}${escapeHtml(issue.title)}</div>
                        <div class="roadmap-item-meta">${timeAgo}</div>
                    </div>
                    ${labelsHtml}
                </div>
            `;
        }

        // Store current feedback data for filtering
        let currentFeedbackData = null;
        let currentRoadmapData = null; // Milestones and issue-milestone mapping from roadmap.json
        let activeFilters = new Set();
        let activeStatusFilter = null; // null = all, or 'new', 'in_progress', 'resolved', 'reviewed', 'wont_fix'
        let activeMilestoneFilter = null; // null = all, or milestone title like 'M1: Beta Launch'
        let progressSearchText = '';
        let progressSortOption = 'priority'; // 'priority', 'newest', 'oldest', 'alphabetical'

        // Search and sort handlers
        function handleProgressSearch(event) {
            progressSearchText = event.target.value.toLowerCase().trim();
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
        }

        function clearProgressSearch() {
            progressSearchText = '';
            const searchInput = document.querySelector('.progress-search-input');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
        }

        function handleProgressSort(event) {
            progressSortOption = event.target.value;
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
        }

        function sortProgressItems(items) {
            switch (progressSortOption) {
                case 'priority':
                    return [...items].sort((a, b) => calculatePriorityScore(b) - calculatePriorityScore(a));
                case 'newest':
                    return [...items].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                case 'oldest':
                    return [...items].sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
                case 'alphabetical':
                    return [...items].sort((a, b) => (a.message || '').localeCompare(b.message || ''));
                default:
                    return items;
            }
        }

        function filterBySearchText(items) {
            if (!progressSearchText) return items;
            return items.filter(item => {
                const message = (item.message || '').toLowerCase();
                const type = (item.type || '').toLowerCase();
                const status = (item.status || '').toLowerCase();
                return message.includes(progressSearchText) ||
                       type.includes(progressSearchText) ||
                       status.includes(progressSearchText);
            });
        }

        function renderSearchSortBar(totalCount) {
            return `
                <div class="progress-search-sort-bar" role="search" aria-label="Search and sort progress items">
                    <div class="progress-search-container">
                        <input type="text"
                            class="progress-search-input"
                            placeholder="Search items..."
                            value="${escapeAttr(progressSearchText)}"
                            oninput="handleProgressSearch(event)"
                            aria-label="Search progress items"
                        />
                        ${progressSearchText ? `
                            <button class="progress-search-clear"
                                onclick="clearProgressSearch()"
                                aria-label="Clear search"
                                title="Clear search">
                                √ó
                            </button>
                        ` : ''}
                    </div>
                    <div class="progress-sort-container">
                        <label class="progress-sort-label" for="progress-sort">Sort by:</label>
                        <select id="progress-sort"
                            class="progress-sort-select"
                            onchange="handleProgressSort(event)"
                            aria-label="Sort progress items">
                            <option value="priority" ${progressSortOption === 'priority' ? 'selected' : ''}>Priority</option>
                            <option value="newest" ${progressSortOption === 'newest' ? 'selected' : ''}>Newest First</option>
                            <option value="oldest" ${progressSortOption === 'oldest' ? 'selected' : ''}>Oldest First</option>
                            <option value="alphabetical" ${progressSortOption === 'alphabetical' ? 'selected' : ''}>A-Z</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function renderRoadmapFromFeedback(data) {
            currentFeedbackData = data;
            const container = document.getElementById('roadmap-content');
            const feedback = data.feedback || [];
            const stats = data.stats || {};
            let html = '';

            // Product Vision Section - tied to business objectives
            html += `
                <div class="progress-vision" role="region" aria-label="Product vision">
                    <div class="progress-vision-title">Product Vision</div>
                    <div class="progress-vision-text">
                        Empower learners to master any subject through self-paced quizzing with AI-generated questions,
                        progress tracking, and spaced repetition.
                    </div>
                    <div class="progress-goals" role="list" aria-label="Product goals">
                        <span class="progress-goal" role="listitem"><span class="progress-goal-icon" aria-hidden="true">&#9889;</span> Fast quiz creation</span>
                        <span class="progress-goal" role="listitem"><span class="progress-goal-icon" aria-hidden="true">&#128202;</span> Track progress</span>
                        <span class="progress-goal" role="listitem"><span class="progress-goal-icon" aria-hidden="true">&#129302;</span> AI-powered learning</span>
                        <span class="progress-goal" role="listitem"><span class="progress-goal-icon" aria-hidden="true">&#128274;</span> Sync across devices</span>
                    </div>
                    <div class="progress-last-update">Updated iteratively based on user feedback</div>
                </div>
            `;

            // View Toggle (Story 6: themes vs status view)
            html += renderViewToggle();

            // Stats bar with clickable status filters
            const statusCounts = stats.by_status || {};
            const openCount = (statusCounts.new || 0) + (statusCounts.reviewed || 0);
            const inProgressCount = statusCounts.in_progress || 0;
            const resolvedCount = (statusCounts.resolved || 0) + (statusCounts.wont_fix || 0);

            html += `
                <div class="roadmap-stats" role="region" aria-label="Progress statistics">
                    <button class="stat stat-btn ${activeStatusFilter === 'open' ? 'active' : ''}" role="group" aria-label="Open items" onclick="toggleStatusFilter('open')" aria-pressed="${activeStatusFilter === 'open'}">
                        <div class="stat-value" aria-hidden="true">${openCount}</div>
                        <div class="stat-label">Open</div>
                        <span class="sr-only">${openCount} open items. Click to filter.</span>
                    </button>
                    <button class="stat stat-btn ${activeStatusFilter === 'in_progress' ? 'active' : ''}" role="group" aria-label="Items in progress" onclick="toggleStatusFilter('in_progress')" aria-pressed="${activeStatusFilter === 'in_progress'}">
                        <div class="stat-value" aria-hidden="true">${inProgressCount}</div>
                        <div class="stat-label">In Progress</div>
                        <span class="sr-only">${inProgressCount} items in progress. Click to filter.</span>
                    </button>
                    <button class="stat stat-btn ${activeStatusFilter === 'resolved' ? 'active' : ''}" role="group" aria-label="Resolved items" onclick="toggleStatusFilter('resolved')" aria-pressed="${activeStatusFilter === 'resolved'}">
                        <div class="stat-value" aria-hidden="true">${resolvedCount}</div>
                        <div class="stat-label">Resolved</div>
                        <span class="sr-only">${resolvedCount} resolved items. Click to filter.</span>
                    </button>
                    <button class="stat stat-btn ${activeStatusFilter === null ? 'active' : ''}" role="group" aria-label="Total items" onclick="toggleStatusFilter(null)" aria-pressed="${activeStatusFilter === null}">
                        <div class="stat-value" aria-hidden="true">${stats.total || 0}</div>
                        <div class="stat-label">Total</div>
                        <span class="sr-only">${stats.total || 0} total items. Click to show all.</span>
                    </button>
                </div>
            `;

            // If themes view is selected, render that instead of status view
            if (currentProgressView === 'themes') {
                html += renderThemesView(feedback);
                container.innerHTML = html;
                return;
            }

            // Search and Sort Bar
            if (feedback.length > 0) {
                html += renderSearchSortBar(feedback.length);
            }

            // Category Filter Bar
            if (feedback.length > 0) {
                const typeCounts = {};
                feedback.forEach(item => {
                    const type = item.type || 'other';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });

                const typeLabels = {
                    'feature': 'Features',
                    'bug': 'Bugs',
                    'question': 'Questions',
                    'request': 'Requests',
                    'feedback': 'Feedback'
                };

                const typeIcons = {
                    'feature': '‚ú®',
                    'bug': 'üêõ',
                    'question': '‚ùì',
                    'request': 'üìù',
                    'feedback': 'üí¨'
                };

                html += '<div class="progress-filter-bar">';
                html += '<span class="filter-label">Type:</span>';
                html += `<button class="progress-filter-chip ${activeFilters.size === 0 ? 'active' : ''}" data-type="all" onclick="toggleProgressFilter('all')">All <span class="count">${feedback.length}</span></button>`;

                Object.keys(typeCounts).sort().forEach(type => {
                    const isActive = activeFilters.has(type);
                    const label = typeLabels[type] || type.charAt(0).toUpperCase() + type.slice(1);
                    const icon = typeIcons[type] || 'üìã';
                    html += `<button class="progress-filter-chip ${isActive ? 'active' : ''}" data-type="${escapeAttr(type)}" onclick="toggleProgressFilter('${escapeAttr(type)}')">${icon} ${label} <span class="count">${typeCounts[type]}</span></button>`;
                });
                html += '</div>';

                // Milestone Filter Bar
                const milestones = data.milestones || [];
                if (milestones.length > 0) {
                    // Count items per milestone
                    const milestoneCounts = {};
                    feedback.forEach(item => {
                        const ms = item.milestone || 'Unassigned';
                        milestoneCounts[ms] = (milestoneCounts[ms] || 0) + 1;
                    });

                    html += '<div class="progress-filter-bar milestone-filter-bar">';
                    html += '<span class="filter-label">Milestone:</span>';
                    html += `<button class="progress-filter-chip milestone-chip ${activeMilestoneFilter === null ? 'active' : ''}" onclick="toggleMilestoneFilter(null)">All</button>`;

                    milestones.forEach(ms => {
                        const isActive = activeMilestoneFilter === ms.title;
                        const shortTitle = ms.title.split(':')[0]; // "M1: Beta Launch" -> "M1"
                        const count = milestoneCounts[ms.title] || 0;
                        html += `<button class="progress-filter-chip milestone-chip ${isActive ? 'active' : ''}" onclick="toggleMilestoneFilter('${escapeAttr(ms.title)}')" title="${escapeAttr(ms.title)}">${shortTitle} <span class="count">${count}</span></button>`;
                    });

                    // Show unassigned count if any
                    const unassignedCount = milestoneCounts['Unassigned'] || 0;
                    if (unassignedCount > 0) {
                        const isActive = activeMilestoneFilter === 'Unassigned';
                        html += `<button class="progress-filter-chip milestone-chip ${isActive ? 'active' : ''}" onclick="toggleMilestoneFilter('Unassigned')">Unassigned <span class="count">${unassignedCount}</span></button>`;
                    }
                    html += '</div>';
                }
            }

            // Apply category filter (type)
            let filteredFeedback = activeFilters.size === 0
                ? feedback
                : feedback.filter(f => activeFilters.has(f.type));

            // Apply status filter
            if (activeStatusFilter) {
                filteredFeedback = filteredFeedback.filter(f => {
                    if (activeStatusFilter === 'open') {
                        return f.status === 'new' || f.status === 'reviewed';
                    } else if (activeStatusFilter === 'resolved') {
                        return f.status === 'resolved' || f.status === 'wont_fix';
                    } else {
                        return f.status === activeStatusFilter;
                    }
                });
            }

            // Apply milestone filter
            if (activeMilestoneFilter) {
                filteredFeedback = filteredFeedback.filter(f => {
                    if (activeMilestoneFilter === 'Unassigned') {
                        return !f.milestone;
                    }
                    return f.milestone === activeMilestoneFilter;
                });
            }

            // Apply search filter
            filteredFeedback = filterBySearchText(filteredFeedback);

            // Show result count if search is active
            if (progressSearchText && feedback.length > 0) {
                html += `<div class="progress-result-count" role="status" aria-live="polite">
                    Showing <strong>${filteredFeedback.length}</strong> of ${feedback.length} items
                </div>`;
            }

            // Show no results message if search returns empty
            if (progressSearchText && filteredFeedback.length === 0) {
                html += `
                    <div class="progress-no-results" role="status" aria-live="polite">
                        <span class="progress-no-results-icon" aria-hidden="true">üîç</span>
                        <p>No items match "<strong>${escapeHtml(progressSearchText)}</strong>"</p>
                        <p>Try a different search term or <button class="link-btn" onclick="clearProgressSearch()">clear the search</button></p>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }

            // Group feedback by status and sort using selected sort option
            const openItems = sortProgressItems(filteredFeedback.filter(f => !f.is_resolved && f.status !== 'in_progress'));
            const inProgressItems = sortProgressItems(filteredFeedback.filter(f => f.status === 'in_progress'));
            const resolvedItems = sortProgressItems(filteredFeedback.filter(f => f.is_resolved));

            // Milestone Progress Cards (from GitHub milestones)
            const milestonesData = data.milestones || [];
            if (milestonesData.length > 0) {
                html += '<div class="milestones-grid">';
                milestonesData.forEach(ms => {
                    const totalIssues = ms.openIssues + ms.closedIssues;
                    const progress = totalIssues > 0 ? ms.progress : 0;
                    const circumference = 2 * Math.PI * 18;
                    const dashOffset = circumference - (progress / 100) * circumference;
                    const shortTitle = ms.title.split(':')[0]; // "M1: Beta Launch" -> "M1"
                    const fullTitle = ms.title.split(': ')[1] || ms.title; // "Beta Launch"
                    const isActive = activeMilestoneFilter === ms.title;
                    const dueDate = ms.dueDate ? new Date(ms.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : null;

                    html += `
                        <button class="milestone-card milestone-card-clickable ${isActive ? 'active' : ''}" onclick="toggleMilestoneFilter('${escapeAttr(ms.title)}')">
                            <div class="milestone-header">
                                <div class="milestone-title">
                                    <span class="milestone-title-icon">${shortTitle}</span>
                                    ${escapeHtml(fullTitle)}
                                </div>
                                <div class="milestone-progress-ring">
                                    <svg width="50" height="50">
                                        <circle class="bg" cx="25" cy="25" r="18"></circle>
                                        <circle class="progress" cx="25" cy="25" r="18"
                                            stroke-dasharray="${circumference}"
                                            stroke-dashoffset="${dashOffset}"></circle>
                                    </svg>
                                    <div class="milestone-progress-percent">${progress}%</div>
                                </div>
                            </div>
                            <div class="milestone-stats">
                                <span class="milestone-stat">
                                    <span class="milestone-stat-icon">üìã</span>
                                    ${ms.openIssues} open
                                </span>
                                <span class="milestone-stat">
                                    <span class="milestone-stat-icon">‚úÖ</span>
                                    ${ms.closedIssues} done
                                </span>
                                ${dueDate ? `<span class="milestone-stat"><span class="milestone-stat-icon">üìÖ</span> ${dueDate}</span>` : ''}
                            </div>
                        </button>
                    `;
                });
                html += '</div>';
            }

            // Timeline view for active items (in progress + recently resolved)
            const timelineItems = [...inProgressItems, ...resolvedItems.slice(0, 3)];
            if (timelineItems.length > 0) {
                html += '<div class="roadmap-section"><h3>Timeline</h3>';
                html += '<div class="progress-timeline">';
                timelineItems.forEach(item => {
                    html += renderTimelineItem(item);
                });
                html += '</div></div>';
            }

            // Open section (items awaiting work)
            if (openItems.length > 0) {
                html += '<div class="roadmap-section"><h3>Backlog</h3>';
                openItems.forEach(item => {
                    html += renderFeedbackItem(item);
                });
                html += '</div>';
            }

            // Additional resolved items (beyond the 3 shown in timeline)
            const additionalResolved = resolvedItems.slice(3);
            if (additionalResolved.length > 0) {
                html += '<div class="roadmap-section"><h3>Previously Completed</h3>';
                additionalResolved.forEach(item => {
                    html += renderFeedbackItem(item);
                });
                html += '</div>';
            }

            if (filteredFeedback.length === 0 && feedback.length > 0) {
                html += `
                    <div class="roadmap-empty" role="status">
                        <div class="roadmap-empty-icon">üîç</div>
                        <div class="roadmap-empty-title">No matching items</div>
                        <div class="roadmap-empty-message">No items match the selected filters. Try adjusting your filters or clear them to see all items.</div>
                        <button class="btn" onclick="toggleProgressFilter('all')">Clear Filters</button>
                    </div>
                `;
            } else if (feedback.length === 0) {
                html += `
                    <div class="roadmap-empty" role="status">
                        <div class="roadmap-empty-icon">üìã</div>
                        <div class="roadmap-empty-title">No progress items yet</div>
                        <div class="roadmap-empty-message">Be the first to help shape our priorities! Submit feedback to get started.</div>
                        <button class="btn btn-primary" onclick="closeRoadmapModal(); showFeedbackModal();">Send Feedback</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Toggle category filter (type: feature, bug, etc.)
        function toggleProgressFilter(type) {
            if (type === 'all') {
                activeFilters.clear();
            } else if (activeFilters.has(type)) {
                activeFilters.delete(type);
            } else {
                activeFilters.add(type);
            }
            // Re-render with current data
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
        }

        // Toggle status filter (open, in_progress, resolved)
        function toggleStatusFilter(status) {
            if (activeStatusFilter === status) {
                // Clicking same filter again clears it (show all)
                activeStatusFilter = null;
            } else {
                activeStatusFilter = status;
            }
            // Re-render with current data
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
            // Announce change to screen readers
            const label = status === 'open' ? 'open' : status === 'in_progress' ? 'in progress' : status === 'resolved' ? 'resolved' : 'all';
            announceToScreenReader(`Showing ${label} items`);
        }

        function toggleMilestoneFilter(milestone) {
            if (activeMilestoneFilter === milestone) {
                // Clicking same filter again clears it (show all)
                activeMilestoneFilter = null;
            } else {
                activeMilestoneFilter = milestone;
            }
            // Re-render with current data
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
            // Announce change to screen readers
            const label = milestone ? milestone : 'all milestones';
            announceToScreenReader(`Showing items from ${label}`);
        }

        // Toggle item expansion
        function toggleItemExpand(itemId) {
            const item = document.querySelector(`.roadmap-item[data-item-id="${itemId}"]`);
            if (item) {
                const isExpanded = item.classList.toggle('expanded');
                // Update aria-expanded for accessibility (Story 6)
                item.setAttribute('aria-expanded', isExpanded.toString());
                // Announce to screen readers
                announceToScreenReader(isExpanded ? 'Item expanded' : 'Item collapsed');
            }
        }

        // Generate unique type-prefixed ID (e.g., F-1 for feature, B-2 for bug)
        function getTypePrefixedId(item) {
            const typePrefixes = {
                'feature': 'F',
                'bug': 'B',
                'question': 'Q',
                'request': 'R',
                'feedback': 'FB'
            };
            const prefix = typePrefixes[item.type] || 'I';
            return `${prefix}-${item.id}`;
        }

        // Calculate item priority score based on engagement metrics
        function calculatePriorityScore(item) {
            let score = 0;

            // Higher score for bugs (critical)
            if (item.type === 'bug') score += 30;
            // Features get moderate boost
            else if (item.type === 'feature') score += 20;
            // Questions/requests are lower priority
            else if (item.type === 'question') score += 10;
            else if (item.type === 'request') score += 15;

            // Engagement metrics boost
            if (item.stars_count) score += item.stars_count * 5;
            if (item.comments_count) score += item.comments_count * 3;
            if (item.views_count) score += Math.min(item.views_count, 100) / 10;

            // Age factor - newer items get slight boost
            if (item.created_at) {
                const daysSinceCreation = (Date.now() - new Date(item.created_at).getTime()) / (1000 * 60 * 60 * 24);
                if (daysSinceCreation < 7) score += 10;
                else if (daysSinceCreation < 30) score += 5;
            }

            // GitHub linkage indicates importance
            if (item.github_issue) score += 10;

            return score;
        }

        // Get priority level from score
        function getPriorityLevel(score) {
            if (score >= 40) return { level: 'high', label: 'High' };
            if (score >= 20) return { level: 'medium', label: 'Med' };
            return { level: 'low', label: 'Low' };
        }

        // Get SDLC stage info for an item
        function getSDLCStageInfo(item) {
            const stages = ['submitted', 'triaged', 'development', 'testing', 'deployed'];
            const stageLabels = ['Submit', 'Triage', 'Dev', 'Test', 'Deploy'];

            // Map status to SDLC stage
            const statusToStage = {
                'new': 0,           // Submitted
                'reviewed': 1,      // Triaged
                'in_progress': 2,   // Development
                'testing': 3,       // Testing
                'resolved': 4       // Deployed
            };

            // Use sdlc_stage from API if available, otherwise infer from status
            let currentStageIndex = item.sdlc_stage !== undefined
                ? item.sdlc_stage
                : (statusToStage[item.status] !== undefined ? statusToStage[item.status] : 0);

            // Resolved items are at the final stage
            if (item.is_resolved) currentStageIndex = 4;

            return {
                stages,
                stageLabels,
                currentStageIndex,
                totalStages: stages.length
            };
        }

        // Render SDLC progress bar for an item
        function renderSDLCProgress(item) {
            const { stages, stageLabels, currentStageIndex, totalStages } = getSDLCStageInfo(item);

            let stagesHtml = '<div class="sdlc-stages">';
            let labelsHtml = '<div class="sdlc-stage-labels">';

            for (let i = 0; i < totalStages; i++) {
                let stageClass = '';
                let labelClass = '';

                if (i < currentStageIndex) {
                    stageClass = 'completed';
                    labelClass = 'completed';
                } else if (i === currentStageIndex) {
                    stageClass = 'current';
                    labelClass = 'current';
                }

                stagesHtml += `<div class="sdlc-stage ${stageClass}"></div>`;
                labelsHtml += `<span class="${labelClass}">${stageLabels[i]}</span>`;
            }

            stagesHtml += '</div>';
            labelsHtml += '</div>';

            return stagesHtml + labelsHtml;
        }

        function renderTimelineItem(item) {
            const statusClass = item.is_resolved ? 'completed' : (item.status === 'in_progress' ? 'in-progress' : 'pending');
            const timeAgo = item.created_at ? formatRelativeTime(item.created_at) : '';
            const fullDate = item.created_at ? formatFullDate(item.created_at) : '';
            const typeIdBadgeClass = item.type || 'feedback';
            const typeId = getTypePrefixedId(item);

            // Priority indicator
            const priorityScore = calculatePriorityScore(item);
            const priority = getPriorityLevel(priorityScore);

            // Build reference numbers
            let refHtml = '';
            if (item.github_issue && item.github_issue_url) {
                refHtml = ` <a href="${escapeAttr(item.github_issue_url)}" target="_blank" rel="noopener" style="color: #4fc3f7; font-size: 0.75rem;">GH-${item.github_issue}</a>`;
            }

            // Milestone badge
            const milestoneBadge = item.milestone
                ? `<span class="milestone-badge" title="${escapeAttr(item.milestone)}">${item.milestone.split(':')[0]}</span>`
                : '';

            return `
                <div class="timeline-item ${statusClass}" data-item-id="${item.id}">
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-title">
                                <span class="type-id-badge ${typeIdBadgeClass}">${typeId}</span>
                                ${milestoneBadge}
                                ${escapeHtml(item.title)}
                                <span class="item-priority ${priority.level}">${priority.label}</span>
                            </span>
                            <span class="timeline-date timestamp-relative" title="${escapeAttr(fullDate)}">${timeAgo}</span>
                            ${renderStarButton(item)}
                        </div>
                        <div class="timeline-description">
                            <span class="roadmap-label ${typeIdBadgeClass === 'feature' ? 'enhancement' : typeIdBadgeClass}" style="margin-right: 8px;">${escapeHtml(item.type)}</span>
                            ${refHtml}
                            ${renderGitHubIntegration(item)}
                        </div>
                        ${renderAssignees(item)}
                        ${renderSDLCProgress(item)}
                    </div>
                </div>
            `;
        }

        // Build lifecycle events for an item
        function buildLifecycleEvents(item) {
            const events = [];

            // Birth event (created)
            if (item.created_at) {
                events.push({
                    type: 'birth',
                    icon: 'üå±',
                    description: `${item.type || 'Item'} submitted`,
                    timestamp: item.created_at
                });
            }

            // Infer status changes from current status
            const statusOrder = ['new', 'reviewed', 'in_progress', 'testing', 'resolved'];
            const currentIndex = statusOrder.indexOf(item.status);

            if (currentIndex >= 1) {
                events.push({
                    type: 'status-change',
                    icon: 'üëÅÔ∏è',
                    description: 'Reviewed and triaged',
                    timestamp: item.reviewed_at || item.updated_at
                });
            }
            if (currentIndex >= 2) {
                events.push({
                    type: 'status-change',
                    icon: 'üîß',
                    description: 'Development started',
                    timestamp: item.started_at || item.updated_at
                });
            }
            if (currentIndex >= 3) {
                events.push({
                    type: 'status-change',
                    icon: 'üß™',
                    description: 'Moved to testing',
                    timestamp: item.testing_at || item.updated_at
                });
            }

            // Update event (if updated after creation)
            if (item.updated_at && item.updated_at !== item.created_at && !item.is_resolved) {
                events.push({
                    type: 'update',
                    icon: 'üìù',
                    description: 'Last updated',
                    timestamp: item.updated_at
                });
            }

            // Resolved event
            if (item.is_resolved) {
                events.push({
                    type: 'resolved',
                    icon: '‚úÖ',
                    description: 'Resolved and deployed',
                    timestamp: item.resolved_at || item.updated_at
                });
            }

            return events;
        }

        // Calculate item progress percentage based on SDLC stage
        function calculateItemProgress(item) {
            const { currentStageIndex, totalStages } = getSDLCStageInfo(item);
            return Math.round((currentStageIndex / (totalStages - 1)) * 100);
        }

        // Render dependencies section for an item
        function renderDependencies(item) {
            const dependencies = item.dependencies || [];
            if (dependencies.length === 0) return '';

            let html = '<div class="item-dependencies">';
            html += '<div class="lifecycle-section-title">Dependencies</div>';

            dependencies.forEach(dep => {
                const isResolved = dep.is_resolved || dep.status === 'resolved';
                const iconClass = isResolved ? 'resolved' : '';
                const statusClass = isResolved ? 'done' : 'pending';
                const statusLabel = isResolved ? 'Done' : 'Pending';
                const depTypeId = getTypePrefixedId(dep);

                html += `
                    <div class="dependency-item">
                        <span class="dep-icon ${iconClass}">${isResolved ? '‚úì' : '‚óã'}</span>
                        <span class="type-id-badge ${dep.type || 'feedback'}" style="font-size: 0.65rem;">${depTypeId}</span>
                        <span class="dep-title">${escapeHtml(dep.title || 'Linked item')}</span>
                        <span class="dep-status ${statusClass}">${statusLabel}</span>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function renderFeedbackItem(item) {
            const typeColors = {
                'bug': 'bug',
                'feature': 'enhancement',
                'question': 'question',
                'feedback': 'default'
            };

            const statusColors = {
                'new': '#888',
                'reviewed': '#4fc3f7',
                'in_progress': '#ffa726',
                'resolved': '#4caf50',
                'wont_fix': '#666'
            };

            const colorClass = typeColors[item.type] || 'default';
            const typeIdBadgeClass = item.type || 'feedback';
            const typeId = getTypePrefixedId(item);
            const timeAgo = item.created_at ? formatRelativeTime(item.created_at) : '';
            const fullDate = item.created_at ? formatFullDate(item.created_at) : '';

            // Priority indicator
            const priorityScore = calculatePriorityScore(item);
            const priority = getPriorityLevel(priorityScore);

            // Item progress percentage
            const progressPercent = calculateItemProgress(item);

            // Status badge
            const statusHtml = `<span class="roadmap-status" style="color: ${statusColors[item.status] || '#888'};">${escapeHtml(item.status_label)}</span>`;

            // Build registration/metadata section
            let registrationHtml = '<div class="item-registration">';

            // API Registration ID
            registrationHtml += `
                <div class="item-registration-entry">
                    <span class="icon">üìù</span>
                    <span>API #${item.id}</span>
                </div>
            `;

            // GitHub Issue Link
            if (item.github_issue && item.github_issue_url) {
                registrationHtml += `
                    <div class="item-registration-entry">
                        <span class="icon">üîó</span>
                        <a href="${escapeAttr(item.github_issue_url)}" target="_blank" rel="noopener">GitHub #${item.github_issue}</a>
                    </div>
                `;
            }

            // Created timestamp
            if (item.created_at) {
                registrationHtml += `
                    <div class="item-registration-entry">
                        <span class="icon">üìÖ</span>
                        <span class="timestamp-relative" title="${escapeAttr(fullDate)}">Created ${timeAgo}</span>
                    </div>
                `;
            }

            // Updated timestamp (if different from created)
            if (item.updated_at && item.updated_at !== item.created_at) {
                const updatedFullDate = formatFullDate(item.updated_at);
                registrationHtml += `
                    <div class="item-registration-entry">
                        <span class="icon">üîÑ</span>
                        <span class="timestamp-relative" title="${escapeAttr(updatedFullDate)}">Updated ${formatRelativeTime(item.updated_at)}</span>
                    </div>
                `;
            }

            registrationHtml += '</div>';

            // Build lifecycle section (hidden by default, shown when expanded)
            const lifecycleEvents = buildLifecycleEvents(item);
            let lifecycleHtml = '<div class="item-lifecycle">';

            // Collapse button
            lifecycleHtml += `<button class="lifecycle-collapse-btn" onclick="event.stopPropagation(); toggleItemExpand(${item.id});" aria-label="Collapse details" title="Collapse">√ó</button>`;

            // Lifecycle events history
            lifecycleHtml += '<div class="lifecycle-section">';
            lifecycleHtml += '<div class="lifecycle-section-title">History</div>';
            lifecycleEvents.forEach(event => {
                const eventDate = event.timestamp
                    ? new Date(event.timestamp).toLocaleDateString('en-US', {
                        month: 'short', day: 'numeric', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    })
                    : '';
                lifecycleHtml += `
                    <div class="lifecycle-event ${event.type}">
                        <span class="lifecycle-event-icon">${event.icon}</span>
                        <div class="lifecycle-event-content">
                            <div class="lifecycle-event-description">${escapeHtml(event.description)}</div>
                            <div class="lifecycle-event-timestamp">${eventDate}</div>
                        </div>
                    </div>
                `;
            });
            lifecycleHtml += '</div>';

            // Dependencies (if any)
            lifecycleHtml += renderDependencies(item);

            // Item-level progress bar
            lifecycleHtml += `
                <div class="lifecycle-section">
                    <div class="lifecycle-section-title">Completion</div>
                    <div class="item-progress-bar">
                        <div class="item-progress-track">
                            <div class="item-progress-fill" style="width: ${progressPercent}%;"></div>
                        </div>
                        <span class="item-progress-text">${progressPercent}%</span>
                    </div>
                </div>
            `;

            lifecycleHtml += '</div>';

            // Render collaboration section (comments, assignees)
            const collaborationHtml = renderCollaborationSection(item);

            // Story 6: Custom Fields and Automation Rules
            const customFieldsHtml = renderCustomFields(item);
            const automationRulesHtml = renderAutomationRules(item);

            // Milestone badge
            const milestoneBadge = item.milestone
                ? `<span class="milestone-badge" title="${escapeAttr(item.milestone)}">${item.milestone.split(':')[0]}</span>`
                : '';

            return `
                <div class="roadmap-item expandable" data-item-id="${item.id}" onclick="toggleItemExpand(${item.id})"
                     tabindex="0" role="article" aria-label="${escapeAttr(item.title)}, ${item.type}, ${priority.label} priority, ${item.status_label}"
                     aria-expanded="false">
                    <div class="roadmap-item-header">
                        <div class="roadmap-item-title">
                            <span class="type-id-badge ${typeIdBadgeClass}" aria-label="Item ID ${typeId}">${typeId}</span>
                            ${milestoneBadge}
                            ${escapeHtml(item.title)}
                            <span class="item-priority ${priority.level}" aria-label="${priority.label} priority">${priority.label}</span>
                        </div>
                        <div class="roadmap-item-meta">
                            ${statusHtml} | <span class="timestamp-relative" title="${escapeAttr(fullDate)}" aria-label="Created ${timeAgo}">${timeAgo}</span>
                            ${renderStarButton(item)}
                        </div>
                    </div>
                    <div class="roadmap-labels" role="list" aria-label="Item labels">
                        <span class="roadmap-label ${colorClass}" role="listitem">${escapeHtml(item.type)}</span>
                        ${renderGitHubIntegration(item)}
                    </div>
                    ${renderAssignees(item)}
                    ${renderSDLCProgress(item)}
                    ${registrationHtml}
                    <div class="roadmap-item-expand-toggle" aria-hidden="true">
                        <span class="arrow">‚ñ∂</span> View lifecycle details
                    </div>
                    ${lifecycleHtml}
                    ${customFieldsHtml}
                    ${automationRulesHtml}
                    ${collaborationHtml}
                </div>
            `;
        }

        // ========== STORY 5: INTEGRATIONS & AUTOMATION ==========

        // Track which items the current user has starred
        let userStarredItems = new Set();

        // Render star button for personalized tracking
        function renderStarButton(item) {
            const isStarred = userStarredItems.has(item.id);
            const starCount = item.stars_count || 0;

            if (!currentUser) {
                // Show sign-in prompt for non-logged-in users
                return `<span class="feature-signin-prompt"><a href="#" onclick="event.stopPropagation(); showAuthModal();">Sign in</a> to star</span>`;
            }

            const starClass = isStarred ? 'starred' : '';
            return `
                <button class="item-star-btn ${starClass}"
                        onclick="event.stopPropagation(); toggleStar(${item.id});"
                        title="${isStarred ? 'Unstar this item' : 'Star for personalized tracking'}">
                    ${isStarred ? '‚òÖ' : '‚òÜ'}
                    ${starCount > 0 ? `<span class="star-count">${starCount}</span>` : ''}
                </button>
            `;
        }

        // Toggle star on an item
        async function toggleStar(itemId) {
            if (!currentUser) {
                showToast('Please sign in to star items', 'warning');
                return;
            }

            const btn = document.querySelector(`.roadmap-item[data-item-id="${itemId}"] .item-star-btn`);
            if (btn) btn.disabled = true;

            try {
                const token = await currentUser.getIdToken();
                const isCurrentlyStarred = userStarredItems.has(itemId);
                const action = isCurrentlyStarred ? 'unstar' : 'star';

                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: action,
                        feedback_id: itemId,
                        product: 'quizmyself'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (isCurrentlyStarred) {
                        userStarredItems.delete(itemId);
                        showToast('Item unstarred', 'success');
                    } else {
                        userStarredItems.add(itemId);
                        showToast('Item starred for tracking', 'success');
                    }

                    // Update the star count in currentFeedbackData
                    if (currentFeedbackData && currentFeedbackData.feedback) {
                        const item = currentFeedbackData.feedback.find(f => f.id === itemId);
                        if (item) {
                            item.stars_count = (item.stars_count || 0) + (isCurrentlyStarred ? -1 : 1);
                        }
                    }

                    // Re-render to update UI
                    if (currentFeedbackData) {
                        renderRoadmapFromFeedback(currentFeedbackData);
                    }
                } else {
                    throw new Error(result.error || 'Failed to update star');
                }
            } catch (error) {
                console.error('Star toggle error:', error);
                showToast('Failed to update star', 'error');
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // Fetch user's starred items on modal open
        async function fetchUserStarredItems() {
            if (!currentUser) return;

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php?product=quizmyself&action=starred`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success && result.starred_items) {
                    userStarredItems = new Set(result.starred_items);
                }
            } catch (error) {
                console.error('Failed to fetch starred items:', error);
            }
        }

        // Render GitHub integration status and create issue button
        function renderGitHubIntegration(item) {
            if (item.github_issue && item.github_issue_url) {
                // Already synced with GitHub
                return `
                    <span class="github-integration-badge synced" title="Synced with GitHub">
                        <span>&#128279;</span> GH-${item.github_issue}
                    </span>
                    <span class="automation-badge active" title="Automated sync enabled">
                        <span>&#9889;</span> Auto-sync
                    </span>
                `;
            }

            // Not yet linked to GitHub - show create button for team members
            if (!currentUser) return '';

            return `
                <button class="create-issue-btn"
                        onclick="event.stopPropagation(); createGitHubIssue(${item.id});"
                        title="Create GitHub issue and enable auto-sync">
                    <span>+</span> Create Issue
                </button>
            `;
        }

        // Create GitHub issue and sync with Vandromeda API
        async function createGitHubIssue(feedbackId) {
            if (!currentUser) {
                showToast('Please sign in to create issues', 'warning');
                return;
            }

            const btn = document.querySelector(`.roadmap-item[data-item-id="${feedbackId}"] .create-issue-btn`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span>...</span> Creating...';
            }

            try {
                const token = await currentUser.getIdToken();

                // Call Vandromeda API to create GitHub issue
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'create_github_issue',
                        feedback_id: feedbackId,
                        product: 'quizmyself'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`GitHub issue #${result.github_issue} created! Auto-sync enabled.`, 'success');

                    // Update the item in currentFeedbackData
                    if (currentFeedbackData && currentFeedbackData.feedback) {
                        const item = currentFeedbackData.feedback.find(f => f.id === feedbackId);
                        if (item) {
                            item.github_issue = result.github_issue;
                            item.github_issue_url = result.github_issue_url;
                        }
                    }

                    // Re-render to show the synced badge
                    if (currentFeedbackData) {
                        renderRoadmapFromFeedback(currentFeedbackData);
                    }
                } else {
                    throw new Error(result.error || 'Failed to create issue');
                }
            } catch (error) {
                console.error('Create GitHub issue error:', error);
                showToast('Failed to create GitHub issue. You may need admin permissions.', 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span>+</span> Create Issue';
                }
            }
        }

        // Render assignees section
        function renderAssignees(item) {
            const assignees = item.assignees || [];
            if (assignees.length === 0 && !currentUser) return '';

            let html = '<div class="item-assignees">';
            html += '<span class="assignee-label">Assigned:</span>';

            if (assignees.length === 0) {
                html += '<span class="assignee-label" style="color: #666;">Unassigned</span>';
            } else {
                assignees.forEach(assignee => {
                    const initials = (assignee.name || assignee.email || 'U')
                        .split(' ')
                        .map(n => n[0])
                        .slice(0, 2)
                        .join('')
                        .toUpperCase();
                    html += `
                        <span class="assignee-avatar" title="${escapeAttr(assignee.name || assignee.email)}">
                            ${initials}
                        </span>
                    `;
                });
            }

            // Add assignee button for logged-in users
            if (currentUser) {
                html += `
                    <span class="assignee-avatar add"
                          onclick="event.stopPropagation(); assignToItem(${item.id});"
                          title="Assign someone">+</span>
                `;
            }

            html += '</div>';
            return html;
        }

        // Assign user to an item
        async function assignToItem(feedbackId) {
            if (!currentUser) {
                showToast('Please sign in to assign items', 'warning');
                return;
            }

            // For now, assign self. In future, show a picker
            const confirmed = await showConfirm('Assign yourself to this item?', {
                icon: 'üë§',
                confirmText: 'Assign Me'
            });

            if (!confirmed) return;

            try {
                const token = await currentUser.getIdToken();

                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'assign',
                        feedback_id: feedbackId,
                        product: 'quizmyself',
                        assignee_email: currentUser.email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('You have been assigned to this item', 'success');

                    // Update the item in currentFeedbackData
                    if (currentFeedbackData && currentFeedbackData.feedback) {
                        const item = currentFeedbackData.feedback.find(f => f.id === feedbackId);
                        if (item) {
                            item.assignees = item.assignees || [];
                            if (!item.assignees.find(a => a.email === currentUser.email)) {
                                item.assignees.push({ email: currentUser.email, name: currentUser.displayName || currentUser.email });
                            }
                        }
                    }

                    // Re-render
                    if (currentFeedbackData) {
                        renderRoadmapFromFeedback(currentFeedbackData);
                    }
                } else {
                    throw new Error(result.error || 'Failed to assign');
                }
            } catch (error) {
                console.error('Assign error:', error);
                showToast('Failed to assign. Please try again.', 'error');
            }
        }

        // Render collaboration section with comments
        function renderCollaborationSection(item) {
            const comments = item.comments || [];

            let html = '<div class="item-comments" onclick="event.stopPropagation();">';
            html += '<div class="comments-header">';
            html += '<div class="lifecycle-section-title">Discussion</div>';
            html += `<span class="comments-count">${comments.length} comment${comments.length !== 1 ? 's' : ''}</span>`;
            html += '</div>';

            // Render existing comments
            if (comments.length > 0) {
                comments.slice(0, 3).forEach(comment => {
                    const initials = (comment.author || 'User')
                        .split(' ')
                        .map(n => n[0])
                        .slice(0, 2)
                        .join('')
                        .toUpperCase();
                    const timeAgo = comment.created_at ? formatRelativeTime(comment.created_at) : '';

                    html += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-avatar">${initials}</span>
                                <span class="comment-author">${escapeHtml(comment.author || 'User')}</span>
                                <span class="comment-timestamp">${timeAgo}</span>
                            </div>
                            <div class="comment-body">${escapeHtml(comment.body || comment.message)}</div>
                        </div>
                    `;
                });

                if (comments.length > 3) {
                    html += `<div style="color: #888; font-size: 0.75rem; text-align: center;">+ ${comments.length - 3} more comments</div>`;
                }
            } else {
                html += '<div style="color: #666; font-size: 0.8rem; padding: 8px 0;">No comments yet. Be the first to add one!</div>';
            }

            // Add comment form for logged-in users
            if (currentUser) {
                html += `
                    <div class="add-comment-form">
                        <input type="text"
                               class="add-comment-input"
                               id="comment-input-${item.id}"
                               placeholder="Add a comment..."
                               onkeypress="if(event.key==='Enter') addComment(${item.id})">
                        <button class="add-comment-btn" onclick="addComment(${item.id})">Post</button>
                    </div>
                `;
            } else {
                html += `<div class="feature-signin-prompt" style="margin-top: 8px;"><a href="#" onclick="event.stopPropagation(); showAuthModal();">Sign in</a> to comment</div>`;
            }

            html += '</div>';
            return html;
        }

        // Add a comment to an item
        async function addComment(feedbackId) {
            if (!currentUser) {
                showToast('Please sign in to comment', 'warning');
                return;
            }

            const input = document.getElementById(`comment-input-${feedbackId}`);
            const commentText = input?.value?.trim();

            if (!commentText) {
                showToast('Please enter a comment', 'warning');
                return;
            }

            const btn = input.nextElementSibling;
            if (btn) {
                btn.disabled = true;
                btn.textContent = '...';
            }

            try {
                const token = await currentUser.getIdToken();

                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'comment',
                        feedback_id: feedbackId,
                        product: 'quizmyself',
                        message: commentText
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Comment added', 'success');

                    // Update the item in currentFeedbackData
                    if (currentFeedbackData && currentFeedbackData.feedback) {
                        const item = currentFeedbackData.feedback.find(f => f.id === feedbackId);
                        if (item) {
                            item.comments = item.comments || [];
                            item.comments.push({
                                author: currentUser.displayName || currentUser.email,
                                body: commentText,
                                created_at: new Date().toISOString()
                            });
                        }
                    }

                    // Clear input and re-render
                    if (input) input.value = '';
                    if (currentFeedbackData) {
                        renderRoadmapFromFeedback(currentFeedbackData);
                        // Re-expand the item
                        setTimeout(() => {
                            const itemEl = document.querySelector(`.roadmap-item[data-item-id="${feedbackId}"]`);
                            if (itemEl) itemEl.classList.add('expanded');
                        }, 50);
                    }
                } else {
                    throw new Error(result.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Add comment error:', error);
                showToast('Failed to add comment. Please try again.', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Post';
                }
            }
        }

        // ========== END STORY 5 ==========

        // ========== STORY 6: FLEXIBILITY & ITERATION ==========

        // View mode: 'status' (default) or 'themes'
        let currentProgressView = 'status';

        // Strategic themes for agile updates (goals over rigid timelines)
        const strategicThemes = {
            'performance': {
                name: 'Performance',
                icon: '‚ö°',
                description: 'Speed and efficiency improvements',
                keywords: ['speed', 'fast', 'performance', 'optimize', 'slow', 'lag']
            },
            'ux': {
                name: 'User Experience',
                icon: '‚ú®',
                description: 'Interface and usability enhancements',
                keywords: ['ui', 'ux', 'design', 'interface', 'usability', 'intuitive', 'confusing']
            },
            'reliability': {
                name: 'Reliability',
                icon: 'üõ°Ô∏è',
                description: 'Stability and bug fixes',
                keywords: ['bug', 'fix', 'crash', 'error', 'broken', 'issue', 'problem']
            },
            'growth': {
                name: 'Growth Features',
                icon: 'üöÄ',
                description: 'New capabilities and features',
                keywords: ['feature', 'add', 'new', 'implement', 'support', 'want', 'would like']
            }
        };

        // Automation rules configuration
        let automationRules = {
            autoTriage: true,           // Auto-assign priority based on type
            notifyOnProgress: true,     // Notify when item moves to in_progress
            githubSync: true,           // Sync status with GitHub issues
            autoClose: false            // Auto-close resolved items after 7 days
        };

        // Custom fields configuration (user can define these)
        const defaultCustomFields = [
            { key: 'sprint', label: 'Sprint', type: 'text', value: '' },
            { key: 'effort', label: 'Effort', type: 'select', options: ['XS', 'S', 'M', 'L', 'XL'], value: '' },
            { key: 'team', label: 'Team', type: 'text', value: '' }
        ];

        // Switch between status view and themes view
        function switchProgressView(view) {
            currentProgressView = view;
            if (currentFeedbackData) {
                renderRoadmapFromFeedback(currentFeedbackData);
            }
        }

        // Render view toggle buttons
        function renderViewToggle() {
            return `
                <div class="progress-view-toggle" role="tablist" aria-label="Progress view options">
                    <button class="progress-view-btn ${currentProgressView === 'status' ? 'active' : ''}"
                            onclick="switchProgressView('status')"
                            role="tab"
                            aria-selected="${currentProgressView === 'status'}"
                            aria-controls="progress-status-view"
                            tabindex="${currentProgressView === 'status' ? '0' : '-1'}">
                        üìã By Status
                    </button>
                    <button class="progress-view-btn ${currentProgressView === 'themes' ? 'active' : ''}"
                            onclick="switchProgressView('themes')"
                            role="tab"
                            aria-selected="${currentProgressView === 'themes'}"
                            aria-controls="progress-themes-view"
                            tabindex="${currentProgressView === 'themes' ? '0' : '-1'}">
                        üéØ By Theme
                    </button>
                </div>
            `;
        }

        // Classify an item into a strategic theme based on keywords
        function classifyItemTheme(item) {
            const text = `${item.title || ''} ${item.message || ''} ${item.type || ''}`.toLowerCase();

            for (const [themeKey, theme] of Object.entries(strategicThemes)) {
                for (const keyword of theme.keywords) {
                    if (text.includes(keyword)) {
                        return themeKey;
                    }
                }
            }

            // Default to growth for features, reliability for bugs
            if (item.type === 'bug') return 'reliability';
            if (item.type === 'feature') return 'growth';
            return 'ux';
        }

        // Render items grouped by strategic themes
        function renderThemesView(feedback) {
            // Group items by theme
            const themeGroups = {};
            for (const themeKey of Object.keys(strategicThemes)) {
                themeGroups[themeKey] = [];
            }

            feedback.forEach(item => {
                const theme = item.theme || classifyItemTheme(item);
                if (themeGroups[theme]) {
                    themeGroups[theme].push(item);
                } else {
                    themeGroups['growth'].push(item); // Default fallback
                }
            });

            let html = '<div class="progress-themes" role="region" aria-label="Items grouped by strategic theme">';

            for (const [themeKey, theme] of Object.entries(strategicThemes)) {
                const items = themeGroups[themeKey];
                if (items.length === 0) continue;

                const completedCount = items.filter(i => i.is_resolved).length;
                const progressPercent = Math.round((completedCount / items.length) * 100);

                html += `
                    <div class="theme-card theme-${themeKey}" tabindex="0" role="article" aria-label="${theme.name} theme: ${items.length} items, ${progressPercent}% complete">
                        <div class="theme-header">
                            <div class="theme-title">
                                <span class="theme-icon" aria-hidden="true">${theme.icon}</span>
                                ${escapeHtml(theme.name)}
                            </div>
                            <span class="theme-count" aria-label="${items.length} items">${items.length} items</span>
                        </div>
                        <div class="theme-description">${escapeHtml(theme.description)}</div>
                        <div class="theme-progress" role="progressbar" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100" aria-label="Theme progress">
                            <div class="theme-progress-bar">
                                <div class="theme-progress-fill" style="width: ${progressPercent}%;"></div>
                            </div>
                            <span class="theme-progress-text">${progressPercent}%</span>
                        </div>
                        <div class="theme-items" role="list" aria-label="Items in this theme">
                            ${items.slice(0, 5).map(item => {
                                const statusClass = item.is_resolved ? 'completed' : (item.status === 'in_progress' ? 'in-progress' : 'pending');
                                const statusLabel = item.is_resolved ? 'completed' : (item.status === 'in_progress' ? 'in progress' : 'pending');
                                return `
                                    <div class="theme-item" role="listitem">
                                        <span class="theme-item-status ${statusClass}" aria-label="Status: ${statusLabel}"></span>
                                        <span>${escapeHtml(item.title)}</span>
                                    </div>
                                `;
                            }).join('')}
                            ${items.length > 5 ? `<div class="theme-item" style="color: #666;">+ ${items.length - 5} more items</div>` : ''}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Render custom fields section for an item
        function renderCustomFields(item) {
            const customFields = item.custom_fields || defaultCustomFields;
            if (!customFields || customFields.length === 0) return '';

            let html = '<div class="custom-fields-section" role="region" aria-label="Custom fields">';
            html += '<div class="lifecycle-section-title">Custom Fields</div>';

            customFields.forEach(field => {
                const value = field.value || '‚Äî';
                const isEditable = currentUser ? 'editable' : '';
                const editHandler = currentUser ? `onclick="event.stopPropagation(); editCustomField(${item.id}, '${field.key}')"` : '';
                const tabIndex = currentUser ? 'tabindex="0"' : '';

                html += `
                    <div class="custom-field">
                        <span class="custom-field-label">${escapeHtml(field.label)}</span>
                        <span class="custom-field-value ${isEditable}" ${editHandler} ${tabIndex}
                              role="${currentUser ? 'button' : 'text'}"
                              aria-label="${field.label}: ${value}${currentUser ? ', click to edit' : ''}">
                            ${escapeHtml(value)}
                        </span>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Render automation rules section
        function renderAutomationRules(item) {
            if (!currentUser) return ''; // Only show to logged-in users

            const rules = [
                { key: 'autoTriage', label: 'Auto-triage new items', icon: 'üéØ' },
                { key: 'notifyOnProgress', label: 'Notify on status change', icon: 'üîî' },
                { key: 'githubSync', label: 'Sync with GitHub', icon: 'üîó' }
            ];

            let html = '<div class="automation-rules-section" role="region" aria-label="Automation rules">';
            html += '<div class="lifecycle-section-title">Automation Rules</div>';

            rules.forEach(rule => {
                const isEnabled = automationRules[rule.key];
                html += `
                    <div class="automation-rule">
                        <span class="automation-rule-icon" aria-hidden="true">${rule.icon}</span>
                        <span class="automation-rule-text" id="rule-label-${rule.key}">${rule.label}</span>
                        <label class="automation-rule-toggle">
                            <input type="checkbox"
                                   ${isEnabled ? 'checked' : ''}
                                   onchange="toggleAutomationRule('${rule.key}', this.checked)"
                                   aria-labelledby="rule-label-${rule.key}">
                            <span class="automation-toggle-slider" aria-hidden="true"></span>
                            <span class="sr-only">${isEnabled ? 'Enabled' : 'Disabled'}</span>
                        </label>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Toggle automation rule
        async function toggleAutomationRule(ruleKey, enabled) {
            automationRules[ruleKey] = enabled;

            // Persist to API if logged in
            if (currentUser) {
                try {
                    const token = await currentUser.getIdToken();
                    await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            action: 'update_automation_rules',
                            product: 'quizmyself',
                            rules: automationRules
                        })
                    });
                    showToast(`${enabled ? 'Enabled' : 'Disabled'} automation rule`, 'success');
                } catch (error) {
                    console.error('Failed to update automation rule:', error);
                    showToast('Failed to update rule', 'error');
                }
            }
        }

        // Edit a custom field value
        async function editCustomField(itemId, fieldKey) {
            if (!currentUser) {
                showToast('Please sign in to edit fields', 'warning');
                return;
            }

            const item = currentFeedbackData?.feedback?.find(f => f.id === itemId);
            if (!item) return;

            const customFields = item.custom_fields || defaultCustomFields;
            const field = customFields.find(f => f.key === fieldKey);
            if (!field) return;

            // Simple prompt for now - could be enhanced with a modal
            const newValue = prompt(`Enter new value for ${field.label}:`, field.value || '');
            if (newValue === null) return; // Cancelled

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'update_custom_field',
                        feedback_id: itemId,
                        product: 'quizmyself',
                        field_key: fieldKey,
                        field_value: newValue
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    field.value = newValue;
                    showToast('Field updated', 'success');

                    // Re-render
                    if (currentFeedbackData) {
                        renderRoadmapFromFeedback(currentFeedbackData);
                        // Re-expand the item
                        setTimeout(() => {
                            const itemEl = document.querySelector(`.roadmap-item[data-item-id="${itemId}"]`);
                            if (itemEl) itemEl.classList.add('expanded');
                        }, 50);
                    }
                } else {
                    throw new Error(result.error || 'Failed to update field');
                }
            } catch (error) {
                console.error('Edit custom field error:', error);
                showToast('Failed to update field', 'error');
            }
        }

        // Keyboard navigation for Progress modal
        function setupProgressModalKeyboardNav() {
            const modal = document.getElementById('roadmap-modal');
            if (!modal) return;

            modal.addEventListener('keydown', (e) => {
                // Escape to close
                if (e.key === 'Escape') {
                    closeRoadmapModal();
                    return;
                }

                // Tab trap within modal
                if (e.key === 'Tab') {
                    const focusableElements = modal.querySelectorAll(
                        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }

                // Arrow keys for filter chips
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const chips = modal.querySelectorAll('.progress-filter-chip');
                    const currentIndex = Array.from(chips).indexOf(document.activeElement);
                    if (currentIndex !== -1) {
                        e.preventDefault();
                        const nextIndex = e.key === 'ArrowRight'
                            ? (currentIndex + 1) % chips.length
                            : (currentIndex - 1 + chips.length) % chips.length;
                        chips[nextIndex].focus();
                    }
                }

                // Enter/Space to expand items
                if (e.key === 'Enter' || e.key === ' ') {
                    const target = e.target;
                    if (target.classList.contains('roadmap-item') && target.classList.contains('expandable')) {
                        e.preventDefault();
                        const itemId = target.dataset.itemId;
                        if (itemId) toggleItemExpand(parseInt(itemId));
                    }
                }
            });
        }

        // Focus management when modal opens
        function focusProgressModal() {
            const modal = document.getElementById('roadmap-modal');
            if (modal) {
                const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    setTimeout(() => firstFocusable.focus(), 100);
                }
            }
        }

        // Announce status changes for screen readers
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
        }

        // ========== END STORY 6 ==========

        async function submitFeedback() {
            const type = document.getElementById('feedback-type').value;
            const message = document.getElementById('feedback-message').value.trim();
            const email = document.getElementById('feedback-email').value.trim() || currentUser?.email || '';
            const statusEl = document.getElementById('feedback-status');
            const submitBtn = document.getElementById('feedback-submit');

            // Validate
            if (!message) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(233,69,96,0.1)';
                statusEl.style.color = '#e94560';
                statusEl.textContent = 'Please enter a message.';
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            statusEl.style.display = 'none';

            try {
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/feedback.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product: 'quizmyself',
                        type: type,
                        message: message,
                        email: email,
                        user_agent: navigator.userAgent,
                        url: window.location.href,
                        context: currentKeyword ? { keyword: currentKeyword } : null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'rgba(79,195,247,0.1)';
                    statusEl.style.color = '#4fc3f7';
                    const feedbackId = result.feedback_id || result.id;
                    statusEl.textContent = feedbackId
                        ? `Thank you! Your feedback #${feedbackId} has been submitted.`
                        : 'Thank you for your feedback! We will review it soon.';
                    submitBtn.textContent = 'Sent!';
                    // Close modal after delay
                    setTimeout(() => {
                        closeFeedbackModal();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to submit feedback');
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(233,69,96,0.1)';
                statusEl.style.color = '#e94560';
                statusEl.textContent = 'Failed to send feedback. Please try again or email feedback@vandromeda.com';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Feedback';
            }
        }

        function renderKeywordList() {
            const list = document.getElementById('keyword-list');

            if (userKeywords.length === 0) {
                list.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No quizzes yet. Add one above.</p>';
                return;
            }

            list.innerHTML = userKeywords.map(kw => `
                <div class="keyword-item">
                    <div class="keyword-item-info">
                        <div class="keyword-item-name ${currentKeyword === kw.keyword ? 'active' : ''}">${escapeHtml(kw.keyword)}</div>
                        <div class="keyword-item-date">
                            ${kw.question_count > 0 ? `<span style="color: #4fc3f7;">${kw.question_count} questions</span>` : '<span style="color: #666;">No questions</span>'}
                            ${kw.source_count > 0 ? ` | <span style="color: #888;">${kw.source_count} source${kw.source_count > 1 ? 's' : ''}</span>` : ''}
                            | ${new Date(kw.created_at).toLocaleDateString()}${kw.is_migrated ? ' (Claimed)' : ''}
                        </div>
                    </div>
                    <div class="keyword-item-actions">
                        ${currentKeyword !== kw.keyword ?
                            `<button class="btn btn-small btn-primary" data-action="select-keyword" data-keyword="${escapeAttr(kw.keyword)}">Use</button>` :
                            '<span style="color: #4fc3f7; font-size: 0.8rem; padding: 5px 10px;">Active</span>'}
                        <button class="btn btn-small btn-danger" data-action="delete-keyword" data-keyword="${escapeAttr(kw.keyword)}">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function handleAddKeyword() {
            const input = document.getElementById('new-keyword-input');
            const keyword = input.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');

            if (!keyword || keyword.length < 3) {
                showKeywordModalMessage('Quiz name must be at least 3 characters', 'error');
                return;
            }

            const result = await addKeywordToAccount(keyword);

            if (result.success) {
                input.value = '';
                renderKeywordList();
                showKeywordModalMessage('Quiz added!', 'success');
            } else {
                showKeywordModalMessage(result.message || result.error || 'Failed to add quiz', 'error');
            }
        }

        async function confirmDeleteKeyword(keyword) {
            const confirmed = await showConfirm(`Delete quiz "${keyword}"? This cannot be undone.`, {
                icon: 'üóëÔ∏è',
                confirmText: 'Delete',
                danger: true
            });
            if (!confirmed) return;

            const result = await deleteKeywordFromAccount(keyword);

            if (result.success) {
                renderKeywordList();
                showKeywordModalMessage('Quiz deleted', 'success');
            } else {
                showKeywordModalMessage(result.message || result.error || 'Failed to delete quiz', 'error');
            }
        }

        function showKeywordModalMessage(message, type) {
            const el = document.getElementById('keyword-modal-message');
            el.textContent = message;
            el.style.display = 'block';
            el.style.background = type === 'success' ? 'rgba(39, 174, 96, 0.2)' : 'rgba(233, 69, 96, 0.2)';
            el.style.color = type === 'success' ? '#27ae60' : '#e94560';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Hamburger menu functions
        function toggleHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.toggle('show');
        }

        function openHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.add('show');
        }

        function closeHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.remove('show');
        }

        function updateHamburgerMenu() {
            const signinSection = document.getElementById('menu-signin-section');
            const accountSection = document.getElementById('menu-account-section');
            const emailSection = document.getElementById('menu-email-section');
            const emailEl = document.getElementById('menu-email');
            const licenseStatusEl = document.getElementById('menu-license-status');
            const upgradeBtn = document.getElementById('menu-upgrade-btn');

            // Check if user is signed in with Firebase or using keyword-only mode
            const isSignedInWithFirebase = currentUser !== null;
            const hasKeyword = currentKeyword && currentKeyword.length > 0;

            if (isSignedInWithFirebase || hasKeyword) {
                // Signed in - show account section
                signinSection.style.display = 'none';
                accountSection.style.display = 'block';

                // Show email if Firebase user
                if (isSignedInWithFirebase && currentUser.email) {
                    emailSection.style.display = 'block';
                    emailEl.textContent = currentUser.email;
                } else {
                    emailSection.style.display = 'none';
                }

                // Show license status and upgrade button
                if (state.isPro && state.licenseKey) {
                    licenseStatusEl.innerHTML = '<span style="color: #ffd700;">PRO</span> - ' + state.licenseKey;
                    if (upgradeBtn) upgradeBtn.style.display = 'none';
                } else {
                    licenseStatusEl.textContent = 'Free Account';
                    if (upgradeBtn) upgradeBtn.style.display = 'block';
                }
            } else {
                // Signed out - show signin section
                signinSection.style.display = 'block';
                accountSection.style.display = 'none';
            }
        }

        async function submitKeywordFromMenu() {
            const input = document.getElementById('menu-keyword-input');
            const keyword = input.value.trim();

            if (!keyword) {
                return;
            }

            currentKeyword = keyword;
            localStorage.setItem('quizmyself_keyword', keyword);

            // Load progress for this keyword
            await loadState();

            // Check pro status for this keyword
            await checkProStatus();

            // Show stats bar
            document.getElementById('stats-bar').style.display = 'flex';

            // Update hamburger menu and close dropdown
            updateHamburgerMenu();
            document.getElementById('hamburger-dropdown').classList.remove('show');

            input.value = '';
        }

        async function signOut() {
            // Sign out from Firebase if signed in
            if (currentUser) {
                try {
                    await firebase.auth().signOut();
                } catch (e) {
                    console.error('Firebase sign out error:', e);
                }
            }

            // Clear saved keyword
            localStorage.removeItem('quizmyself_keyword');
            localStorage.removeItem('quizmyself_active_keyword');

            currentKeyword = '';
            currentUser = null;
            userKeywords = [];
            state.mastered = [];
            state.answerCounts = {};
            state.totalCorrect = 0;
            state.totalAnswered = 0;
            state.examQuestions = [];
            state.examIndex = 0;
            state.examCorrect = 0;
            state.isPro = false;
            state.licenseKey = null;
            state.email = null;

            document.getElementById('stats-bar').style.display = 'none';
            updateStats();
            updateResumeExamButton(false);
            updateHamburgerMenu();
            updateProUI();

            // Close dropdown
            document.getElementById('hamburger-dropdown').classList.remove('show');

            // Go back to menu if on another screen
            showScreen('menu-screen');
        }

        // Close hamburger menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('hamburger-menu');
            const statusBtn = document.getElementById('top-bar-status');
            if (menu && !menu.contains(e.target) && !statusBtn.contains(e.target)) {
                document.getElementById('hamburger-dropdown').classList.remove('show');
            }
        });

        // Event delegation for dynamically created elements (XSS-safe)
        function handleDataAction(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const keyword = target.dataset.keyword;
            const category = target.dataset.category;
            const sourceId = target.dataset.sourceId;
            const sourceName = target.dataset.sourceName;
            const contentType = target.dataset.contentType;

            switch (action) {
                case 'select-keyword':
                    if (keyword) {
                        selectKeyword(keyword);
                        renderKeywordList();
                    }
                    break;
                case 'delete-keyword':
                    if (keyword) {
                        confirmDeleteKeyword(keyword);
                    }
                    break;
                case 'toggle-category':
                    if (category) {
                        toggleCategory(category);
                    }
                    break;
                case 'toggle-welcome-category':
                    if (category) {
                        toggleWelcomeCategory(target, category);
                    }
                    break;
                case 'link-source':
                    if (sourceId && sourceName) {
                        linkSourceToQuiz(parseInt(sourceId), sourceName);
                    }
                    break;
                case 'unlink-source':
                    if (keyword) {
                        unlinkSourceFromQuiz(keyword);
                    }
                    break;
                case 'view-source':
                    if (sourceId && sourceName && contentType) {
                        viewSourceContent(parseInt(sourceId), sourceName, contentType);
                    }
                    break;
                case 'delete-source':
                    if (sourceId && sourceName) {
                        deleteSource(parseInt(sourceId), sourceName);
                    }
                    break;
                case 'filter-course-content':
                    // Empty string means null (show all)
                    filterCourseContent(category || null);
                    break;
            }
        }

        document.addEventListener('click', handleDataAction);

        // Handle clicks inside sources-list (inside modal-content which has stopPropagation)
        document.getElementById('sources-list').addEventListener('click', handleDataAction);

        // Load state from server
        async function loadState() {
            if (!currentKeyword) return;
            try {
                const res = await fetch(`${VANDROMEDA_API}/quizmyself/progress.php?keyword=${encodeURIComponent(currentKeyword)}`);
                if (res.ok) {
                    const data = await res.json();
                    state.mastered = data.mastered || [];
                    state.answerCounts = data.answerCounts || {};
                    state.totalCorrect = data.totalCorrect || 0;
                    state.totalAnswered = data.totalAnswered || 0;

                    // Load custom questions for this keyword
                    const customQuestions = data.customQuestions || [];
                    questions.length = 0; // Clear existing questions
                    if (customQuestions.length > 0) {
                        customQuestions.forEach(q => questions.push(q));
                        state.importedQuestionCount = customQuestions.length;
                        console.log(`Loaded ${customQuestions.length} custom questions for keyword: ${currentKeyword}`);
                    } else {
                        // No questions for this keyword yet
                        state.importedQuestionCount = 0;
                    }

                    // Restore exam progress if exists
                    if (data.examInProgress && data.examQuestionIds && data.examQuestionIds.length > 0) {
                        // Rebuild examQuestions from IDs
                        state.examQuestions = data.examQuestionIds.map(id => questions.find(q => q.id === id)).filter(q => q);
                        state.examIndex = data.examIndex || 0;
                        state.examCorrect = data.examCorrect || 0;
                        // Show resume button
                        updateResumeExamButton(true);
                    } else {
                        state.examQuestions = [];
                        state.examIndex = 0;
                        state.examCorrect = 0;
                        updateResumeExamButton(false);
                    }
                }
            } catch (e) {
                console.log('Could not load from server');
            }
            updateStats();
        }

        // Update resume exam button visibility
        function updateResumeExamButton(show) {
            const btn = document.getElementById('resume-exam-btn');
            if (btn) {
                if (show && state.examQuestions.length > 0 && state.examIndex < state.examQuestions.length) {
                    btn.classList.remove('hidden');
                    btn.textContent = `Resume Exam (${state.examIndex}/${state.examQuestions.length})`;
                } else {
                    btn.classList.add('hidden');
                }
            }
        }

        // Save state to server
        let saveTimeout = null;
        function saveState(immediate = false) {
            if (!currentKeyword) return;
            clearTimeout(saveTimeout);

            const doSave = async () => {
                try {
                    const payload = {
                        mastered: state.mastered,
                        answerCounts: state.answerCounts,
                        totalCorrect: state.totalCorrect,
                        totalAnswered: state.totalAnswered
                    };

                    // Save custom questions if we have imported ones
                    if (state.importedQuestionCount > 0) {
                        payload.customQuestions = questions;
                    }

                    // Save exam progress if in exam mode
                    if (state.currentMode === 'exam' && state.examQuestions.length > 0) {
                        payload.examInProgress = true;
                        payload.examQuestionIds = state.examQuestions.map(q => q.id);
                        payload.examIndex = state.examIndex;
                        payload.examCorrect = state.examCorrect;
                    } else {
                        payload.examInProgress = false;
                    }
                    await fetch(`${VANDROMEDA_API}/quizmyself/progress.php?keyword=${encodeURIComponent(currentKeyword)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.log('Could not save to server');
                }
            };

            if (immediate) {
                doSave();
            } else {
                saveTimeout = setTimeout(doSave, 500);
            }
        }

        // Update stats display
        function updateStats() {
            const filteredQuestions = getFilteredQuestions();
            document.getElementById('total-count').textContent = filteredQuestions.length;

            // Right and wrong counts
            const rightCount = state.totalCorrect || 0;
            const wrongCount = (state.totalAnswered || 0) - rightCount;
            document.getElementById('right-count').textContent = rightCount;
            document.getElementById('wrong-count').textContent = wrongCount;

            // Mastered count
            const masteredInFilter = state.mastered.filter(id => filteredQuestions.some(q => q.id === id));
            document.getElementById('mastered-count').textContent = masteredInFilter.length;

            // Accuracy = right / total answered
            const accuracy = state.totalAnswered > 0
                ? Math.round((state.totalCorrect / state.totalAnswered) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // Get filtered questions based on selected categories
        function getFilteredQuestions() {
            if (selectedCategories.size === 0 || selectedCategories.size === allCategories.length) {
                return questions;
            }
            return questions.filter(q => selectedCategories.has(q.category));
        }

        // Initialize category filter
        function initCategoryFilter() {
            // Get unique categories from questions (filter out undefined/null)
            const categories = [...new Set(questions.map(q => q.category).filter(c => c))];
            allCategories = categories;

            // Default: all categories selected
            selectedCategories = new Set(categories);

            // Hide category filter if no meaningful categories (0 or 1 category)
            const filterEl = document.getElementById('category-filter');
            if (filterEl) {
                if (categories.length <= 1) {
                    filterEl.style.display = 'none';
                } else {
                    filterEl.style.display = 'block';
                }
            }

            // Render category chips
            renderCategoryChips();
        }

        // Render category chips
        function renderCategoryChips() {
            const container = document.getElementById('category-chips');
            if (!container) return;

            container.innerHTML = allCategories.map(cat => {
                const isActive = selectedCategories.has(cat);
                const count = questions.filter(q => q.category === cat).length;
                return `<button class="category-chip ${isActive ? 'active' : ''}"
                    data-action="toggle-category" data-category="${escapeAttr(cat)}">${escapeHtml(cat)} (${count})</button>`;
            }).join('');
        }

        // Toggle category selection
        function toggleCategory(category) {
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
            } else {
                selectedCategories.add(category);
            }
            renderCategoryChips();
            updateStats();
        }

        // Select all categories
        function selectAllCategories() {
            selectedCategories = new Set(allCategories);
            renderCategoryChips();
            updateStats();
        }

        // Clear all categories
        function clearAllCategories() {
            selectedCategories.clear();
            renderCategoryChips();
            updateStats();
        }

        // Show course content (study material from quiz questions)
        function showCourseContent() {
            // Check if current keyword has a linked source - show that instead
            const keywordInfo = userKeywords.find(kw => kw.keyword === currentKeyword);
            if (keywordInfo && keywordInfo.source_id) {
                // Show the linked source in the format-aware viewer
                showSourcesModal();
                viewSourceContent(keywordInfo.source_id, keywordInfo.source_name || 'Study Material', keywordInfo.source_content_type || 'text/plain');
                return;
            }

            // Fall back to Q&A formatted content
            renderCourseCategoryChips();
            renderCourseContent();
            showScreen('course-content-screen');
        }

        // Render category chips for course content screen
        function renderCourseCategoryChips() {
            const container = document.getElementById('course-category-chips');
            if (!container) return;

            // If no category selected for course content, show all
            const showAll = courseContentCategory === null;

            container.innerHTML = `<button class="category-chip ${showAll ? 'active' : ''}"
                data-action="filter-course-content" data-category="">All</button>` +
                allCategories.map(cat => {
                    const isActive = courseContentCategory === cat;
                    const count = questions.filter(q => q.category === cat).length;
                    return `<button class="category-chip ${isActive ? 'active' : ''}"
                        data-action="filter-course-content" data-category="${escapeAttr(cat)}">${escapeHtml(cat)} (${count})</button>`;
                }).join('');
        }

        // Filter course content by category
        function filterCourseContent(category) {
            courseContentCategory = category;
            renderCourseCategoryChips();
            renderCourseContent();
        }

        // Render course content items
        function renderCourseContent() {
            const container = document.getElementById('course-content-list');
            if (!container) return;

            let filteredQuestions = questions;
            if (courseContentCategory !== null) {
                filteredQuestions = questions.filter(q => q.category === courseContentCategory);
            }

            if (filteredQuestions.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center;">No content available for the selected category.</p>';
                return;
            }

            container.innerHTML = filteredQuestions.map((q, index) => `
                <div class="course-item">
                    <span class="course-item-category">${q.category}</span>
                    <div class="course-item-question">${index + 1}. ${q.q}</div>
                    <div class="course-item-answer">${q.a}</div>
                </div>
            `).join('');
        }

        // Show/hide screens
        function showScreen(screenId) {
            ['menu-screen', 'quiz-screen', 'exam-screen', 'result-screen', 'progress-screen', 'mastered-screen', 'course-content-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Back to menu
        function backToMenu() {
            state.currentMode = 'menu';
            showScreen('menu-screen');
            updateStats();
        }

        // Get random unmastered question from filtered set
        function getRandomQuestion() {
            const filteredQuestions = getFilteredQuestions();
            const unmastered = filteredQuestions.filter(q => !state.mastered.includes(q.id));
            if (unmastered.length === 0) return null;
            return unmastered[Math.floor(Math.random() * unmastered.length)];
        }

        // Start practice mode
        function startPractice() {
            const filteredQuestions = getFilteredQuestions();
            if (filteredQuestions.length === 0) {
                showToast('No questions available. Select at least one category or import some questions!', 'warning');
                return;
            }
            plausible('Quiz Start', { props: { mode: 'practice', questions: filteredQuestions.length } });
            state.currentMode = 'practice';
            showScreen('quiz-screen');
            loadNextQuestion();
        }

        // Load next question
        function loadNextQuestion() {
            const filteredQuestions = getFilteredQuestions();
            state.currentQuestion = getRandomQuestion();
            state.claimedKnowledge = false;

            // If all mastered in filtered set, show completion
            if (!state.currentQuestion && filteredQuestions.length > 0) {
                const masteredCount = filteredQuestions.filter(q => state.mastered.includes(q.id)).length;
                if (masteredCount === filteredQuestions.length) {
                    // All questions in this filter are mastered!
                    document.getElementById('question-counter').textContent = 'üéâ All mastered!';
                    document.getElementById('category-badge').textContent = '';
                    document.getElementById('question-context').classList.add('hidden');
                    document.getElementById('question-text').innerHTML = `
                        <div style="text-align:center; padding: 20px 0;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üèÜ</div>
                            <div style="font-size: 1.3rem; font-weight: 600; margin-bottom: 12px;">You've mastered all ${filteredQuestions.length} questions!</div>
                            <div style="color: #aab; margin-bottom: 20px;">Great work. Try another category or review these again.</div>
                            <button class="btn btn-primary" onclick="backToMenu()" style="margin-right: 10px;">‚Üê Back to Menu</button>
                            <button class="btn btn-small" onclick="reviewMastered()" style="opacity: 0.7;">Review Anyway</button>
                        </div>
                    `;
                    document.getElementById('choices-container').innerHTML = '';
                    document.getElementById('practice-next-btn').classList.add('hidden');
                    const skipArea = document.querySelector('#practice-screen .btn-group, #practice-screen [onclick*=markAlwaysKnow]');
                    return;
                }
                state.currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            }

            if (!state.currentQuestion) {
                showToast('No questions available!', 'warning');
                backToMenu();
                return;
            }

            const q = state.currentQuestion;
            const remaining = questions.filter(qn => !state.mastered.includes(qn.id)).length;

            document.getElementById('question-counter').textContent = `${remaining} questions remaining`;
            document.getElementById('category-badge').textContent = q.category;

            // Auto-skip questions missing required context
            if (q.q && (q.q.startsWith('[NEEDS FIGURE]') || q.q.startsWith('[NEEDS CONTEXT]'))) {
                loadNextQuestion();
                return;
            }

            // Parse and display context + question separately
            const contextEl = document.getElementById('question-context');
            const questionText = q.q || '';
            let displayQuestion = questionText;
            let contextContent = '';

            // Check for [Figure: ...] prefix
            const figureMatch = questionText.match(/^\[Figure:\s*([\s\S]*?)\]\s*\n*\s*(?:Question:\s*)?([\s\S]*)$/);
            // Check for Context: ... with Question: marker
            const contextWithQ = questionText.match(/^Context:\s*([\s\S]*?)\s*Question:\s*([\s\S]*)$/);
            // Fallback: Context: split on last \n\n
            const contextFallback = questionText.match(/^Context:\s*([\s\S]+)\n\n([\s\S]+)$/);

            if (figureMatch && figureMatch[2].trim()) {
                // If we have an actual image, don't show the alt_text wall ‚Äî the image IS the reference
                contextContent = q.image ? '' : figureMatch[1].trim();
                displayQuestion = figureMatch[2].trim();
            } else if (contextWithQ && contextWithQ[2].trim()) {
                contextContent = contextWithQ[1].trim();
                displayQuestion = contextWithQ[2].trim();
            } else if (contextFallback && contextFallback[2].trim()) {
                // Use the last \n\n split ‚Äî everything after last \n\n is the question
                const lastSplit = questionText.replace(/^Context:\s*/, '').lastIndexOf('\n\n');
                if (lastSplit > 0) {
                    contextContent = questionText.replace(/^Context:\s*/, '').substring(0, lastSplit).trim();
                    displayQuestion = questionText.replace(/^Context:\s*/, '').substring(lastSplit).trim();
                }
            }

            if (contextContent) {
                let formatted = contextContent;
                
                // --- Table detection: [Table] marker followed by newline-separated rows ---
                if (formatted.includes('[Table]')) {
                    formatted = formatted.replace(/\[Table\]\s*([\s\S]*?)(?=\n\n(?:[A-Z]|\[)|$)/g, function(match, tableContent) {
                        const lines = tableContent.trim().split('\n');
                        // Group lines by blank-line separators: first group = headers, rest = data rows
                        const groups = [];
                        let current = [];
                        for (const line of lines) {
                            if (line.trim() === '') {
                                if (current.length > 0) { groups.push(current); current = []; }
                            } else {
                                current.push(line.trim());
                            }
                        }
                        if (current.length > 0) groups.push(current);
                        if (groups.length < 2) return match; // Not enough for a table
                        
                        const numCols = groups[0].length;
                        let html = '<table style="border-collapse:collapse;width:100%;margin:8px 0;font-size:0.9em;">';
                        html += '<tr>';
                        for (const h of groups[0]) {
                            html += '<th style="border:1px solid #555;padding:4px 8px;background:#2a2a3a;text-align:left;">' + h + '</th>';
                        }
                        html += '</tr>';
                        for (let i = 1; i < groups.length; i++) {
                            html += '<tr>';
                            for (let j = 0; j < numCols; j++) {
                                html += '<td style="border:1px solid #555;padding:4px 8px;">' + (groups[i][j] || '') + '</td>';
                            }
                            html += '</tr>';
                        }
                        html += '</table>';
                        return html;
                    });
                }
                
                // --- Code block detection (expanded for Python control flow & pseudocode) ---
                const hasCode = /(?:def \w+\(|class \w+[:(]|import \w|from \w+ import|print\(|self\.\w+\(|node\.\w+\(|(?:^|\n)\s*if .+:|(?:^|\n)\s*elif .+:|(?:^|\n)\s*else\s*:|(?:^|\n)\s*for \w+ in .+:|(?:^|\n)\s*while .+:|(?:^|\n)\s*return |(?:^|\n)\s*(?:Begin |End )?pseudocode)/.test(formatted);
                const hasTable = formatted.includes('<table');
                const hasIndentation = /\n {2,}\w/.test(formatted) || /\n\t\w/.test(formatted);
                if (hasTable) {
                    // Table already rendered as HTML ‚Äî just handle inline code markers
                    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                } else if (hasCode && hasIndentation) {
                    formatted = '<pre>' + formatted + '</pre>';
                } else if (hasCode) {
                    // Has code calls but no indentation ‚Äî inline code the function calls
                    formatted = formatted.replace(/(\w+\.\w+\([^)]*\))/g, '<code>$1</code>');
                    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                } else {
                    formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
                }

                // Add figure image if available
                let imageHtml = '';
                if (q.image) {
                    imageHtml = `<img src="${q.image}" alt="Figure" style="max-width:100%; height:auto; border-radius:8px; margin:8px 0; display:block; background:#fff; padding:4px;">`;
                }
                contextEl.innerHTML = '<span class="context-label">üìñ Reference</span>' + imageHtml + formatted;
                contextEl.classList.remove('hidden');
                contextEl.classList.add('collapsed');
            } else if (q.image) {
                // No text context but has a figure image ‚Äî show it prominently
                const imgHtml = `<img src="${q.image}" alt="Figure" style="max-width:100%; height:auto; border-radius:8px; margin:8px 0; display:block; background:#fff;">`;
                contextEl.innerHTML = '<span class="context-label">üìñ Reference</span>' + imgHtml;
                contextEl.classList.remove('hidden');
                contextEl.classList.add('collapsed');
            } else {
                contextEl.classList.add('hidden');
                contextEl.innerHTML = '';
            }

            document.getElementById('question-text').innerHTML = addAcronymLinks(displayQuestion);

            // Show answer count
            const count = state.answerCounts[q.id] || 0;
            const countEl = document.getElementById('streak-indicator');
            if (count > 0) {
                countEl.textContent = `Seen ${count}x`;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }

            // Show choices immediately
            document.getElementById('practice-next-btn').classList.add('hidden');
            renderChoices();
        }

        // Shuffle array helper
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render multiple choice
        function renderChoices() {
            const q = state.currentQuestion;
            const container = document.getElementById('choices-container');
            container.innerHTML = '';

            // Create array with original indices and shuffle
            const choicesWithIndices = q.choices.map((choice, index) => ({ choice, originalIndex: index }));
            const shuffled = shuffleArray(choicesWithIndices);
            state.shuffledChoices = shuffled;

            shuffled.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = item.choice;
                btn.onclick = () => selectChoice(index);
                container.appendChild(btn);
            });
        }

        // Select choice
        function selectChoice(index) {
            const q = state.currentQuestion;
            const buttons = document.querySelectorAll('#choices-container .choice-btn');
            const shuffled = state.shuffledChoices;

            // Find which shuffled index contains the correct answer
            const correctShuffledIndex = shuffled.findIndex(item => item.originalIndex === q.correct);

            buttons.forEach((btn, i) => {
                btn.classList.add('disabled');
                if (i === correctShuffledIndex) {
                    btn.classList.add('correct');
                } else if (i === index && index !== correctShuffledIndex) {
                    btn.classList.add('incorrect');
                }
            });

            // Store whether the answer was correct and show Next button
            state.lastAnswerCorrect = index === correctShuffledIndex;
            document.getElementById('practice-next-btn').classList.remove('hidden');

            // Show "View in Source" button if answer was wrong AND question has source location
            const viewSourceBtn = document.getElementById('view-source-btn');
            const hasSourceLocation = q.sourceId && q.sourceLocation && q.sourceLocation.excerpt;
            if (!state.lastAnswerCorrect && hasSourceLocation) {
                viewSourceBtn.classList.add('visible');
            } else {
                viewSourceBtn.classList.remove('visible');
            }
        }

        // Proceed to next question after reviewing answer
        function proceedToNextQuestion() {
            document.getElementById('practice-next-btn').classList.add('hidden');
            recordAnswer(state.lastAnswerCorrect);
        }

        // Record answer
        function recordAnswer(correct) {
            const q = state.currentQuestion;

            state.totalAnswered++;
            state.answerCounts[q.id] = (state.answerCounts[q.id] || 0) + 1;
            if (correct) {
                state.totalCorrect++;
            }

            saveState();
            updateStats();
            loadNextQuestion();
        }

        // Skip question (no penalty, just move on)
        // Review mastered questions (user chose to keep going)
        // Acronym glossary
        const acronymGlossary = {
            'BST': 'Binary Search Tree ‚Äî a tree where left children are smaller, right children are larger',
            'AVL': 'AVL Tree (Adelson-Velsky & Landis) ‚Äî a self-balancing BST where heights of subtrees differ by at most 1',
            'BFS': 'Breadth-First Search ‚Äî explores all neighbors before going deeper (uses a queue)',
            'DFS': 'Depth-First Search ‚Äî explores as deep as possible before backtracking (uses a stack)',
            'BSP': 'Binary Space Partitioning ‚Äî divides space into two sets using hyperplanes',
            'ADT': 'Abstract Data Type ‚Äî a type defined by its behavior (operations) rather than implementation',
            'NP': 'Nondeterministic Polynomial ‚Äî problems verifiable in polynomial time but not necessarily solvable in polynomial time',
            'DAG': 'Directed Acyclic Graph ‚Äî a directed graph with no cycles',
            'MST': 'Minimum Spanning Tree ‚Äî a subset of edges connecting all vertices with minimum total weight',
            'OOP': 'Object-Oriented Programming ‚Äî paradigm based on objects containing data and methods',
            'FIFO': 'First In, First Out ‚Äî the order used by queues',
            'LIFO': 'Last In, First Out ‚Äî the order used by stacks',
            'SLL': 'Singly-Linked List ‚Äî each node points to the next node only',
            'DLL': 'Doubly-Linked List ‚Äî each node points to both next and previous nodes',
            'Big-O': 'Big-O Notation ‚Äî describes the upper bound (worst case) of an algorithm\'s time/space complexity',
            'O(1)': 'Constant time ‚Äî operation takes the same time regardless of input size',
            'O(N)': 'Linear time ‚Äî time grows proportionally with input size',
            'O(N¬≤)': 'Quadratic time ‚Äî time grows with the square of input size (e.g., nested loops)',
            'O(log N)': 'Logarithmic time ‚Äî time grows logarithmically (e.g., binary search, balanced BST operations)',
            'O(N log N)': 'Linearithmic time ‚Äî typical for efficient sorting algorithms (mergesort, heapsort)',
            'RBT': 'Red-Black Tree ‚Äî a self-balancing BST using node coloring rules',
            'ASCII': 'American Standard Code for Information Interchange ‚Äî character encoding standard',
            'API': 'Application Programming Interface ‚Äî a set of rules for software communication',
            'IDE': 'Integrated Development Environment ‚Äî software for writing/debugging code',
            'RAM': 'Random Access Memory ‚Äî fast temporary storage, lost when powered off',
            'CPU': 'Central Processing Unit ‚Äî the "brain" of a computer that executes instructions',
            'PSTN': 'Public Switched Telephone Network ‚Äî traditional phone network',
            'SBC': 'Session Border Controller ‚Äî manages VoIP call sessions',
        };

        function addAcronymLinks(text) {
            if (!text) return '';
            // Escape HTML first
            let safe = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Match acronyms (2+ uppercase letters) and Big-O notations
            const patterns = Object.keys(acronymGlossary).sort((a, b) => b.length - a.length);
            for (const acronym of patterns) {
                const escaped = acronym.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b${escaped}\\b`, 'g');
                safe = safe.replace(regex, `<span class="acronym-link" onclick="showAcronymPopup(event, '${acronym.replace(/'/g, "\\'")}')">${acronym}</span>`);
            }
            return safe;
        }

        function showAcronymPopup(event, acronym) {
            event.stopPropagation();
            // Remove any existing popup
            const existing = document.querySelector('.acronym-popup');
            if (existing) existing.remove();

            const definition = acronymGlossary[acronym] || 'No definition available';
            const popup = document.createElement('div');
            popup.className = 'acronym-popup';
            popup.innerHTML = `<strong>${acronym}</strong><br>${definition}`;

            document.body.appendChild(popup);

            // Position near the click
            const rect = event.target.getBoundingClientRect();
            popup.style.top = (rect.bottom + window.scrollY + 8) + 'px';
            popup.style.left = Math.min(rect.left, window.innerWidth - popup.offsetWidth - 16) + 'px';

            // Dismiss on tap anywhere
            setTimeout(() => {
                document.addEventListener('click', function dismiss() {
                    popup.remove();
                    document.removeEventListener('click', dismiss);
                }, { once: true });
            }, 50);
        }

        function reviewMastered() {
            const filteredQuestions = getFilteredQuestions();
            state.currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            if (state.currentQuestion) {
                const q = state.currentQuestion;
                document.getElementById('category-badge').textContent = q.category;
                document.getElementById('question-counter').textContent = 'Review mode';
                document.getElementById('question-text').textContent = q.q;
                renderChoices();
            }
        }

        function skipQuestion() {
            if (state.currentQuestion) {
                loadNextQuestion();
            }
        }

        // Mark as always know
        function markAlwaysKnow() {
            if (state.currentQuestion) {
                const q = state.currentQuestion;
                if (!state.mastered.includes(q.id)) {
                    state.mastered.push(q.id);
                    state.totalAnswered++;
                    state.totalCorrect++;
                    saveState();
                    updateStats();
                }
                loadNextQuestion();
            }
        }

        // Start final exam
        function startFinalExam() {
            // Shuffle all questions using Fisher-Yates
            state.examQuestions = shuffleArray([...questions]);
            state.examIndex = 0;
            state.examCorrect = 0;
            state.currentMode = 'exam';
            plausible('Exam Start', { props: { questions: state.examQuestions.length } });

            showScreen('exam-screen');
            loadExamQuestion();
            saveState(); // Save immediately so exam can be resumed
        }

        // Resume in-progress exam
        function resumeExam() {
            if (state.examQuestions.length === 0 || state.examIndex >= state.examQuestions.length) {
                showToast('No exam in progress', 'warning');
                return;
            }
            state.currentMode = 'exam';
            showScreen('exam-screen');
            loadExamQuestion();
        }

        // Load exam question
        function loadExamQuestion() {
            if (state.examIndex >= state.examQuestions.length) {
                showExamResults();
                return;
            }

            const q = state.examQuestions[state.examIndex];
            const progress = ((state.examIndex) / state.examQuestions.length) * 100;

            document.getElementById('exam-progress').style.width = progress + '%';
            document.getElementById('exam-counter').textContent =
                `Question ${state.examIndex + 1} of ${state.examQuestions.length}`;
            document.getElementById('exam-category').textContent = q.category;
            document.getElementById('exam-question').textContent = q.q;

            // Hide the Next Question button for fresh question
            document.getElementById('exam-next-btn').classList.add('hidden');

            const container = document.getElementById('exam-choices');
            container.innerHTML = '';

            // Shuffle choices for exam
            const choicesWithIndices = q.choices.map((choice, index) => ({ choice, originalIndex: index }));
            const shuffled = shuffleArray(choicesWithIndices);
            state.examShuffledChoices = shuffled;

            shuffled.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = item.choice;
                btn.onclick = () => selectExamChoice(index);
                container.appendChild(btn);
            });
        }

        // Select exam choice
        function selectExamChoice(index) {
            const q = state.examQuestions[state.examIndex];
            const buttons = document.querySelectorAll('#exam-choices .choice-btn');
            const shuffled = state.examShuffledChoices;

            // Find which shuffled index contains the correct answer
            const correctShuffledIndex = shuffled.findIndex(item => item.originalIndex === q.correct);

            buttons.forEach((btn, i) => {
                btn.classList.add('disabled');
                if (i === correctShuffledIndex) {
                    btn.classList.add('correct');
                } else if (i === index && index !== correctShuffledIndex) {
                    btn.classList.add('incorrect');
                }
            });

            if (index === correctShuffledIndex) {
                state.examCorrect++;
            }

            state.examIndex++;
            saveState(); // Save progress after each answer
            // Show Next Question button instead of auto-advancing
            document.getElementById('exam-next-btn').classList.remove('hidden');
        }

        // Proceed to next exam question after reviewing answer
        function proceedToNextExamQuestion() {
            document.getElementById('exam-next-btn').classList.add('hidden');
            loadExamQuestion();
        }

        // Show exam results
        function showExamResults() {
            const percentage = Math.round((state.examCorrect / state.examQuestions.length) * 100);
            const passed = percentage === 100;
            plausible('Exam Complete', { props: { score: percentage, passed: passed, questions: state.examQuestions.length } });

            showScreen('result-screen');
            document.getElementById('result-score').textContent = percentage + '%';
            document.getElementById('result-score').className = 'result-score ' + (passed ? 'pass' : 'fail');

            if (passed) {
                document.getElementById('result-message').innerHTML =
                    '<span class="pass">PERFECT SCORE! You\'re ready for the exam!</span>';
                document.getElementById('retry-btn').classList.add('hidden');
            } else {
                document.getElementById('result-message').innerHTML =
                    `<span class="fail">You got ${state.examCorrect} out of ${state.examQuestions.length} correct.<br>You need 100% to pass. Keep practicing!</span>`;
                document.getElementById('retry-btn').classList.remove('hidden');
            }

            // Clear exam progress since exam is complete
            state.currentMode = 'menu';
            state.examQuestions = [];
            state.examIndex = 0;
            state.examCorrect = 0;
            saveState(); // Clear saved exam progress
            updateResumeExamButton(false);
        }

        // Show progress
        function showProgress() {
            showScreen('progress-screen');

            const categories = {};
            questions.forEach(q => {
                if (!categories[q.category]) {
                    categories[q.category] = { total: 0, mastered: 0 };
                }
                categories[q.category].total++;
                if (state.mastered.includes(q.id)) {
                    categories[q.category].mastered++;
                }
            });

            let html = `
                <div style="margin-bottom: 20px;">
                    <strong>Overall Progress:</strong> ${state.mastered.length} / ${questions.length} mastered (${Math.round((state.mastered.length/questions.length)*100)}%)
                </div>
                <div style="margin-bottom: 20px;">
                    <strong>Accuracy:</strong> ${state.totalAnswered > 0 ? Math.round((state.totalCorrect/state.totalAnswered)*100) : 0}% (${state.totalCorrect}/${state.totalAnswered})
                </div>
                <h3 style="margin: 20px 0 10px;">By Category:</h3>
            `;

            Object.entries(categories).sort((a,b) => a[0].localeCompare(b[0])).forEach(([cat, data]) => {
                const pct = Math.round((data.mastered / data.total) * 100);
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${cat}</span>
                            <span>${data.mastered}/${data.total} (${pct}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('progress-details').innerHTML = html;
        }

        // Show mastered questions list
        function showMasteredList() {
            showScreen('mastered-screen');

            const masteredQuestions = questions.filter(q => state.mastered.includes(q.id));
            const container = document.getElementById('mastered-list');

            if (masteredQuestions.length === 0) {
                container.innerHTML = '<div class="empty-list-message">No mastered questions yet.</div>';
                return;
            }

            let html = '';
            masteredQuestions.forEach(q => {
                html += `
                    <div class="mastered-item" id="mastered-item-${q.id}">
                        <div class="mastered-item-text">
                            <div class="mastered-item-category">${q.category}</div>
                            ${q.q}
                        </div>
                        <button class="unmaster-btn" onclick="unmasterQuestion(${q.id})">Remove</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Remove a question from mastered list
        function unmasterQuestion(id) {
            const index = state.mastered.indexOf(id);
            if (index > -1) {
                state.mastered.splice(index, 1);
                saveState();
                updateStats();
                // Remove the item from the DOM
                const item = document.getElementById('mastered-item-' + id);
                if (item) {
                    item.remove();
                }
                // Check if list is now empty
                if (state.mastered.length === 0) {
                    document.getElementById('mastered-list').innerHTML = '<div class="empty-list-message">No mastered questions yet.</div>';
                }
            }
        }

        // Reset progress
        async function resetProgress() {
            const confirmed = await showConfirm('Are you sure you want to reset all progress? This cannot be undone.', {
                icon: '‚ö†Ô∏è',
                confirmText: 'Reset All',
                danger: true
            });
            if (confirmed) {
                state.mastered = [];
                state.answerCounts = {};
                state.totalCorrect = 0;
                state.totalAnswered = 0;
                state.examQuestions = [];
                state.examIndex = 0;
                state.examCorrect = 0;
                saveState();
                updateStats();
                updateResumeExamButton(false);
                showToast('Progress has been reset.', 'success');
            }
        }

        // Study Material Content by Category
        const studyMaterials = {
            "IT Roles": `
                <h3>IT Disciplines Overview</h3>
                <ul>
                    <li><span class="key-term">Computer Engineering (CE)</span> - Focuses on design of hardware systems and software that makes them work (drivers, embedded systems)</li>
                    <li><span class="key-term">Computer Science (CS)</span> - Design and implementation of software, solving computing problems (AI, robotics, algorithms)</li>
                    <li><span class="key-term">Software Engineering (SE)</span> - Development and maintenance of reliable, efficient software systems</li>
                    <li><span class="key-term">Information Systems (IS)</span> - Integrating IT solutions to meet business goals</li>
                    <li><span class="key-term">Information Technology (IT)</span> - Technology supporting information systems, practical solutions</li>
                </ul>
                <h3>Administrator Roles</h3>
                <ul>
                    <li><span class="key-term">System Administrator</span> - Technical support for hardware/software, login issues, network vulnerabilities</li>
                    <li><span class="key-term">Network Administrator</span> - Design, plan, setup, and maintain networks</li>
                    <li><span class="key-term">Database Administrator</span> - Install/configure databases, fix errors, create user accounts</li>
                    <li><span class="key-term">Security Administrator</span> - Install and troubleshoot network security</li>
                    <li><span class="key-term">Web Administrator</span> - Troubleshoot websites, analyze usage data, report breaches</li>
                </ul>
                <h3>Architect & Engineer Roles</h3>
                <ul>
                    <li><span class="key-term">Cloud Architect</span> - Oversees cloud computing systems</li>
                    <li><span class="key-term">Network Architect</span> - Designs networks, monitors traffic, installs routers/modems</li>
                    <li><span class="key-term">Cybersecurity Architect</span> - Designs, builds, tests security systems</li>
                    <li><span class="key-term">Machine Learning Engineer</span> - Uses Python, R, Java with ML frameworks</li>
                    <li><span class="key-term">Software Engineer</span> - Develops OS, database systems, embedded systems</li>
                </ul>
                <h3>Analyst & Support Roles</h3>
                <ul>
                    <li><span class="key-term">Systems Analyst</span> - Investigates business problems, creates IS solutions</li>
                    <li><span class="key-term">Data Analyst</span> - Uses statistics for organizational decision-making</li>
                    <li><span class="key-term">Security Analyst</span> - Monitors networks for security breaches</li>
                    <li><span class="key-term">Computer Support Specialist</span> - Supports and maintains workplace technology</li>
                    <li><span class="key-term">Project Manager</span> - Organizes people, time, resources to meet requirements on time/budget</li>
                </ul>`,
            "Data & Information": `
                <h3>DIKW Pyramid (Bottom to Top)</h3>
                <ul>
                    <li><span class="key-term">Data</span> - Raw facts or observations with no context</li>
                    <li><span class="key-term">Information</span> - Data given context that makes it meaningful</li>
                    <li><span class="key-term">Knowledge</span> - Combination of experience, values, contextual information, expert insight</li>
                    <li><span class="key-term">Wisdom</span> - Knowing the right thing to do</li>
                </ul>
                <h3>Data Types</h3>
                <ul>
                    <li><span class="key-term">Structured Data</span> - Easily converted for analysis (names, dates, phone numbers)</li>
                    <li><span class="key-term">Unstructured Data</span> - Complex, not easily decoded (text, videos, audio)</li>
                    <li><span class="key-term">Big Data</span> - Large collections requiring advanced analytical tools</li>
                </ul>
                <h3>Data Quality</h3>
                <ul>
                    <li><span class="key-term">Data Hygiene</span> - Processes ensuring data is error-free</li>
                    <li><span class="key-term">Data Scrubbing</span> - Amending/removing incorrect, incomplete, or duplicate data</li>
                    <li><span class="key-term">Five Quality Attributes</span> - Precise, Valid, Reliable, Timely, Complete</li>
                </ul>
                <h3>Cloud Service Models</h3>
                <ul>
                    <li><span class="key-term">IaaS</span> - Infrastructure as a Service (virtual servers, network connections)</li>
                    <li><span class="key-term">PaaS</span> - Platform as a Service (web application development platform)</li>
                    <li><span class="key-term">SaaS</span> - Software as a Service (Gmail, Office 365 - subscription based)</li>
                </ul>
                <p><span class="key-term">PII (Personally Identifiable Information)</span> - SSN, names, phone numbers that could identify someone</p>`,
            "Hardware": `
                <h3>IPOS - Four Functions of a Computer</h3>
                <ul>
                    <li><span class="key-term">Input</span> - Data entered into the system</li>
                    <li><span class="key-term">Process</span> - CPU executes instructions</li>
                    <li><span class="key-term">Output</span> - Processed information produced</li>
                    <li><span class="key-term">Storage</span> - Data saved for later use</li>
                </ul>
                <h3>CPU Components</h3>
                <ul>
                    <li><span class="key-term">ALU (Arithmetic Logic Unit)</span> - Performs calculations</li>
                    <li><span class="key-term">Control Unit</span> - Directs operations</li>
                    <li><span class="key-term">Processor Registers</span> - Temporary storage</li>
                </ul>
                <h3>Memory Types</h3>
                <ul>
                    <li><span class="key-term">RAM</span> - Random Access Memory, volatile (loses data when powered off)</li>
                    <li><span class="key-term">ROM</span> - Read Only Memory, non-volatile (retains data)</li>
                    <li><span class="key-term">Cache</span> - Fast temporary storage</li>
                </ul>
                <h3>Storage</h3>
                <ul>
                    <li><span class="key-term">HDD</span> - Hard Disk Drive, magnetic spinning platters</li>
                    <li><span class="key-term">SSD</span> - Solid State Drive, flash memory, no moving parts, faster</li>
                </ul>
                <h3>Data Measurement</h3>
                <ul>
                    <li><span class="key-term">Bit</span> - Smallest unit (0 or 1)</li>
                    <li><span class="key-term">Byte</span> - 8 bits (one character)</li>
                    <li><span class="key-term">Kilobyte (KB)</span> - 1,024 bytes</li>
                    <li><span class="key-term">Megabyte (MB)</span> - 1,024 KB</li>
                    <li><span class="key-term">Gigabyte (GB)</span> - 1,024 MB</li>
                </ul>
                <h3>Computer Generations</h3>
                <ul>
                    <li><span class="key-term">1st Gen (1946-1959)</span> - Vacuum tubes, magnetic drums</li>
                    <li><span class="key-term">2nd Gen (1959-1965)</span> - Transistors</li>
                    <li><span class="key-term">3rd Gen (1965-1971)</span> - Integrated circuits on silicon chips</li>
                    <li><span class="key-term">4th Gen (1971-present)</span> - Microprocessors</li>
                </ul>`,
            "Networking": `
                <h3>Network Types by Size</h3>
                <ul>
                    <li><span class="key-term">PAN</span> - Personal Area Network (few feet, like Bluetooth)</li>
                    <li><span class="key-term">LAN</span> - Local Area Network (single building)</li>
                    <li><span class="key-term">WAN</span> - Wide Area Network (cities, states, worldwide - Internet is largest)</li>
                </ul>
                <h3>Network Topologies</h3>
                <ul>
                    <li><span class="key-term">Bus</span> - Machines connected to a common line</li>
                    <li><span class="key-term">Star</span> - Central machine connects all others</li>
                    <li><span class="key-term">Ring</span> - Devices in circular arrangement as peers</li>
                    <li><span class="key-term">Mesh</span> - Every device connected to every other (redundancy)</li>
                </ul>
                <h3>Network Models</h3>
                <ul>
                    <li><span class="key-term">Client/Server</span> - Clients request, servers satisfy requests</li>
                    <li><span class="key-term">Peer-to-Peer (P2P)</span> - Processes both request and provide services</li>
                </ul>
                <h3>Cabling</h3>
                <ul>
                    <li><span class="key-term">Twisted Pair</span> - Two copper wires wound together, max 100m, CAT5e for 1Gbps</li>
                    <li><span class="key-term">Fiber Optic</span> - Light through glass/plastic, 26,000x bandwidth of twisted pair</li>
                </ul>
                <h3>Network Devices</h3>
                <ul>
                    <li><span class="key-term">Repeater</span> - Extends range by boosting signal</li>
                    <li><span class="key-term">Bridge</span> - Connects different network types intelligently</li>
                    <li><span class="key-term">Switch</span> - Reduces traffic by sending to destination only</li>
                    <li><span class="key-term">Router</span> - Forwards messages between networks using routing tables</li>
                    <li><span class="key-term">Modem</span> - Converts analog to digital signals</li>
                </ul>
                <h3>ISP Tiers</h3>
                <ul>
                    <li><span class="key-term">Tier 1</span> - Backbone providers</li>
                    <li><span class="key-term">Tier 2</span> - Regional providers</li>
                    <li><span class="key-term">Tier 3</span> - Access ISPs (homes/businesses)</li>
                </ul>`,
            "Internet": `
                <h3>Key Protocols & Systems</h3>
                <ul>
                    <li><span class="key-term">TCP/IP</span> - Most popular network protocol</li>
                    <li><span class="key-term">DNS</span> - Domain Name System, translates domain names to IP addresses</li>
                    <li><span class="key-term">HTTP</span> - HyperText Transfer Protocol</li>
                    <li><span class="key-term">VoIP</span> - Voice over Internet Protocol</li>
                </ul>
                <h3>IP Addresses</h3>
                <ul>
                    <li><span class="key-term">IPv4</span> - 32-bit, dotted decimal notation (192.207.177.103)</li>
                    <li><span class="key-term">IPv6</span> - 128-bit addresses</li>
                </ul>
                <h3>Web Concepts</h3>
                <ul>
                    <li><span class="key-term">URL</span> - Uniform Resource Locator (unique web address)</li>
                    <li><span class="key-term">HTML</span> - HyperText Markup Language (encodes web documents)</li>
                    <li><span class="key-term">Streaming</span> - Audio/video transport in near real-time</li>
                </ul>
                <h3>Domain TLDs</h3>
                <ul>
                    <li><span class="key-term">.edu</span> - Educational institution</li>
                    <li><span class="key-term">.gov</span> - Government agency</li>
                    <li><span class="key-term">.com</span> - Commercial</li>
                    <li><span class="key-term">.org</span> - Organization</li>
                </ul>
                <p><span class="key-term">Tim Berners-Lee</span> invented the World Wide Web in the late 1980s</p>
                <p><span class="key-term">ICANN</span> coordinates internet operations and awards IP address blocks</p>`,
            "Security": `
                <h3>Types of Malware</h3>
                <ul>
                    <li><span class="key-term">Virus</span> - Inserts into programs, executes when host runs</li>
                    <li><span class="key-term">Worm</span> - Autonomous, self-replicating across networks</li>
                    <li><span class="key-term">Spyware</span> - Collects info and reports to creator</li>
                </ul>
                <h3>Attack Types</h3>
                <ul>
                    <li><span class="key-term">Phishing</span> - Posing as legitimate to obtain private info</li>
                    <li><span class="key-term">DoS (Denial of Service)</span> - Overloading computer with messages</li>
                    <li><span class="key-term">MITM (Man-in-the-Middle)</span> - Intercepting data in transit</li>
                    <li><span class="key-term">Brute Force</span> - Trying all possible combinations</li>
                    <li><span class="key-term">Dictionary Attack</span> - Using dictionary words to crack passwords</li>
                </ul>
                <h3>Security Measures</h3>
                <ul>
                    <li><span class="key-term">Firewall</span> - Filters and blocks suspicious network traffic</li>
                    <li><span class="key-term">Proxy Server</span> - Intermediary protecting clients</li>
                    <li><span class="key-term">Encryption</span> - Encoding information to keep it confidential</li>
                    <li><span class="key-term">Network Auditing</span> - Monitors for anomalies</li>
                </ul>`,
            "Operating Systems": `
                <h3>OS Categories</h3>
                <ul>
                    <li><span class="key-term">Network OS</span></li>
                    <li><span class="key-term">Server OS</span></li>
                    <li><span class="key-term">Mobile OS</span></li>
                    <li><span class="key-term">Personal Computer OS</span></li>
                </ul>
                <h3>Major Operating Systems</h3>
                <ul>
                    <li><span class="key-term">Windows</span> - Closed-source by Microsoft, largest market share</li>
                    <li><span class="key-term">macOS</span> - Closed-source by Apple, Apple hardware only</li>
                    <li><span class="key-term">Linux</span> - Open-source, many distributions</li>
                    <li><span class="key-term">Android</span> - Open-source mobile, largest mobile user base</li>
                    <li><span class="key-term">iOS</span> - Apple's proprietary mobile OS</li>
                </ul>
                <h3>OS Components</h3>
                <ul>
                    <li><span class="key-term">Kernel</span> - Core performing basic functions</li>
                    <li><span class="key-term">File Manager</span> - Coordinates storage, maintains records</li>
                    <li><span class="key-term">Device Driver</span> - Enables communication with peripherals</li>
                    <li><span class="key-term">Utility Software</span> - Extends OS capabilities</li>
                </ul>
                <h3>Interfaces</h3>
                <ul>
                    <li><span class="key-term">CLI</span> - Command Line Interface (text commands)</li>
                    <li><span class="key-term">GUI</span> - Graphical User Interface (visual elements)</li>
                </ul>
                <h3>Path Separators</h3>
                <ul>
                    <li><span class="key-term">Windows</span> - Backslash (\\)</li>
                    <li><span class="key-term">Linux</span> - Forward slash (/), case-sensitive</li>
                </ul>`,
            "Programming": `
                <h3>Code Types</h3>
                <ul>
                    <li><span class="key-term">Source Code</span> - Human-readable high-level language</li>
                    <li><span class="key-term">Machine Code</span> - Binary (0s and 1s) computers execute directly</li>
                </ul>
                <h3>Translators</h3>
                <ul>
                    <li><span class="key-term">Compiler</span> - Translates entire source code at once (C, C++, Java, Go)</li>
                    <li><span class="key-term">Interpreter</span> - Translates line by line (Python, JavaScript, PHP, Ruby)</li>
                </ul>
                <h3>Key Concepts</h3>
                <ul>
                    <li><span class="key-term">Algorithm</span> - Step-by-step instructions for a task</li>
                    <li><span class="key-term">Debugging</span> - Finding and fixing code errors</li>
                </ul>`,
            "Licensing": `
                <h3>Software Types</h3>
                <ul>
                    <li><span class="key-term">Open-Source</span> - Anyone can modify and distribute, accessible source code</li>
                    <li><span class="key-term">Closed-Source/Proprietary</span> - Only owner can modify</li>
                    <li><span class="key-term">Shareware</span> - Trial with time/feature limits</li>
                    <li><span class="key-term">Freeware</span> - Free but protected by EULA/copyright</li>
                    <li><span class="key-term">Public Domain</span> - No EULA, no IP protections</li>
                </ul>
                <h3>Legal Protections</h3>
                <ul>
                    <li><span class="key-term">EULA</span> - End-User License Agreement, defines usage terms</li>
                    <li><span class="key-term">Copyright</span> - Prevents unauthorized duplication (35+ years)</li>
                    <li><span class="key-term">Patent</span> - Protects unique methods, algorithms, processes</li>
                </ul>
                <h3>Software Development Types</h3>
                <ul>
                    <li><span class="key-term">Bespoke</span> - Custom-made for specific organization</li>
                    <li><span class="key-term">Off-the-Shelf</span> - General features for broad use</li>
                </ul>`,
            "Databases": `
                <h3>Database Fundamentals</h3>
                <ul>
                    <li><span class="key-term">Database</span> - Organized collection of integrated data</li>
                    <li><span class="key-term">DBMS</span> - Database Management System, manages and handles queries</li>
                    <li><span class="key-term">Record</span> - A row containing related information</li>
                    <li><span class="key-term">Field</span> - A column with single piece of data</li>
                </ul>
                <h3>Keys</h3>
                <ul>
                    <li><span class="key-term">Primary Key</span> - Unique identifier for each record</li>
                    <li><span class="key-term">Foreign Key</span> - References another table's primary key</li>
                </ul>
                <h3>Database Types</h3>
                <ul>
                    <li><span class="key-term">Flat-File</span> - Plain text, one record per line</li>
                    <li><span class="key-term">Hierarchical</span> - Tree structure, parent-child relationships</li>
                    <li><span class="key-term">Relational</span> - Tables joined using keys</li>
                    <li><span class="key-term">NoSQL</span> - Various models (key-value, document, graph)</li>
                </ul>
                <h3>SQL Basics</h3>
                <ul>
                    <li><span class="key-term">SELECT * FROM table</span> - Retrieve all fields from all records</li>
                    <li><span class="key-term">WHERE</span> - Filters records based on conditions</li>
                </ul>`,
            "Project Management": `
                <h3>Project Definition</h3>
                <p>A <span class="key-term">Project</span> is a purpose-driven event with a defined start and finish</p>
                <h3>Project Life Cycle Phases</h3>
                <ul>
                    <li><span class="key-term">Initiation</span> - Business case, feasibility study, project charter</li>
                    <li><span class="key-term">Planning</span> - Goals, scope, project management plan with estimates</li>
                    <li><span class="key-term">Execution</span> - Actual work performed</li>
                    <li><span class="key-term">Closure</span> - Project completion and handoff</li>
                </ul>
                <h3>SMART Goals</h3>
                <ul>
                    <li><span class="key-term">S</span> - Specific</li>
                    <li><span class="key-term">M</span> - Measurable</li>
                    <li><span class="key-term">A</span> - Attainable</li>
                    <li><span class="key-term">R</span> - Realistic</li>
                    <li><span class="key-term">T</span> - Timely</li>
                </ul>
                <h3>Key Concepts</h3>
                <ul>
                    <li><span class="key-term">Scope Creep</span> - Uncontrolled changes adding tasks and costs</li>
                    <li><span class="key-term">WBS</span> - Work Breakdown Structure, breaks project into segments</li>
                    <li><span class="key-term">KPIs</span> - Key Performance Indicators, metrics for progress</li>
                </ul>`,
            "SDLC": `
                <h3>SDLC (Software Development Life Cycle)</h3>
                <p>A framework for developing software through defined phases</p>
                <h3>Development Models</h3>
                <ul>
                    <li><span class="key-term">Waterfall</span> - Sequential, complete each phase before next</li>
                    <li><span class="key-term">Incremental</span> - Built in increments, adding features</li>
                    <li><span class="key-term">Prototyping</span> - Build and evaluate basic versions first</li>
                    <li><span class="key-term">Agile</span> - Incremental, responds to changing requirements</li>
                    <li><span class="key-term">Scrum</span> - Agile method with sprints and daily scrums</li>
                </ul>
                <h3>Key Documents</h3>
                <ul>
                    <li><span class="key-term">Requirements Analysis</span> - Determines services and user interaction</li>
                    <li><span class="key-term">SRS</span> - System Requirement Specification document</li>
                </ul>`,
            "Testing": `
                <h3>Testing Stages</h3>
                <ul>
                    <li><span class="key-term">Alpha Testing</span> - First stage, internal team tests</li>
                    <li><span class="key-term">Beta Testing</span> - End users test before release (pilot testing)</li>
                    <li><span class="key-term">User Acceptance Testing</span> - Final operational testing for business objectives</li>
                </ul>
                <h3>Testing Approaches</h3>
                <ul>
                    <li><span class="key-term">White-Box Testing</span> - Based on internal component knowledge (glass-box)</li>
                    <li><span class="key-term">Black-Box Testing</span> - Focused on UX without internal knowledge</li>
                </ul>
                <p><span class="key-term">Pareto Principle</span> - 80% of errors come from 20% of the system</p>`,
            "Maintenance": `
                <h3>Maintenance Types</h3>
                <ul>
                    <li><span class="key-term">Corrective</span> - Removes errors, ensures functionality</li>
                    <li><span class="key-term">Adaptive</span> - Changes due to organizational requirement changes</li>
                    <li><span class="key-term">Perfective</span> - Adding/improving components for performance</li>
                    <li><span class="key-term">Preventive</span> - Increases system lifespan (restructuring, optimizing)</li>
                </ul>`,
            "IT Governance": `
                <h3>IT Governance</h3>
                <p>Processes ensuring effective IT use to achieve business goals</p>
                <h3>Five IT Function Domains</h3>
                <ul>
                    <li>Communication</li>
                    <li>Data Collection/Management</li>
                    <li>Information Security</li>
                    <li>Customer Relationship Management</li>
                    <li>Process Improvement</li>
                </ul>
                <h3>Sourcing Options</h3>
                <ul>
                    <li><span class="key-term">Outsourcing</span> - Using external organization resources</li>
                    <li><span class="key-term">Insourcing</span> - Assigning to internal employees</li>
                    <li><span class="key-term">Offshoring</span> - Outsourcing outside the country</li>
                    <li><span class="key-term">Nearshoring</span> - Offshoring to nearby countries/similar time zones</li>
                </ul>`,
            "Software": `
                <h3>Software Categories</h3>
                <ul>
                    <li><span class="key-term">System Software</span> - Operates hardware, platform for applications</li>
                    <li><span class="key-term">Application Software</span> - Specific tasks (word processing, email)</li>
                    <li><span class="key-term">Productivity Software</span> - Documents, presentations, data management</li>
                    <li><span class="key-term">Collaboration Software</span> - Communication and teamwork</li>
                    <li><span class="key-term">Utility Software</span> - System maintenance (disk cleaning)</li>
                </ul>
                <h3>Common Applications</h3>
                <ul>
                    <li><span class="key-term">Word Processing</span> - Word, Google Docs, OpenOffice Writer</li>
                    <li><span class="key-term">Spreadsheets</span> - Excel, Google Sheets, OpenOffice Calc</li>
                    <li><span class="key-term">Presentations</span> - PowerPoint, Google Slides, OpenOffice Impress</li>
                </ul>`,
            "Ethics": `
                <h3>Ethics vs Regulations</h3>
                <ul>
                    <li><span class="key-term">Ethics</span> - Personal or organizational morals guiding behavior</li>
                    <li><span class="key-term">Regulations</span> - Requirements from governing bodies with penalties for violations</li>
                    <li><span class="key-term">Conflict of Interest</span> - When a person has incompatible loyalties or relationships</li>
                </ul>
                <h3>Professional Organizations</h3>
                <ul>
                    <li><span class="key-term">ACM</span> - Association for Computing Machinery</li>
                    <li><span class="key-term">IEEE</span> - Institute of Electrical and Electronics Engineers</li>
                    <li><span class="key-term">AITP</span> - Association of Information Technology Professionals</li>
                    <li><span class="key-term">Computer Ethics Institute</span> - Created Ten Commandments of Computer Ethics</li>
                </ul>
                <h3>Policies & Standards</h3>
                <ul>
                    <li><span class="key-term">Acceptable Use Policy (AUP)</span> - Details how organizational computer systems can be used</li>
                    <li><span class="key-term">CIA Triad</span> - Confidentiality, Integrity, Availability</li>
                    <li><span class="key-term">Confidentiality</span> - Restricting access to those who need to know</li>
                    <li><span class="key-term">Integrity</span> - Ensuring data is not modified by unauthorized users</li>
                    <li><span class="key-term">Availability</span> - Ensuring authorized users can access data when needed</li>
                </ul>`
        };

        // Modal Functions
        function openStudyMaterial() {
            let category;
            if (state.currentMode === 'practice' && state.currentQuestion) {
                category = state.currentQuestion.category;
            } else if (state.currentMode === 'exam' && state.examQuestions[state.examIndex - 1]) {
                category = state.examQuestions[state.examIndex - 1].category;
            } else if (state.currentMode === 'exam' && state.examQuestions[state.examIndex]) {
                category = state.examQuestions[state.examIndex].category;
            }

            if (category && studyMaterials[category]) {
                document.getElementById('modal-title').textContent = category + ' - Study Material';
                document.getElementById('modal-body').innerHTML = studyMaterials[category];
            } else {
                // Check for zyBooks chapter link (C949 - Chapter X: Title)
                const chapterMatch = category ? category.match(/C949\s*-\s*Chapter\s+(\d+):\s*(.+)/) : null;
                if (chapterMatch) {
                    const chNum = chapterMatch[1];
                    const chTitle = chapterMatch[2].trim();
                    const zyBooksUrl = `https://learn.zybooks.com/zybook/WGUC949DataStructuresv4/chapter/${chNum}/section/1`;
                    document.getElementById('modal-title').textContent = `Chapter ${chNum}: ${chTitle}`;
                    document.getElementById('modal-body').innerHTML = `
                        <p style="margin-bottom: 15px;">üìö <strong>Chapter ${chNum}: ${chTitle}</strong></p>
                        <a href="${zyBooksUrl}" target="_blank" rel="noopener" 
                           onclick="window.open('${zyBooksUrl}', '_blank'); return false;"
                           style="display: inline-block; padding: 12px 24px; background: #2563eb; color: white; 
                                  border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 15px;">
                            üìñ Open in zyBooks
                        </a>
                        <p style="color: #aab; font-size: 0.9rem;">Opens the zyBooks textbook to this chapter. You'll need to be logged into WGU.</p>
                    `;
                } else {
                    // Map pre-assessment categories to zyBooks chapters
                    const categoryChapterMap = {
                        'Sorting Algorithms': [11, 'Searching and Sorting Algorithms'],
                        'Search Algorithms': [11, 'Searching and Sorting Algorithms'],
                        'Trees': [5, 'Trees'],
                        'Graphs': [9, 'Graphs'],
                        'Hash Tables': [6, 'Hash Tables'],
                        'Linked Lists': [2, 'Lists'],
                        'Stacks': [3, 'Stacks and Queues'],
                        'Queues': [3, 'Stacks and Queues'],
                        'Recursion': [7, 'Recursion'],
                        'Sets': [8, 'Sets'],
                        'Abstract Data Types': [4, 'Abstract Data Types'],
                        'Data Structures': [1, 'Introduction to Data Structures and Algorithms'],
                        'Algorithm Fundamentals': [1, 'Introduction to Data Structures and Algorithms'],
                        'Complexity Analysis': [12, 'Algorithm Analysis'],
                        'OOP Fundamentals': [17, 'Object-Oriented Programming'],
                        'Python': [18, 'Functions'],
                        'Logic & Control Flow': [19, 'Expressions and Operators']
                    };
                    const mapped = category ? categoryChapterMap[category] : null;
                    if (mapped) {
                        const [mapChNum, mapChTitle] = mapped;
                        const mapUrl = `https://learn.zybooks.com/zybook/WGUC949DataStructuresv4/chapter/${mapChNum}/section/1`;
                        document.getElementById('modal-title').textContent = `${category}`;
                        document.getElementById('modal-body').innerHTML = `
                            <p style="margin-bottom: 10px;">üìö <strong>${category}</strong> ‚Üí Chapter ${mapChNum}: ${mapChTitle}</p>
                            <a href="${mapUrl}" target="_blank" rel="noopener"
                               onclick="window.open('${mapUrl}', '_blank'); return false;"
                               style="display: inline-block; padding: 12px 24px; background: #2563eb; color: white;
                                      border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 15px;">
                                üìñ Open in zyBooks
                            </a>
                            <p style="color: #aab; font-size: 0.9rem;">Opens the zyBooks textbook to the relevant chapter.</p>
                        `;
                    } else {
                        document.getElementById('modal-title').textContent = 'Study Material';
                        document.getElementById('modal-body').innerHTML = `
                            <p>No study material available for this category: <strong>${category || 'Unknown'}</strong></p>
                            <p style="margin-top: 15px;">For the full course content, return to the menu and click "View Course Content".</p>
                        `;
                    }
                }
            }
            document.getElementById('study-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeStudyMaterial() {
            document.getElementById('study-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeModalOnOverlay(event) {
            if (event.target === document.getElementById('study-modal')) {
                closeStudyMaterial();
            }
        }

        // ========== IMPORT FUNCTIONALITY ==========
        let parsedImportData = [];

        // Parse quiz data from text
        function parseQuizData(text) {
            let result = { questions: [], format: 'Unknown' };

            // Try JSON first
            result = tryParseJSON(text);

            // Try CSV if JSON failed
            if (result.questions.length === 0) {
                result = tryParseCSV(text);
            }

            // Try Q&A text format
            if (result.questions.length === 0) {
                result = tryParseQAText(text);
            }

            // Try simple line-by-line (flashcard style)
            if (result.questions.length === 0) {
                result = tryParseFlashcards(text);
            }

            return result;
        }

        function tryParseJSON(text) {
            try {
                const data = JSON.parse(text);
                const arr = Array.isArray(data) ? data : [data];
                const questions = arr.map((item, idx) => normalizeQuestion(item, idx)).filter(q => q !== null);
                return { questions, format: 'JSON' };
            } catch (e) {
                return { questions: [], format: 'Unknown' };
            }
        }

        function tryParseCSV(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length < 2) return { questions: [], format: 'Unknown' };

            // Check if first line looks like a header
            const firstLine = lines[0].toLowerCase();
            const hasHeader = firstLine.includes('question') || firstLine.includes('q,') || firstLine.includes('"q"') || firstLine.includes('category');

            // Detect column positions from header
            let categoryCol = -1;
            let questionCol = 0;
            let answerCol = 1;

            if (hasHeader) {
                const headerParts = parseCSVLine(lines[0].toLowerCase());
                categoryCol = headerParts.findIndex(h => h === 'category' || h === 'cat');
                const qCol = headerParts.findIndex(h => h === 'question' || h === 'q');
                const aCol = headerParts.findIndex(h => h === 'answer' || h === 'a');
                if (qCol !== -1) questionCol = qCol;
                if (aCol !== -1) answerCol = aCol;
            }

            const dataLines = hasHeader ? lines.slice(1) : lines;
            const questions = [];

            for (let i = 0; i < dataLines.length; i++) {
                const parsed = parseCSVLine(dataLines[i]);
                if (parsed.length >= 2) {
                    const category = categoryCol !== -1 && parsed[categoryCol] ? parsed[categoryCol] : 'Imported';
                    const q = {
                        id: questions.length + 1,
                        category: category,
                        q: parsed[questionCol] || parsed[0],
                        a: parsed[answerCol] || parsed[1],
                        choices: parsed.length >= 6 ? [parsed[2], parsed[3], parsed[4], parsed[5]] : generateChoices(parsed[answerCol] || parsed[1]),
                        correct: parsed.length >= 7 ? parseInt(parsed[6]) || 0 : 0
                    };
                    questions.push(q);
                }
            }

            return { questions, format: questions.length > 0 ? 'CSV' : 'Unknown' };
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function tryParseQAText(text) {
            const questions = [];
            // Match Q: ... A: ... patterns
            const qaPattern = /Q:\s*(.+?)[\n\r]+A:\s*(.+?)(?=[\n\r]+Q:|$)/gis;
            let match;

            while ((match = qaPattern.exec(text)) !== null) {
                const q = {
                    id: questions.length + 1,
                    category: 'Imported',
                    q: match[1].trim(),
                    a: match[2].trim(),
                    choices: generateChoices(match[2].trim()),
                    correct: 0
                };
                questions.push(q);
            }

            return { questions, format: questions.length > 0 ? 'Q&A Text' : 'Unknown' };
        }

        function tryParseFlashcards(text) {
            const questions = [];
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);

            // Look for patterns like "term: definition" or "term - definition"
            for (const line of lines) {
                let parts = null;
                if (line.includes(':')) {
                    parts = line.split(':').map(p => p.trim());
                } else if (line.includes(' - ')) {
                    parts = line.split(' - ').map(p => p.trim());
                } else if (line.includes('\t')) {
                    parts = line.split('\t').map(p => p.trim());
                }

                if (parts && parts.length >= 2 && parts[0] && parts[1]) {
                    const q = {
                        id: questions.length + 1,
                        category: 'Imported',
                        q: parts[0].endsWith('?') ? parts[0] : `What is ${parts[0]}?`,
                        a: parts[1],
                        choices: generateChoices(parts[1]),
                        correct: 0
                    };
                    questions.push(q);
                }
            }

            return { questions, format: questions.length > 0 ? 'Flashcards' : 'Unknown' };
        }

        function normalizeQuestion(item, idx) {
            // Handle various JSON formats
            const q = item.q || item.question || item.Q || item.Question;
            const a = item.a || item.answer || item.A || item.Answer;

            if (!q) return null;

            let choices = item.choices || item.options || item.Options;
            let correct = item.correct ?? item.correctIndex ?? item.answer_index ?? 0;

            if (!choices || !Array.isArray(choices) || choices.length < 2) {
                choices = generateChoices(a || '');
                correct = 0;
            }

            return {
                id: idx + 1,
                category: item.category || item.Category || 'Imported',
                q: q,
                a: a || choices[correct] || '',
                choices: choices,
                correct: correct
            };
        }

        function generateChoices(answer) {
            // For Q&A without choices, generate placeholder choices
            return [
                answer,
                'Alternative answer 1',
                'Alternative answer 2',
                'Alternative answer 3'
            ];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape string for use in HTML attributes (escapes quotes too)
        function escapeAttr(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Escape string for use in JavaScript onclick handlers
        function escapeJsString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t')
                .replace(/</g, '\\x3c')
                .replace(/>/g, '\\x3e')
                .replace(/&/g, '\\x26');
        }

        // ========== SOURCE MATERIAL VIEWER ==========

        function showSourcesModal() {
            document.getElementById('sources-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('source-content-view').style.display = 'none';
            document.getElementById('sources-list').style.display = 'block';
            loadSources();
        }

        function closeSourcesModal() {
            document.getElementById('sources-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function closeSourcesModalOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeSourcesModal();
            }
        }

        // Handle source file upload from Quiz Data modal
        async function handleSourceFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentUser) {
                showToast('Please sign in to upload files.', 'warning');
                return;
            }

            try {
                // Show loading state
                document.getElementById('sources-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Uploading...</div>';

                // Use the same upload function as Create Quiz modal
                const sourceId = await uploadNewSource(file);

                if (sourceId) {
                    showToast(`Uploaded "${file.name}" successfully!`, 'success');
                    loadSources(); // Refresh the list
                } else {
                    throw new Error('Upload failed');
                }
            } catch (err) {
                showToast(`Upload failed: ${err.message}`, 'error');
                loadSources(); // Refresh to show current state
            }

            // Reset file input
            event.target.value = '';
        }

        // Scrape content from a URL
        async function scrapeUrlSource() {
            const urlInput = document.getElementById('source-url-input');
            const statusDiv = document.getElementById('url-scrape-status');
            const scrapeBtn = document.getElementById('scrape-url-btn');
            const url = urlInput.value.trim();

            if (!url) {
                showToast('Please enter a URL.', 'warning');
                return;
            }

            // Basic URL validation
            try {
                new URL(url);
            } catch {
                showToast('Please enter a valid URL.', 'error');
                return;
            }

            if (!currentUser) {
                showToast('Please sign in to import URLs.', 'warning');
                return;
            }

            // Show loading state
            scrapeBtn.disabled = true;
            scrapeBtn.innerHTML = '<span class="loading-spinner"></span> Importing...';
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#1a1a2e';
            statusDiv.style.color = '#ccc';
            statusDiv.innerHTML = 'Fetching content from URL...';

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/scrape-url.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to scrape URL');
                }

                // Success
                statusDiv.style.background = '#1a3a1a';
                statusDiv.style.color = '#4CAF50';
                if (data.existing) {
                    statusDiv.innerHTML = `<strong>${data.title || data.domain}</strong> already imported`;
                } else {
                    statusDiv.innerHTML = `<strong>${data.title || data.domain}</strong> imported (${Math.round(data.contentLength / 1024)}KB)`;
                }

                // Clear input and refresh sources
                urlInput.value = '';
                loadSources();

                showToast(data.existing ? 'URL already imported!' : 'URL imported successfully!', 'success');

            } catch (err) {
                statusDiv.style.background = '#3a1a1a';
                statusDiv.style.color = '#f44336';
                statusDiv.innerHTML = err.message;
                showToast(`Import failed: ${err.message}`, 'error');
            } finally {
                scrapeBtn.disabled = false;
                scrapeBtn.innerHTML = 'üåê Import URL';
            }
        }

        // Toggle import section visibility
        function toggleImportSection() {
            const section = document.getElementById('import-section');
            const icon = document.getElementById('import-toggle-icon');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚àí';
            } else {
                section.style.display = 'none';
                icon.textContent = '+';
            }
        }

        // Handle file select in modal
        function handleFileSelectModal(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('import-textarea-modal').value = e.target.result;
                parseImportDataModal();
            };
            reader.readAsText(file);
        }

        // Parse import data in modal
        let parsedImportDataModal = [];
        function parseImportDataModal() {
            const text = document.getElementById('import-textarea-modal').value.trim();
            if (!text) {
                showToast('Please enter or paste quiz data first.', 'warning');
                return;
            }

            // Try to parse using the same logic as the main import
            const result = parseQuizData(text);
            parsedImportDataModal = result.questions;

            if (parsedImportDataModal.length === 0) {
                showToast('Could not parse any questions from the input.', 'error');
                return;
            }

            // Show preview
            document.getElementById('import-count-modal').textContent = parsedImportDataModal.length;
            document.getElementById('import-format-modal').textContent = result.format;
            document.getElementById('import-preview-modal').innerHTML = parsedImportDataModal.slice(0, 3).map(q =>
                `<div style="margin-bottom: 5px;">Q: ${escapeHtml((q.q || q.question || '').substring(0, 60))}...</div>`
            ).join('');
            document.getElementById('import-preview-section-modal').style.display = 'block';
            document.getElementById('import-confirm-btn-modal').disabled = false;
        }

        // Confirm import in modal
        async function confirmImportModal() {
            if (parsedImportDataModal.length === 0) {
                showToast('No questions to import.', 'warning');
                return;
            }

            const replaceMode = document.getElementById('import-replace-modal').checked;

            // Check free limit for non-Pro users
            if (!state.isPro && !replaceMode) {
                const currentImported = state.importedQuestionCount || 0;
                const newTotal = currentImported + parsedImportDataModal.length;
                if (newTotal > FREE_IMPORT_LIMIT) {
                    const remaining = FREE_IMPORT_LIMIT - currentImported;
                    showToast(`Free accounts can import up to ${FREE_IMPORT_LIMIT} questions. You have ${remaining} remaining. Upgrade to Pro for unlimited imports!`, 'warning', 6000);
                    showUpgradeModal();
                    return;
                }
            }

            const importCount = parsedImportDataModal.length;

            if (replaceMode) {
                // Replace all questions
                questions.length = 0;
                parsedImportDataModal.forEach((q, idx) => {
                    q.id = idx + 1;
                    questions.push(q);
                });
                // Reset progress since questions changed
                state.mastered = [];
                state.answerCounts = {};
                state.totalCorrect = 0;
                state.totalAnswered = 0;
                state.importedQuestionCount = parsedImportDataModal.length;
            } else {
                // Add to existing questions
                const startId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
                parsedImportDataModal.forEach((q, idx) => {
                    q.id = startId + idx;
                    questions.push(q);
                });
                state.importedQuestionCount = (state.importedQuestionCount || 0) + parsedImportDataModal.length;
            }

            // Update UI and save immediately
            updateStats();
            initCategoryFilter(); // Refresh categories from imported questions
            saveState(true);

            plausible('Import', { props: { count: importCount, mode: replaceMode ? 'replace' : 'append' } });

            // Reset the form
            document.getElementById('import-textarea-modal').value = '';
            document.getElementById('import-preview-section-modal').style.display = 'none';
            document.getElementById('import-confirm-btn-modal').disabled = true;
            parsedImportDataModal = [];

            // Collapse import section and reload sources
            document.getElementById('import-section').style.display = 'none';
            document.getElementById('import-toggle-icon').textContent = '+';
            loadSources();

            showToast(`Successfully imported ${importCount} questions to "${currentKeyword}"!${replaceMode ? ' Progress has been reset.' : ''}`, 'success', 5000);
        }

        async function loadSources() {
            const listEl = document.getElementById('sources-list');

            // Check if user is logged in
            if (!currentUser) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        <p>Please sign in to view your imported sources.</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;">Loading sources...</div>';

            try {
                // Load ALL sources for this user (new user-level API)
                const url = `${VANDROMEDA_API}/quizmyself/source.php`;
                const token = await currentUser.getIdToken();
                const headers = { 'Authorization': `Bearer ${token}` };

                const response = await fetch(url, { headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load sources');
                }

                // Update storage bar
                const usedMB = (data.storageUsed / (1024 * 1024)).toFixed(2);
                const limitMB = (data.storageLimit / (1024 * 1024)).toFixed(0);
                const percent = data.storageLimit > 0 ? (data.storageUsed / data.storageLimit) * 100 : 0;

                document.getElementById('sources-storage-text').textContent = `${usedMB} MB / ${limitMB} MB${data.isPro ? ' (Pro)' : ''}`;
                document.getElementById('sources-storage-bar').style.width = `${Math.min(percent, 100)}%`;

                if (data.sources.length === 0) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #888;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
                            <p>No source materials yet.</p>
                            <p style="font-size: 0.9rem;">Create a quiz and upload study material to see it here.</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = data.sources.map(source => {
                    const isUrl = source.sourceType === 'url';
                    const icon = isUrl ? 'üåê' : getContentTypeIcon(source.contentType);
                    const subtitle = isUrl && source.sourceDomain ? source.sourceDomain : null;
                    return `
                    <div class="source-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                <span style="font-weight: bold; color: #fff;">${icon} ${escapeHtml(source.name)}</span>
                                ${source.linkedKeyword ? `<span style="background: #0f3460; color: #4fc3f7; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">Linked</span>` : ''}
                                ${isUrl ? `<span style="background: #1a3a1a; color: #4CAF50; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">URL</span>` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #888;">
                                ${subtitle ? `<span style="color: #888;">${escapeHtml(subtitle)}</span> | ` : ''}
                                ${source.linkedKeyword ?
                                    `<span style="color: #4fc3f7;">${escapeHtml(source.linkedKeywordDisplay || source.linkedKeyword)}</span> | ` :
                                    '<span style="color: #666;">Unlinked</span> | '
                                }
                                ${formatBytes(source.sizeBytes)} | ${formatDate(source.createdAt)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            ${!source.linkedKeyword ? `<button class="btn btn-small btn-success" data-action="link-source" data-source-id="${source.id}" data-source-name="${escapeAttr(source.name)}">Link</button>` : ''}
                            ${source.linkedKeyword ? `<button class="btn btn-small" style="background: #555;" data-action="unlink-source" data-keyword="${escapeAttr(source.linkedKeyword)}">Unlink</button>` : ''}
                            <button class="btn btn-small" data-action="view-source" data-source-id="${source.id}" data-source-name="${escapeAttr(source.name)}" data-content-type="${escapeAttr(source.contentType || 'text/plain')}">View</button>
                            <button class="btn btn-danger btn-small" data-action="delete-source" data-source-id="${source.id}" data-source-name="${escapeAttr(source.name)}">Delete</button>
                        </div>
                    </div>
                `}).join('');

            } catch (err) {
                console.error('Error loading sources:', err);
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        <p>Failed to load sources: ${escapeHtml(err.message)}</p>
                        <button class="btn btn-small" onclick="loadSources()" style="margin-top: 15px;">Retry</button>
                    </div>
                `;
            }
        }

        // ========== FORMAT-AWARE SOURCE VIEWER ==========

        let pdfDoc = null;
        let pdfCurrentPage = 1;
        let pdfTotalPages = 0;

        // Load PDF.js from CDN
        let pdfjsLoaded = false;
        async function loadPDFJS() {
            if (pdfjsLoaded) return;

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfjsLoaded = true;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function viewSourceContent(id, name, contentType) {
            // Store current source ID for AI generation
            currentViewingSourceId = id;

            // Hide all viewers first
            document.getElementById('source-viewer-text').style.display = 'none';
            document.getElementById('source-viewer-html').style.display = 'none';
            document.getElementById('source-viewer-pdf').style.display = 'none';
            document.getElementById('source-viewer-loading').style.display = 'block';

            document.getElementById('sources-list').style.display = 'none';
            document.getElementById('source-content-view').style.display = 'block';
            document.getElementById('source-content-title').textContent = name;

            // Set content type badge
            const badge = document.getElementById('source-content-type-badge');
            if (contentType.includes('pdf')) badge.textContent = 'PDF';
            else if (contentType.includes('html')) badge.textContent = 'HTML';
            else if (contentType.includes('json')) badge.textContent = 'JSON';
            else if (contentType.includes('csv')) badge.textContent = 'CSV';
            else badge.textContent = 'Text';

            try {
                // Use new API endpoint (user-level sources)
                const url = `${VANDROMEDA_API}/quizmyself/source.php?id=${id}`;
                const token = await currentUser.getIdToken();
                const headers = { 'Authorization': `Bearer ${token}` };

                const response = await fetch(url, { headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load source');
                }

                document.getElementById('source-viewer-loading').style.display = 'none';

                // Route to appropriate viewer based on content type
                const actualContentType = data.contentType || contentType || 'text/plain';

                if (actualContentType.includes('pdf')) {
                    // Simple approach: create blob and open in iframe
                    const binary = atob(data.content);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                    const blob = new Blob([bytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);

                    // Use iframe to display PDF
                    const container = document.getElementById('source-viewer-pdf');
                    container.innerHTML = `<iframe src="${url}" style="width:100%; height:70vh; border:none;"></iframe>`;
                    container.style.display = 'block';
                    return;
                } else if (actualContentType.includes('html')) {
                    await renderHTML(data.content, data.isBase64, data.isCompressed);
                } else {
                    await renderText(data.content, data.isCompressed);
                }

            } catch (err) {
                document.getElementById('source-viewer-loading').style.display = 'none';
                document.getElementById('source-viewer-text').style.display = 'block';
                document.getElementById('source-viewer-text').textContent = `Error: ${err.message}`;
            }
        }

        async function renderPDF(content, isBase64) {
            try {
                await loadPDFJS();

                // Decode base64 to bytes
                let bytes;
                if (isBase64) {
                    const binary = atob(content);
                    bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) {
                        bytes[i] = binary.charCodeAt(i);
                    }
                } else {
                    const encoder = new TextEncoder();
                    bytes = encoder.encode(content);
                }

                // Load PDF
                pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
                pdfTotalPages = pdfDoc.numPages;
                pdfCurrentPage = 1;

                document.getElementById('source-viewer-pdf').style.display = 'block';
                updatePdfPageInfo();
                await renderPdfPage(pdfCurrentPage);

            } catch (err) {
                console.error('PDF render error:', err);
                document.getElementById('source-viewer-text').style.display = 'block';
                document.getElementById('source-viewer-text').textContent = `Failed to render PDF: ${err.message}`;
            }
        }

        async function renderPdfPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');

            const viewport = page.getViewport({ scale: 1.5 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
        }

        function updatePdfPageInfo() {
            document.getElementById('pdf-page-info').textContent = `Page ${pdfCurrentPage} of ${pdfTotalPages}`;
            document.getElementById('pdf-prev-btn').disabled = pdfCurrentPage <= 1;
            document.getElementById('pdf-next-btn').disabled = pdfCurrentPage >= pdfTotalPages;
        }

        async function pdfPrevPage() {
            if (pdfCurrentPage > 1) {
                pdfCurrentPage--;
                updatePdfPageInfo();
                await renderPdfPage(pdfCurrentPage);
            }
        }

        async function pdfNextPage() {
            if (pdfCurrentPage < pdfTotalPages) {
                pdfCurrentPage++;
                updatePdfPageInfo();
                await renderPdfPage(pdfCurrentPage);
            }
        }

        async function renderHTML(content, isBase64, isCompressed) {
            let htmlContent = content;
            if (isBase64) {
                const binary = atob(content);
                htmlContent = new TextDecoder().decode(new Uint8Array([...binary].map(c => c.charCodeAt(0))));
            }

            // Decompress if needed
            if (isCompressed) {
                const decompressed = await decompressContent(htmlContent);
                if (decompressed) {
                    htmlContent = decompressed;
                }
            }

            const iframe = document.getElementById('source-viewer-html');
            iframe.style.display = 'block';
            iframe.srcdoc = htmlContent;
        }

        async function renderText(content, isCompressed) {
            let textContent = content;

            // Decompress if needed
            if (isCompressed) {
                const decompressed = await decompressContent(content);
                if (decompressed) {
                    textContent = decompressed;
                } else {
                    textContent = '(Failed to decompress content)';
                }
            }

            document.getElementById('source-viewer-text').style.display = 'block';
            document.getElementById('source-viewer-text').textContent = textContent || '(No content)';
        }

        function hideSourceContent() {
            document.getElementById('source-content-view').style.display = 'none';
            document.getElementById('sources-list').style.display = 'block';

            // Clean up PDF state
            pdfDoc = null;
            pdfCurrentPage = 1;
            pdfTotalPages = 0;
        }

        // ========== AI QUIZ GENERATION ==========

        let aiGenerationState = {
            sourceId: null,
            sourceName: null,
            sourceText: null,
            questions: [],
            usage: null,
            // Coverage mode state
            coverageState: {
                mode: 'quick',
                jobId: null,
                chunks: [],
                currentChunk: 0,
                completedChunks: [],
                totalQuestions: 0,
                status: 'idle',
                isCancelled: false,
                estimate: null,
                allQuestions: []
            }
        };

        async function generateQuizFromSource() {
            if (!currentUser) {
                showToast('Please sign in to generate quizzes', 'warning');
                return;
            }

            // Get current source info from the viewer
            const sourceTitle = document.getElementById('source-content-title').textContent;
            const sourceId = currentViewingSourceId;

            if (!sourceId) {
                showToast('No source selected', 'error');
                return;
            }

            aiGenerationState.sourceId = sourceId;
            aiGenerationState.sourceName = sourceTitle;

            // Open the AI generation modal
            openAIGenerateModal();
        }

        let currentViewingSourceId = null;

        function openAIGenerateModal() {
            document.getElementById('ai-generate-modal').classList.remove('hidden');
            resetAIGeneration();
            loadAIUsage();
        }

        function closeAIGenerateModal() {
            document.getElementById('ai-generate-modal').classList.add('hidden');
        }

        function resetAIGeneration() {
            document.getElementById('ai-gen-initial').style.display = 'block';
            document.getElementById('ai-gen-loading').style.display = 'none';
            document.getElementById('ai-gen-preview').style.display = 'none';
            document.getElementById('ai-gen-chat').style.display = 'none';
            document.getElementById('ai-gen-error').style.display = 'none';
            document.getElementById('ai-gen-coverage-progress').style.display = 'none';
            document.getElementById('ai-gen-coverage-complete').style.display = 'none';
            aiGenerationState.questions = [];

            // Reset coverage state
            aiGenerationState.coverageState = {
                mode: 'quick',
                jobId: null,
                chunks: [],
                currentChunk: 0,
                completedChunks: [],
                totalQuestions: 0,
                status: 'idle',
                isCancelled: false,
                estimate: null,
                allQuestions: []
            };

            // Reset mode toggle to quick
            setGenerationMode('quick');
        }

        // ========== COVERAGE MODE FUNCTIONS ==========

        function setGenerationMode(mode) {
            const quickBtn = document.getElementById('mode-btn-quick');
            const coverageBtn = document.getElementById('mode-btn-coverage');
            const quickOptions = document.getElementById('quick-quiz-options');
            const coverageOptions = document.getElementById('coverage-options');

            aiGenerationState.coverageState.mode = mode;

            if (mode === 'quick') {
                quickBtn.classList.add('active');
                coverageBtn.classList.remove('active');
                quickOptions.style.display = 'block';
                coverageOptions.style.display = 'none';
            } else {
                quickBtn.classList.remove('active');
                coverageBtn.classList.add('active');
                quickOptions.style.display = 'none';
                coverageOptions.style.display = 'block';
                loadCoverageEstimate();
            }
        }

        async function loadCoverageEstimate() {
            const sourceId = aiGenerationState.sourceId;
            if (!sourceId) return;

            const questionsPerSection = document.getElementById('coverage-questions-per-section').value;

            document.getElementById('coverage-estimate-loading').style.display = 'block';
            document.getElementById('coverage-estimate-container').style.display = 'none';
            document.getElementById('coverage-block-reason').style.display = 'none';
            document.getElementById('coverage-start-btn').disabled = true;

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(
                    `${VANDROMEDA_API}/quizmyself/coverage-estimate.php?sourceId=${sourceId}&questionsPerSection=${questionsPerSection}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze source');
                }

                aiGenerationState.coverageState.estimate = data;
                aiGenerationState.coverageState.chunks = data.sections;

                document.getElementById('estimate-sections').textContent = data.sectionCount;
                document.getElementById('estimate-questions').textContent = data.estimatedQuestions;
                document.getElementById('estimate-calls').textContent = data.estimatedCalls;

                document.getElementById('coverage-estimate-loading').style.display = 'none';
                document.getElementById('coverage-estimate-container').style.display = 'block';

                const usageText = `${data.usage.remaining} of ${data.usage.limit} coverage jobs (${data.usage.period})`;
                document.getElementById('coverage-usage-text').textContent = usageText;

                if (!data.canProceed) {
                    document.getElementById('coverage-block-reason').textContent = data.blockReason;
                    document.getElementById('coverage-block-reason').style.display = 'block';
                    document.getElementById('coverage-start-btn').disabled = true;
                } else {
                    document.getElementById('coverage-start-btn').disabled = false;
                }

            } catch (err) {
                console.error('Coverage estimate error:', err);
                document.getElementById('coverage-estimate-loading').style.display = 'none';
                document.getElementById('coverage-block-reason').textContent = err.message;
                document.getElementById('coverage-block-reason').style.display = 'block';
            }
        }

        async function startFullCoverage() {
            const sourceId = aiGenerationState.sourceId;
            const questionsPerSection = parseInt(document.getElementById('coverage-questions-per-section').value);
            const difficulty = document.getElementById('coverage-difficulty').value;

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/coverage-init.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceId: sourceId,
                        questionsPerSection: questionsPerSection,
                        difficulty: difficulty
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Failed to initialize coverage job');
                }

                aiGenerationState.coverageState.jobId = data.jobId;
                aiGenerationState.coverageState.chunks = data.chunks;
                aiGenerationState.coverageState.currentChunk = 0;
                aiGenerationState.coverageState.completedChunks = [];
                aiGenerationState.coverageState.totalQuestions = 0;
                aiGenerationState.coverageState.allQuestions = [];
                aiGenerationState.coverageState.status = 'generating';
                aiGenerationState.coverageState.isCancelled = false;

                showCoverageProgress();
                processNextChunk();

            } catch (err) {
                console.error('Coverage init error:', err);
                showToast(err.message, 'error');
            }
        }

        function showCoverageProgress() {
            document.getElementById('ai-gen-initial').style.display = 'none';
            document.getElementById('ai-gen-coverage-progress').style.display = 'block';

            const sectionList = document.getElementById('coverage-section-list');
            sectionList.innerHTML = aiGenerationState.coverageState.chunks.map((chunk, idx) => `
                <div class="section-item pending" id="section-item-${idx}">
                    <span class="section-status">‚è≥</span>
                    <span class="section-name">${escapeHtml(chunk.sectionName)}</span>
                    <span class="section-questions" id="section-questions-${idx}">-</span>
                </div>
            `).join('');

            updateCoverageProgress();
        }

        function updateCoverageProgress() {
            const cs = aiGenerationState.coverageState;
            const completed = cs.completedChunks.length;
            const total = cs.chunks.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('coverage-progress-bar').style.width = `${Math.max(percentage, 5)}%`;
            document.getElementById('coverage-progress-text').textContent = `${percentage}%`;
            document.getElementById('coverage-questions-count').textContent = cs.totalQuestions;
        }

        async function processNextChunk() {
            const cs = aiGenerationState.coverageState;

            if (cs.isCancelled || cs.status === 'paused') return;

            if (cs.currentChunk >= cs.chunks.length) {
                coverageComplete();
                return;
            }

            const chunkIndex = cs.currentChunk;
            const sectionItem = document.getElementById(`section-item-${chunkIndex}`);
            if (sectionItem) {
                sectionItem.className = 'section-item active';
                sectionItem.querySelector('.section-status').textContent = 'üîÑ';
            }

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/coverage-chunk.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jobId: cs.jobId,
                        chunkIndex: chunkIndex
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 429) {
                        handleRateLimit(data);
                        return;
                    }
                    throw new Error(data.error || 'Failed to generate questions for section');
                }

                cs.completedChunks.push(chunkIndex);
                cs.totalQuestions += data.questionsGenerated;
                cs.allQuestions = cs.allQuestions.concat(data.questions);

                if (sectionItem) {
                    sectionItem.className = 'section-item completed';
                    sectionItem.querySelector('.section-status').textContent = '‚úÖ';
                    document.getElementById(`section-questions-${chunkIndex}`).textContent = `${data.questionsGenerated} Q`;
                }

                updateCoverageProgress();

                if (data.progress && data.progress.jobComplete) {
                    coverageComplete();
                    return;
                }

                cs.currentChunk++;
                setTimeout(() => processNextChunk(), 6000);

            } catch (err) {
                console.error('Chunk processing error:', err);
                if (sectionItem) {
                    sectionItem.className = 'section-item failed';
                    sectionItem.querySelector('.section-status').textContent = '‚ùå';
                }
                cs.currentChunk++;
                setTimeout(() => processNextChunk(), 2000);
            }
        }

        function handleRateLimit(data) {
            const cs = aiGenerationState.coverageState;
            cs.status = 'rate_limited';

            document.getElementById('coverage-rate-limit-warning').style.display = 'block';
            document.getElementById('coverage-pause-btn').style.display = 'none';

            let seconds = data.retry_after || 360;
            const countdownEl = document.getElementById('rate-limit-countdown');

            const interval = setInterval(() => {
                seconds--;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                if (seconds <= 0) {
                    clearInterval(interval);
                    resumeCoverage();
                }
            }, 1000);

            cs.rateLimitInterval = interval;
        }

        function pauseCoverage() {
            const cs = aiGenerationState.coverageState;
            cs.status = 'paused';
            document.getElementById('coverage-pause-btn').textContent = 'Resume';
            document.getElementById('coverage-pause-btn').onclick = resumeCoverage;
            updateCoverageJobStatus('pause');
        }

        function resumeCoverage() {
            const cs = aiGenerationState.coverageState;
            if (cs.rateLimitInterval) clearInterval(cs.rateLimitInterval);

            cs.status = 'generating';
            document.getElementById('coverage-rate-limit-warning').style.display = 'none';
            document.getElementById('coverage-pause-btn').style.display = 'block';
            document.getElementById('coverage-pause-btn').textContent = 'Pause';
            document.getElementById('coverage-pause-btn').onclick = pauseCoverage;

            processNextChunk();
        }

        async function cancelCoverage() {
            if (!confirm('Are you sure you want to cancel? Generated questions will be lost.')) return;

            const cs = aiGenerationState.coverageState;
            cs.isCancelled = true;
            cs.status = 'cancelled';
            if (cs.rateLimitInterval) clearInterval(cs.rateLimitInterval);

            await updateCoverageJobStatus('cancel');
            resetAIGeneration();
            showToast('Coverage generation cancelled', 'info');
        }

        async function updateCoverageJobStatus(action) {
            try {
                const token = await currentUser.getIdToken();
                await fetch(`${VANDROMEDA_API}/quizmyself/coverage-status.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jobId: aiGenerationState.coverageState.jobId,
                        action: action
                    })
                });
            } catch (err) {
                console.error('Failed to update job status:', err);
            }
        }

        function coverageComplete() {
            const cs = aiGenerationState.coverageState;
            cs.status = 'complete';

            document.getElementById('ai-gen-coverage-progress').style.display = 'none';
            document.getElementById('ai-gen-coverage-complete').style.display = 'block';

            document.getElementById('coverage-final-count').textContent = cs.totalQuestions;
            document.getElementById('coverage-final-sections').textContent = cs.completedChunks.length;

            const container = document.getElementById('coverage-preview-questions');
            const questions = cs.allQuestions.slice(0, 5);
            container.innerHTML = questions.map((q, idx) => `
                <div class="question-preview-card">
                    <div class="question-text">${idx + 1}. ${escapeHtml(q.q)}</div>
                    <div class="choices-preview">
                        ${q.choices.map((c, i) => `
                            <span class="${i === q.correct ? 'correct-choice' : ''}">${i === q.correct ? '‚úì ' : ''}${escapeHtml(c)}</span>
                        `).join(' | ')}
                    </div>
                </div>
            `).join('');

            if (cs.allQuestions.length > 5) {
                container.innerHTML += `<p style="color: #888; text-align: center; padding: 10px;">... and ${cs.allQuestions.length - 5} more questions</p>`;
            }
        }

        async function acceptCoverageQuestions() {
            const cs = aiGenerationState.coverageState;
            const generatedQuestions = cs.allQuestions;

            if (!generatedQuestions || generatedQuestions.length === 0) {
                showToast('No questions to import', 'warning');
                return;
            }

            if (!state.isPro) {
                const currentImported = state.importedQuestionCount || 0;
                const newTotal = currentImported + generatedQuestions.length;
                if (newTotal > FREE_IMPORT_LIMIT) {
                    showToast('Free limit exceeded. Upgrade to Pro for unlimited imports.', 'warning');
                    showUpgradeModal();
                    return;
                }
            }

            const startId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
            generatedQuestions.forEach((q, idx) => {
                q.id = startId + idx;
                q.category = 'AI Generated';
                // Add source reference so "View in Source" button works
                q.sourceId = aiGenerationState.sourceId;
                q.sourceName = aiGenerationState.sourceName;
                questions.push(q);
            });

            state.importedQuestionCount = (state.importedQuestionCount || 0) + generatedQuestions.length;

            updateStats();
            initCategoryFilter();
            saveState();

            showToast(`Imported ${generatedQuestions.length} AI-generated questions!`, 'success');
            closeAIGenerateModal();
            closeSourcesModal();
        }

        async function loadAIUsage() {
            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/usage.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                aiGenerationState.usage = data;
                updateUsageDisplay(data);
            } catch (err) {
                console.error('Failed to load usage:', err);
            }
        }

        function updateUsageDisplay(usage) {
            const gen = usage.generations;
            let text, className = '';

            if (gen.limit === -1) {
                text = 'Unlimited generations';
            } else {
                text = `${gen.remaining} of ${gen.limit} generations (${gen.period})`;
                if (gen.remaining === 0) {
                    className = 'exhausted';
                } else if (gen.remaining <= 1) {
                    className = 'warning';
                }
            }

            const badge = document.getElementById('ai-gen-usage');
            badge.className = 'usage-badge ' + className;
            document.getElementById('ai-gen-usage-text').textContent = text;

            // Also update preview usage
            const previewUsage = document.getElementById('ai-preview-usage');
            if (previewUsage) {
                const ref = usage.refinements;
                if (ref.limit === -1) {
                    previewUsage.textContent = 'Unlimited refinements';
                } else {
                    previewUsage.textContent = `${ref.remaining}/${ref.limit} refinements`;
                }
            }
        }

        async function startAIGeneration() {
            const questionCount = document.getElementById('ai-question-count').value;
            const difficulty = document.getElementById('ai-difficulty').value;
            const focusArea = document.getElementById('ai-focus-area').value;

            // Show loading
            document.getElementById('ai-gen-initial').style.display = 'none';
            document.getElementById('ai-gen-loading').style.display = 'block';

            try {
                // First, get source text (for non-PDF sources)
                const token = await currentUser.getIdToken();

                // Call generate endpoint
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/generate-questions.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourceId: aiGenerationState.sourceId,
                        questionCount: parseInt(questionCount),
                        difficulty: difficulty,
                        focusArea: focusArea || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Generation failed');
                }

                aiGenerationState.questions = data.questions;
                aiGenerationState.usage = data.usage;
                updateUsageDisplay(data.usage);
                plausible('AI Generate', { props: { questions: data.questions.length, difficulty: difficulty } });
                showQuestionPreview();

            } catch (err) {
                console.error('Generation error:', err);
                document.getElementById('ai-gen-loading').style.display = 'none';
                document.getElementById('ai-gen-error').style.display = 'block';
                document.getElementById('ai-gen-error-message').textContent = err.message;
            }
        }

        function showQuestionPreview() {
            document.getElementById('ai-gen-loading').style.display = 'none';
            document.getElementById('ai-gen-preview').style.display = 'block';

            const questions = aiGenerationState.questions;
            document.getElementById('ai-preview-count').textContent = questions.length;

            const container = document.getElementById('ai-preview-questions');
            container.innerHTML = questions.map((q, idx) => `
                <div class="question-preview-card">
                    <div class="question-text">${idx + 1}. ${escapeHtml(q.q)}</div>
                    <div class="choices-preview">
                        ${q.choices.map((c, i) => `
                            <span class="${i === q.correct ? 'correct-choice' : ''}">${i === q.correct ? '‚úì ' : ''}${escapeHtml(c)}</span>
                        `).join(' | ')}
                    </div>
                </div>
            `).join('');
        }

        function openRefinementChat() {
            document.getElementById('ai-gen-preview').style.display = 'none';
            document.getElementById('ai-gen-chat').style.display = 'block';

            // Update chat usage
            const usage = aiGenerationState.usage;
            if (usage) {
                const ref = usage.refinements;
                const chatUsage = document.getElementById('ai-chat-usage');
                if (ref.limit === -1) {
                    chatUsage.textContent = 'Unlimited';
                } else {
                    chatUsage.textContent = `${ref.remaining}/${ref.limit}`;
                    chatUsage.className = 'usage-badge' + (ref.remaining <= 1 ? ' warning' : '');
                }
            }

            // Clear and add initial system message
            const messages = document.getElementById('ai-chat-messages');
            messages.innerHTML = `
                <div class="ai-chat-message system">
                    ${aiGenerationState.questions.length} questions loaded. Tell me how to improve them.
                </div>
            `;
        }

        function backToPreview() {
            document.getElementById('ai-gen-chat').style.display = 'none';
            document.getElementById('ai-gen-preview').style.display = 'block';
            showQuestionPreview();
        }

        async function sendChatRefinement() {
            const input = document.getElementById('ai-chat-input');
            const instruction = input.value.trim();
            if (!instruction) return;

            const sendBtn = document.getElementById('ai-chat-send-btn');
            sendBtn.disabled = true;
            input.value = '';

            // Add user message
            const messages = document.getElementById('ai-chat-messages');
            messages.innerHTML += `<div class="ai-chat-message user">${escapeHtml(instruction)}</div>`;
            messages.scrollTop = messages.scrollHeight;

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/refine-questions.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questions: aiGenerationState.questions,
                        instruction: instruction,
                        sourceId: aiGenerationState.sourceId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Refinement failed');
                }

                aiGenerationState.questions = data.questions;
                aiGenerationState.usage = data.usage;
                updateUsageDisplay(data.usage);

                // Add assistant message
                messages.innerHTML += `
                    <div class="ai-chat-message assistant">
                        ${escapeHtml(data.changes || 'Questions refined.')} (${data.questions.length} questions)
                    </div>
                `;
                messages.scrollTop = messages.scrollHeight;

            } catch (err) {
                messages.innerHTML += `
                    <div class="ai-chat-message error">
                        Error: ${escapeHtml(err.message)}
                    </div>
                `;
            }

            sendBtn.disabled = false;
        }

        async function regenerateQuestions() {
            document.getElementById('ai-gen-preview').style.display = 'none';
            document.getElementById('ai-gen-initial').style.display = 'block';
        }

        async function acceptGeneratedQuestions() {
            const generatedQuestions = aiGenerationState.questions;
            if (!generatedQuestions || generatedQuestions.length === 0) {
                showToast('No questions to import', 'warning');
                return;
            }

            // Check free limit
            if (!state.isPro) {
                const currentImported = state.importedQuestionCount || 0;
                const newTotal = currentImported + generatedQuestions.length;
                if (newTotal > FREE_IMPORT_LIMIT) {
                    showToast(`Free limit exceeded. Upgrade to Pro for unlimited imports.`, 'warning');
                    showUpgradeModal();
                    return;
                }
            }

            // Add to global questions array
            const startId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
            generatedQuestions.forEach((q, idx) => {
                q.id = startId + idx;
                q.category = 'AI Generated';
                // Add source reference so "View in Source" button works
                q.sourceId = aiGenerationState.sourceId;
                q.sourceName = aiGenerationState.sourceName;
                questions.push(q);
            });

            state.importedQuestionCount = (state.importedQuestionCount || 0) + generatedQuestions.length;

            // Update UI
            updateStats();
            initCategoryFilter();
            saveState();

            showToast(`Imported ${aiGenerationState.questions.length} AI-generated questions!`, 'success');
            closeAIGenerateModal();
            closeSourcesModal();
        }

        // View the source location for a question (after wrong answer)
        async function viewQuestionInSource() {
            const q = state.currentQuestion;
            if (!q || !q.sourceId || !q.sourceLocation) {
                showToast('Source location not available', 'warning');
                return;
            }

            // Hide the view source button
            document.getElementById('view-source-btn').classList.remove('visible');

            // Open the sources modal and view the source
            showSourcesModal();
            await viewSourceContent(q.sourceId, q.sourceName || 'Source Material', 'text/plain');

            // After source loads, show a highlight of the relevant excerpt
            setTimeout(() => {
                const excerpt = q.sourceLocation.excerpt;
                if (excerpt) {
                    showToast(`Look for: "${excerpt.substring(0, 50)}..."`, 'info', 5000);
                }
            }, 1000);
        }

        async function linkSourceToQuiz(sourceId, sourceName) {
            // Find quizzes without a linked source
            const unlinkedQuizzes = userKeywords.filter(kw => !kw.source_id);

            if (unlinkedQuizzes.length === 0) {
                showToast('All your quizzes already have sources linked. Create a new quiz first.', 'info');
                return;
            }

            // Close Sources modal first so selection modal is visible
            document.getElementById('sources-modal').classList.add('hidden');

            let selectedKeyword;

            if (unlinkedQuizzes.length === 1) {
                // Only one option - just use it directly
                selectedKeyword = unlinkedQuizzes[0].keyword;
            } else {
                // Multiple options - show selection modal
                const items = unlinkedQuizzes.map(kw => ({
                    value: kw.keyword,
                    title: kw.display_name || kw.keyword,
                    subtitle: kw.display_name ? kw.keyword : null
                }));

                selectedKeyword = await showSelection(
                    'Link Source to Quiz',
                    `Select a quiz to link "${sourceName}" to:`,
                    items,
                    { confirmText: 'Link' }
                );

                if (!selectedKeyword) return;
            }

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/link-source.php`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sourceId, keyword: selectedKeyword })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Failed to link source');
                }

                showToast(`Source linked successfully!`, 'success');
                await loadUserKeywords();
                updateKeywordDropdown();
                updateSourceDependentButtons();

                // Re-open sources modal to show updated state
                showSourcesModal();

            } catch (err) {
                showToast(`Failed to link: ${err.message}`, 'error');
            }
        }

        async function unlinkSourceFromQuiz(keyword) {
            const confirmed = await showConfirm(`Unlink source from quiz "${keyword}"?`, {
                icon: 'üîó',
                confirmText: 'Unlink'
            });
            if (!confirmed) return;

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${VANDROMEDA_API}/quizmyself/link-source.php?keyword=${encodeURIComponent(keyword)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to unlink source');
                }

                showToast('Source unlinked from quiz', 'success');
                loadSources(); // Refresh the list
                await loadUserKeywords(); // Refresh keyword data
                updateKeywordDropdown(); // Refresh dropdown
                updateSourceDependentButtons(); // Update button states

            } catch (err) {
                showToast(`Failed to unlink: ${err.message}`, 'error');
            }
        }

        async function deleteSource(id, name) {
            const confirmed = await showConfirm(`Delete "${name}"? This will also unlink it from any quiz. This cannot be undone.`, {
                icon: 'üóëÔ∏è',
                confirmText: 'Delete',
                danger: true
            });
            if (!confirmed) return;

            try {
                const url = `${VANDROMEDA_API}/quizmyself/source.php?id=${id}`;
                const token = await currentUser.getIdToken();
                const headers = { 'Authorization': `Bearer ${token}` };

                const response = await fetch(url, { method: 'DELETE', headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete source');
                }

                // Reload the list
                loadSources();

            } catch (err) {
                showToast(`Failed to delete: ${err.message}`, 'error');
            }
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Compress content using gzip and return base64
        async function compressContent(content) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(content);
                const cs = new CompressionStream('gzip');
                const writer = cs.writable.getWriter();
                writer.write(data);
                writer.close();
                const compressedData = await new Response(cs.readable).arrayBuffer();
                // Convert to base64
                const bytes = new Uint8Array(compressedData);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            } catch (err) {
                console.warn('Compression failed, storing uncompressed:', err);
                return null;
            }
        }

        // Decompress base64 gzip content
        async function decompressContent(base64Data) {
            try {
                const binary = atob(base64Data);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                const ds = new DecompressionStream('gzip');
                const writer = ds.writable.getWriter();
                writer.write(bytes);
                writer.close();
                const decompressedData = await new Response(ds.readable).arrayBuffer();
                const decoder = new TextDecoder();
                return decoder.decode(decompressedData);
            } catch (err) {
                console.warn('Decompression failed:', err);
                return null;
            }
        }

        // ========== UPGRADE/PAYMENT FUNCTIONALITY ==========

        // Store pending session ID for license lookup
        let pendingLicenseSessionId = null;
        let licensePollingInterval = null;

        function startLicensePolling() {
            // Clear any existing interval
            if (licensePollingInterval) {
                clearInterval(licensePollingInterval);
            }

            // Poll every 3 seconds for up to 60 seconds
            let attempts = 0;
            const maxAttempts = 20;

            licensePollingInterval = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts || !pendingLicenseSessionId) {
                    clearInterval(licensePollingInterval);
                    licensePollingInterval = null;
                    return;
                }

                try {
                    const response = await fetch(`${VANDROMEDA_API}/license/by-session.php?session_id=${encodeURIComponent(pendingLicenseSessionId)}`);
                    const data = await response.json();

                    if (data.status === 'ok' && data.license_key) {
                        // License found - activate Pro and close modal
                        clearInterval(licensePollingInterval);
                        licensePollingInterval = null;

                        state.isPro = true;
                        state.licenseKey = data.license_key;
                        if (data.email) state.email = data.email;

                        updateProUI();
                        updateHamburgerMenu();
                        pendingLicenseSessionId = null;
                        closeUpgradeModal();
                    }
                } catch (e) {
                    console.error('License poll error:', e);
                }
            }, 3000);
        }

        function showUpgradeModal(options = {}) {
            plausible('Upgrade Click');
            document.getElementById('upgrade-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('upgrade-error').style.display = 'none';
            document.getElementById('upgrade-success').style.display = 'none';
            document.getElementById('license-key-input').value = '';

            // Handle license status display (with safety checks for DOM elements)
            const licenseStatusSection = document.getElementById('license-status-section');
            const licensePending = document.getElementById('license-pending');
            const licenseFound = document.getElementById('license-found');
            const licenseDisplay = document.getElementById('license-display');

            // Only try to show license status if the DOM elements exist
            if (licenseStatusSection && licensePending && licenseFound) {
                if (options.pendingSessionId) {
                    // Payment succeeded but license not yet captured
                    pendingLicenseSessionId = options.pendingSessionId;
                    licenseStatusSection.style.display = 'block';
                    licensePending.style.display = 'block';
                    licenseFound.style.display = 'none';
                    // Auto-poll for license every 3 seconds
                    startLicensePolling();
                } else if (options.licenseKey) {
                    // License was found - display it
                    pendingLicenseSessionId = null;
                    licenseStatusSection.style.display = 'block';
                    licensePending.style.display = 'none';
                    licenseFound.style.display = 'block';
                    if (licenseDisplay) {
                        licenseDisplay.textContent = options.licenseKey;
                    }
                } else {
                    // Normal modal open - hide license status
                    licenseStatusSection.style.display = 'none';
                    licensePending.style.display = 'none';
                    licenseFound.style.display = 'none';
                }
            } else if (options.licenseKey) {
                // Fallback: show toast with license key if DOM elements don't exist
                showToast('Pro activated! Your license key: ' + options.licenseKey, 'success', 8000);
            }

            // Show login required message if not signed in with Firebase
            const loginRequired = document.getElementById('upgrade-login-required');
            const upgradeContent = document.getElementById('upgrade-content');
            if (currentUser) {
                loginRequired.style.display = 'none';
                upgradeContent.style.display = 'block';
            } else {
                loginRequired.style.display = 'block';
                upgradeContent.style.display = 'none';
            }
        }

        function closeUpgradeModal() {
            document.getElementById('upgrade-modal').classList.add('hidden');
            document.body.style.overflow = '';
            // Stop license polling if active
            if (licensePollingInterval) {
                clearInterval(licensePollingInterval);
                licensePollingInterval = null;
            }
        }

        function closeUpgradeModalOnOverlay(event) {
            if (event.target === document.getElementById('upgrade-modal')) {
                closeUpgradeModal();
            }
        }

        async function checkForLicense() {
            if (!pendingLicenseSessionId) {
                showUpgradeError('No pending license to check.');
                return;
            }

            const btn = document.getElementById('check-license-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Checking...';
            btn.disabled = true;

            try {
                const response = await fetch(`${VANDROMEDA_API}/license/by-session.php?session_id=${encodeURIComponent(pendingLicenseSessionId)}`);
                const data = await response.json();

                if (data.status === 'ok' && data.license_key) {
                    // License found!
                    state.isPro = true;
                    state.licenseKey = data.license_key;
                    if (data.email) {
                        state.email = data.email;
                    }

                    // For keyword-only users, store in localStorage
                    if (!currentUser && currentKeyword) {
                        localStorage.setItem(`quizmyself_license_${currentKeyword}`, data.license_key);
                        if (data.email) {
                            localStorage.setItem(`quizmyself_email_${currentKeyword}`, data.email);
                        }
                    }

                    updateProUI();
                    updateHamburgerMenu();
                    pendingLicenseSessionId = null;

                    // Auto-close modal after brief delay - user is now Pro
                    setTimeout(() => closeUpgradeModal(), 500);
                } else if (data.status === 'pending') {
                    showUpgradeError('License still processing. Please wait a moment and try again, or check your email.');
                } else {
                    showUpgradeError('Could not find license. Please check your email for the license key.');
                }
            } catch (error) {
                console.error('License check error:', error);
                showUpgradeError('Network error. Please try again.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function copyLicenseKey() {
            const licenseKey = document.getElementById('license-display').textContent;
            if (licenseKey) {
                navigator.clipboard.writeText(licenseKey).then(() => {
                    showToast('License key copied to clipboard!', 'success');
                }).catch(() => {
                    // Fallback: select text for manual copy
                    showToast('Please copy manually: ' + licenseKey, 'info', 8000);
                });
            }
        }

        function showProFeaturesModal() {
            document.getElementById('pro-features-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            document.getElementById('pro-license-display').textContent = state.licenseKey || '-';
        }

        function closeProFeaturesModal() {
            document.getElementById('pro-features-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function startCheckout(plan) {
            // Use logged-in user's email (user must be signed in to upgrade)
            const email = currentUser?.email;
            if (!email) {
                showUpgradeError('Please sign in to subscribe.');
                return;
            }

            // Redirect to checkout page (same pattern as Transit Route Planner)
            const checkoutUrl = `https://www.vandromeda.com/checkout/quizmyself/?plan=${plan}&email=${encodeURIComponent(email)}`;
            window.location.href = checkoutUrl;
        }

        async function activateLicense() {
            const licenseKey = document.getElementById('license-key-input').value.trim();
            if (!licenseKey) {
                showUpgradeError('Please enter a license key.');
                return;
            }

            try {
                const response = await fetch(`${VANDROMEDA_API}/license/validate.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        license_key: licenseKey,
                        domain: window.location.hostname || 'localhost'
                    })
                });

                const data = await response.json();

                if (data.valid) {
                    // License is valid - activate Pro
                    state.isPro = true;
                    state.licenseKey = licenseKey;
                    if (data.email) {
                        state.email = data.email;
                    }
                    // Store license per-keyword
                    if (currentKeyword) {
                        localStorage.setItem(`quizmyself_license_${currentKeyword}`, licenseKey);
                        if (data.email) {
                            localStorage.setItem(`quizmyself_email_${currentKeyword}`, data.email);
                        }
                    }
                    updateProUI();
                    updateHamburgerMenu();
                    showUpgradeSuccess('License activated! Welcome to Pro!');
                    setTimeout(() => closeUpgradeModal(), 2000);
                } else {
                    showUpgradeError(data.reason || 'Invalid license key.');
                }
            } catch (error) {
                console.error('License validation error:', error);
                showUpgradeError('Network error. Please try again.');
            }
        }

        async function fetchLicenseFromSession(sessionId) {
            // Try to fetch license created by webhook
            let attempts = 0;
            const maxAttempts = 5;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${VANDROMEDA_API}/license/by-session.php?session_id=${encodeURIComponent(sessionId)}`);
                    const data = await response.json();

                    if (data.status === 'ok' && data.license_key) {
                        // License found - set state immediately
                        state.isPro = true;
                        state.licenseKey = data.license_key;
                        if (data.email) {
                            state.email = data.email;
                        }

                        // For keyword-only users, store in localStorage
                        if (!currentUser && currentKeyword) {
                            localStorage.setItem(`quizmyself_license_${currentKeyword}`, data.license_key);
                            if (data.email) {
                                localStorage.setItem(`quizmyself_email_${currentKeyword}`, data.email);
                            }
                        }

                        updateProUI();
                        updateHamburgerMenu();
                        // Close modal if open - user is now Pro
                        closeUpgradeModal();
                        return true; // Success - license captured
                    } else if (data.status === 'pending') {
                        // Webhook hasn't processed yet - wait and retry
                        attempts++;
                        await new Promise(r => setTimeout(r, 2000));
                        continue;
                    } else {
                        break;
                    }
                } catch (error) {
                    console.error('License fetch error:', error);
                    break;
                }
            }

            // Fallback - show modal with pending status
            showUpgradeModal({ pendingSessionId: sessionId });
            return false; // Failed to capture license
        }

        async function checkProStatus() {
            // For Firebase users, license is tied to account (handled by checkProStatusForAccount)
            // Don't override account-based pro status
            if (currentUser) {
                updateProUI();
                updateHamburgerMenu();
                return;
            }

            // Reset pro status for keyword-only users
            state.isPro = false;
            state.licenseKey = null;
            state.email = null;

            // Need keyword to check per-user license
            if (!currentKeyword) {
                updateProUI();
                updateHamburgerMenu();
                return;
            }

            // Check for stored email (per-keyword)
            const storedEmail = localStorage.getItem(`quizmyself_email_${currentKeyword}`);
            if (storedEmail) {
                state.email = storedEmail;
            }

            // Check for stored license (per-keyword)
            const storedLicense = localStorage.getItem(`quizmyself_license_${currentKeyword}`);
            if (storedLicense) {
                try {
                    const response = await fetch(`${VANDROMEDA_API}/license/validate.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            license_key: storedLicense,
                            domain: window.location.hostname || 'localhost'
                        })
                    });

                    const data = await response.json();

                    if (data.valid) {
                        state.isPro = true;
                        state.licenseKey = storedLicense;
                        if (data.email) {
                            state.email = data.email;
                            localStorage.setItem(`quizmyself_email_${currentKeyword}`, data.email);
                        }
                    } else {
                        // License expired or invalid - remove it
                        localStorage.removeItem(`quizmyself_license_${currentKeyword}`);
                        localStorage.removeItem(`quizmyself_email_${currentKeyword}`);
                        state.isPro = false;
                        state.licenseKey = null;
                        state.email = null;
                    }
                } catch (error) {
                    console.error('Pro status check failed:', error);
                    // On network error, trust the stored license temporarily
                    state.isPro = true;
                    state.licenseKey = storedLicense;
                }
            }

            // Note: Payment success handling is done in onAuthStateChanged to ensure
            // we know the auth state before processing (Firebase user vs keyword-only)

            updateProUI();
            updateHamburgerMenu();
        }

        function updateProUI() {
            const topBarStatus = document.getElementById('top-bar-status');
            const topBarText = document.getElementById('top-bar-status-text');

            if (state.isPro) {
                topBarStatus.classList.remove('free');
                topBarStatus.classList.add('pro');
                topBarStatus.onclick = showProFeaturesModal;
                topBarStatus.style.cursor = 'pointer';
                topBarText.innerHTML = 'Pro Member <span class="pro-badge">PRO</span>';
            } else {
                topBarStatus.classList.remove('pro');
                topBarStatus.classList.add('free');
                topBarStatus.onclick = toggleHamburgerMenu;
                topBarStatus.style.cursor = 'pointer';
                topBarText.textContent = 'Free Account';
            }
        }

        function showUpgradeError(message) {
            const errorEl = document.getElementById('upgrade-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('upgrade-success').style.display = 'none';
        }

        function showUpgradeSuccess(message) {
            const successEl = document.getElementById('upgrade-success');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('upgrade-error').style.display = 'none';
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeStudyMaterial();
                closeImportModal();
                closeUpgradeModal();
            }
        });

        // Welcome screen functions
        let welcomeSelectedCategories = new Set();

        function shouldShowWelcome() {
            // Don't show if user has seen welcome before
            if (localStorage.getItem('quizmyself_welcome_seen')) return false;
            // Don't show if user already has a keyword/session
            if (localStorage.getItem('quizmyself_keyword')) return false;
            // Don't show if returning from Stripe checkout
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('session_id') || urlParams.has('canceled')) return false;
            return true;
        }

        function showWelcome() {
            const welcomeScreen = document.getElementById('welcome-screen');
            welcomeScreen.classList.remove('hidden');
            populateWelcomeCategories();
        }

        function populateWelcomeCategories() {
            const container = document.getElementById('welcome-categories');
            const categories = [...new Set(demoQuestions.map(q => q.category))];

            container.innerHTML = categories.map(cat =>
                `<button class="welcome-category-chip selected" data-action="toggle-welcome-category" data-category="${escapeAttr(cat)}">${escapeHtml(cat)}</button>`
            ).join('');

            // Start with all selected
            welcomeSelectedCategories = new Set(categories);
        }

        function toggleWelcomeCategory(btn, category) {
            if (btn) btn.classList.toggle('selected');
            if (welcomeSelectedCategories.has(category)) {
                welcomeSelectedCategories.delete(category);
            } else {
                welcomeSelectedCategories.add(category);
            }
        }

        function startWelcomeQuiz() {
            // If no categories selected, select all
            if (welcomeSelectedCategories.size === 0) {
                const categories = [...new Set(demoQuestions.map(q => q.category))];
                welcomeSelectedCategories = new Set(categories);
            }

            // Mark welcome as seen
            localStorage.setItem('quizmyself_welcome_seen', 'true');

            // Hide welcome screen
            document.getElementById('welcome-screen').classList.add('hidden');

            // Apply selected categories to the main category filter
            selectedCategories = new Set(welcomeSelectedCategories);
            renderCategoryChips();
            updateStats();

            // Start practice quiz
            startPractice();
        }

        function dismissWelcome() {
            localStorage.setItem('quizmyself_welcome_seen', 'true');
            document.getElementById('welcome-screen').classList.add('hidden');
        }

        // Initialize
        (async function() {
            // Check if we should show welcome screen
            if (shouldShowWelcome()) {
                showWelcome();
            }

            const savedKeyword = localStorage.getItem('quizmyself_keyword');
            if (savedKeyword) {
                currentKeyword = savedKeyword;
                document.getElementById('stats-bar').style.display = 'flex';
                await loadState();
                await checkProStatus();
            } else {
                document.getElementById('stats-bar').style.display = 'none';
            }
            updateHamburgerMenu();
            updateStats();
        })();
        // Deployment status check disabled - GitHub API rate limits cause 403 errors
        // TODO: Re-enable with GitHub token or alternative approach (issue #112)
        // checkDeploymentStatus();

        async function checkDeploymentStatus() {
            // Disabled due to GitHub API rate limits (60 req/hr unauthenticated)
            // To re-enable, add a GitHub token or use a different approach
            return;
        }

        function showDeployBanner(message) {
            const banner = document.getElementById('deploy-banner');
            banner.textContent = message;
            banner.classList.remove('hidden');
            document.body.classList.add('has-banner');
        }
    </script>
</body>
</html>
